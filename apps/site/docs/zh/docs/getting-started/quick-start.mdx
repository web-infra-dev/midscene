# å¿«é€Ÿå¼€å§‹

import { PackageManagerTabs } from '@theme';

æˆ‘ä»¬ç”¨è¿™ä¸ªéœ€æ±‚æ¥ä¸¾ä¾‹ï¼šä½¿ç”¨ OpenAI GPT-4o åœ¨ eBay ä¸Šæœç´¢ "è€³æœº"ï¼Œå¹¶ä»¥ JSON æ ¼å¼è¿”å›å•†å“å’Œä»·æ ¼ç»“æœã€‚

åœ¨è¿è¡Œè¯¥ç¤ºä¾‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç»å‡†å¤‡äº†èƒ½å¤Ÿè°ƒç”¨ OpenAI GPT-4o æ¨¡å‹çš„ API keyã€‚

> [Puppeteer](https://pptr.dev/) æ˜¯ä¸€ä¸ª Node.js åº“ï¼Œå®ƒé€šè¿‡ DevTools Protocol æˆ– WebDriver BiDi æä¾›äº†ç”¨äºæ§åˆ¶ Chrome æˆ– Firefox çš„é«˜çº§ APIã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPuppeteer è¿è¡Œåœ¨æ— å¤´æ¨¡å¼ï¼ˆheadless mode, å³æ²¡æœ‰å¯è§çš„ UIï¼‰ï¼Œä½†ä¹Ÿå¯ä»¥é…ç½®ä¸ºåœ¨æœ‰å¤´æ¨¡å¼ï¼ˆheaded mode, å³æœ‰å¯è§çš„æµè§ˆå™¨ç•Œé¢ï¼‰ä¸‹è¿è¡Œã€‚

## å‡†å¤‡å·¥ä½œ

é…ç½® OpenAI API Keyï¼Œæˆ– [è‡ªå®šä¹‰æ¨¡å‹æœåŠ¡](../usage//model-vendor.html)

```bash
# æ›´æ–°ä¸ºä½ è‡ªå·±çš„ Key
export OPENAI_API_KEY="sk-abcdefghijklmnopqrstuvwxyz"
```

## ä½¿ç”¨å‘½ä»¤è¡Œç‰ˆæœ¬ä½“éªŒ

ä½ å¯ä»¥å¿«é€Ÿä½¿ç”¨å‘½ä»¤è¡Œç‰ˆæœ¬çš„ Midscene æ¥ä½“éªŒå®ƒçš„åŸºç¡€èƒ½åŠ›ã€‚

è¯·ç¡®ä¿ä½ å·²å®‰è£… [Node.js](https://nodejs.org/)ã€‚

```bash
# headless mode to visit bing.com and search for 'weather today'
npx @midscene/cli --url https://wwww.bing.com --action "type 'weather today', hit enter"

# headed mode (i.e. visible browser) to visit bing.com and search for 'weather today'
npx @midscene/cli --headed --url https://wwww.bing.com --action "type 'weather today', hit enter"

# visit github status page and save the status to ./status.json
npx @midscene/cli \
  --url https://www.githubstatus.com/ \
  --query-output status.json \
  --query '{name: string, status: string}[], service status of github page'
```

å¦‚æœä½ æƒ³æ›´æ·±å…¥åœ°äº†è§£ Midsceneï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ SDK ç‰ˆæœ¬ï¼Œå¹¶å°†å…¶ä¸ Playwright æˆ– Puppeteer é›†æˆã€‚

### æŸ¥çœ‹è¿è¡ŒæŠ¥å‘Š

è¿è¡Œ Midscene ä¹‹åï¼Œç³»ç»Ÿä¼šç”Ÿæˆä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œé»˜è®¤å­˜æ”¾åœ¨ `./midscene_run/report/latest.web-dump.json`ã€‚ç„¶åï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªæ–‡ä»¶å¯¼å…¥ [å¯è§†åŒ–å·¥å…·](/visualization/)ï¼Œè¿™æ ·ä½ å°±èƒ½æ›´æ¸…æ¥šåœ°äº†è§£æ•´ä¸ªè¿‡ç¨‹ã€‚

## é›†æˆåˆ° Playwright

> [Playwright.js](https://playwright.com/) æ˜¯ç”±å¾®è½¯å¼€å‘çš„ä¸€ä¸ªå¼€æºè‡ªåŠ¨åŒ–åº“ï¼Œä¸»è¦ç”¨äºå¯¹ç½‘ç»œåº”ç”¨ç¨‹åºè¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆend-to-end testï¼‰å’Œç½‘é¡µæŠ“å–ã€‚

è¿™é‡Œæˆ‘ä»¬å‡è®¾ä½ å·²ç»æ‹¥æœ‰ä¸€ä¸ªé›†æˆäº† Playwright çš„ä»“åº“ã€‚

### æ–°å¢ä¾èµ– 

<PackageManagerTabs command="install @midscene/web --save-dev" />

### ç¬¬ä¸€æ­¥ï¼šæ›´æ–° playwright.config.ts

```diff
export default defineConfig({
  testDir: './e2e',
+ timeout: 90 * 1000,
+ reporter: [["list"], ["@midscene/web/playwright-report"]],
});
```

### ç¬¬äºŒæ­¥ï¼šæ‰©å±• `test` å®ä¾‹

æŠŠä¸‹æ–¹ä»£ç ä¿å­˜ä¸º `./fixture.ts`;

```typescript
import { test as base } from '@playwright/test';
import type { PlayWrightAiFixtureType } from '@midscene/web';
import { PlaywrightAiFixture } from '@midscene/web';

export const test = base.extend<PlayWrightAiFixtureType>(PlaywrightAiFixture());
```

### ç¬¬ä¸‰æ­¥ï¼šç¼–å†™æµ‹è¯•ç”¨ä¾‹

ç¼–å†™ä¸‹æ–¹ä»£ç ï¼Œä¿å­˜ä¸º `./e2e/ebay-search.spec.ts`

```typescript title="./e2e/ebay-search.spec.ts"
import { expect } from "@playwright/test";
import { test } from "./fixture";

test.beforeEach(async ({ page }) => {
  page.setViewportSize({ width: 400, height: 905 });
  await page.goto("https://www.ebay.com");
  await page.waitForLoadState("networkidle");
});

test("search headphone on ebay", async ({ ai, aiQuery, aiAssert }) => {
  // ğŸ‘€ è¾“å…¥å…³é”®å­—ï¼Œæ‰§è¡Œæœç´¢
  // æ³¨ï¼šå°½ç®¡è¿™æ˜¯ä¸€ä¸ªè‹±æ–‡é¡µé¢ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ä¸­æ–‡æŒ‡ä»¤æ§åˆ¶å®ƒ
  await ai('åœ¨æœç´¢æ¡†è¾“å…¥ "Headphones" ï¼Œæ•²å›è½¦');

  // ğŸ‘€ æ‰¾åˆ°åˆ—è¡¨é‡Œè€³æœºç›¸å…³çš„ä¿¡æ¯
  const items = await aiQuery(
    '{itemTitle: string, price: Number}[], æ‰¾åˆ°åˆ—è¡¨é‡Œçš„å•†å“æ ‡é¢˜å’Œä»·æ ¼'
  );

  console.log("headphones in stock", items);
  expect(items?.length).toBeGreaterThan(0);

  // ğŸ‘€ ç”¨ AI æ–­è¨€
  await aiAssert("ç•Œé¢å·¦ä¾§æœ‰ç±»ç›®ç­›é€‰åŠŸèƒ½");
});

```

### Step 4. è¿è¡Œæµ‹è¯•ç”¨ä¾‹

```bash
npx playwright test ./e2e/ebay-search.spec.ts
```

### Step 5. æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: xxx/midscene_run/report/xxx.html` é€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚


## é›†æˆåˆ° Puppeteer

> [Puppeteer](https://pptr.dev/) æ˜¯ä¸€ä¸ª Node.js åº“ï¼Œå®ƒé€šè¿‡ DevTools åè®®æˆ– WebDriver BiDi æä¾›æ§åˆ¶ Chrome æˆ– Firefox çš„é«˜çº§ APIã€‚Puppeteer é»˜è®¤åœ¨æ— ç•Œé¢æ¨¡å¼ï¼ˆheadlessï¼‰ä¸‹è¿è¡Œï¼Œä½†å¯ä»¥é…ç½®ä¸ºåœ¨å¯è§çš„æµè§ˆå™¨æ¨¡å¼ï¼ˆheadedï¼‰ä¸­è¿è¡Œã€‚

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
npm install @midscene/web --save-dev
npm install puppeteer ts-node --save-dev 
```

### ç¬¬äºŒæ­¥ï¼šç¼–å†™è„šæœ¬

ç¼–å†™ä¸‹æ–¹ä»£ç ï¼Œä¿å­˜ä¸º `./demo.ts`

```typescript title="./demo.ts"
import puppeteer from "puppeteer";
import { PuppeteerAgent } from "@midscene/web";

const sleep = (ms: number) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    const browser = await puppeteer.launch({
      headless: false, // here we use headed mode to help debug
    });

    const page = await browser.newPage();
    await page.setViewport({
      width: 1280,
      height: 800,
      deviceScaleFactor: 1,
    });

    await page.goto("https://www.ebay.com");
    await sleep(5000);

    // ğŸ‘€ åˆå§‹åŒ– Midscene agent 
    const mid = new PuppeteerAgent(page);

    // ğŸ‘€ æ‰§è¡Œæœç´¢
    // æ³¨ï¼šå°½ç®¡è¿™æ˜¯ä¸€ä¸ªè‹±æ–‡é¡µé¢ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ä¸­æ–‡æŒ‡ä»¤æ§åˆ¶å®ƒ
    await mid.aiAction('åœ¨æœç´¢æ¡†è¾“å…¥ "Headphones" ï¼Œæ•²å›è½¦');
    await sleep(5000);

    // ğŸ‘€ ç†è§£é¡µé¢ï¼Œæå–æ•°æ®
    const items = await mid.aiQuery(
      '{itemTitle: string, price: Number}[], æ‰¾åˆ°åˆ—è¡¨é‡Œçš„å•†å“æ ‡é¢˜å’Œä»·æ ¼',
    );
    console.log("è€³æœºå•†å“ä¿¡æ¯", items);

    // ğŸ‘€ ç”¨ AI æ–­è¨€
    await mid.aiAssert("ç•Œé¢å·¦ä¾§æœ‰ç±»ç›®ç­›é€‰åŠŸèƒ½");

    await browser.close();
  })()
);
```

:::tip

ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œä¸Šè¿°æ–‡ä»¶ä¸­çš„å…³é”®ä»£ç åªæœ‰ä¸‰è¡Œï¼Œä¸”éƒ½æ˜¯ç”¨è‡ªç„¶è¯­è¨€ç¼–å†™çš„

```typescript
await mid.aiAction('åœ¨æœç´¢æ¡†è¾“å…¥ "Headphones" ï¼Œæ•²å›è½¦');
await mid.aiQuery(
  '{itemTitle: string, price: Number}[], æ‰¾åˆ°åˆ—è¡¨é‡Œçš„å•†å“æ ‡é¢˜å’Œä»·æ ¼',
);
await mid.aiAssert("ç•Œé¢å·¦ä¾§æœ‰ç±»ç›®ç­›é€‰åŠŸèƒ½");
```
:::

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ

ä½¿ç”¨ `ts-node` æ¥è¿è¡Œï¼Œä½ ä¼šçœ‹åˆ°å‘½ä»¤è¡Œæ‰“å°å‡ºäº†è€³æœºçš„å•†å“ä¿¡æ¯ï¼š

```bash
# run
npx ts-node demo.ts

# å‘½ä»¤è¡Œåº”è¯¥æœ‰å¦‚ä¸‹è¾“å‡º
#  [
#   {
#     itemTitle: 'JBL Tour Pro 2 - True wireless Noise Cancelling earbuds with Smart Charging Case',
#     price: 551.21
#   },
#   {
#     itemTitle: 'Soundcore Space Oneæ— çº¿è€³æœº40H ANCæ’­æ”¾æ—¶é—´2XStrongerè¯­éŸ³è¿˜åŸ',
#     price: 543.94
#   }
# ]
```

### ç¬¬å››æ­¥ï¼šæŸ¥çœ‹è¿è¡ŒæŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: xxx/midscene_run/report/xxx.html` é€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚

ä¹Ÿå¯ä»¥å°† `./midscene_run/report/latest.web-dump.json` æ–‡ä»¶å¯¼å…¥ [å¯è§†åŒ–å·¥å…·](/visualization/) æŸ¥çœ‹ã€‚


## è®¿é—®ç¤ºä¾‹æŠ¥å‘Š

åœ¨ [å¯è§†åŒ–å·¥å…·](/visualization/) ä¸­ï¼Œç‚¹å‡» `Load Demo` æŒ‰é’®ï¼Œä½ å°†èƒ½å¤Ÿçœ‹åˆ°ä¸Šæ–¹ä»£ç çš„è¿è¡Œç»“æœä»¥åŠå…¶ä»–çš„ä¸€äº›ç¤ºä¾‹ã€‚

![](/view-demo-visualization.gif)


## æŸ¥çœ‹ç¤ºä¾‹æŠ¥å‘Š

åœ¨[å¯è§†åŒ–å·¥å…·](/visualization/)ä¸­ç‚¹å‡»"åŠ è½½æ¼”ç¤º"æŒ‰é’®ï¼Œä½ å°†èƒ½å¤Ÿçœ‹åˆ°ä¹‹å‰ä»£ç çš„è¿è¡Œç»“æœä»¥åŠå…¶ä»–ä¸€äº›ç¤ºä¾‹ã€‚

![](/view-demo-visualization.gif)

