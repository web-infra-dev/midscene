import StartExperience from './common/start-experience.mdx';
import SetupEnv from './common/setup-env.mdx';
import PrepareIOS from './common/prepare-ios.mdx';

import { PackageManagerTabs } from '@theme';

# iOS å¼€å§‹ä½¿ç”¨

æœ¬æŒ‡å—ä¼šå¸¦ä½ å®Œæˆä½¿ç”¨ Midscene æ§åˆ¶ iOS è®¾å¤‡çš„å…¨éƒ¨æ­¥éª¤ï¼šé€šè¿‡ WebDriverAgent è¿æ¥çœŸæœºã€é…ç½®æ¨¡å‹ API Keyã€ä½“éªŒé›¶ä»£ç  Playgroundï¼Œå¹¶è¿è¡Œä½ çš„é¦–ä¸ª JavaScript è„šæœ¬ã€‚

:::info ç¤ºä¾‹é¡¹ç›®

ä½¿ç”¨ JavaScript æ§åˆ¶ iOS è®¾å¤‡ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo](https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo)

é›†æˆ Vitest è¿›è¡Œæµ‹è¯•ï¼š[https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo](https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo)

:::

<SetupEnv />

## å‡†å¤‡å·¥ä½œ

ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿ WebDriverAgent å¯ä»¥ä¸è®¾å¤‡é€šä¿¡ã€‚

<PrepareIOS />

## è¯•ç”¨ Playgroundï¼ˆé›¶ä»£ç ï¼‰

Playground æ˜¯éªŒè¯è¿æ¥ã€è§‚å¯Ÿ AI é©±åŠ¨æ­¥éª¤çš„æœ€å¿«æ–¹å¼ï¼Œæ— éœ€ç¼–å†™ä»£ç ã€‚å®ƒä¸ `@midscene/ios` å…±äº«ç›¸åŒçš„æ ¸å¿ƒï¼Œå› æ­¤åœ¨ Playground ä¸­é€šè¿‡çš„æµç¨‹ï¼Œåœ¨è„šæœ¬ä¸­è¿è¡Œä¼šä¿æŒä¸€è‡´ã€‚

<video src="https://lf3-static.bytednsdoc.com/obj/eden-cn/nupipfups/Midscene/1.0-showcases/x2.mp4" controls/>

1. å¯åŠ¨ Playground CLIï¼š

```bash
npx --yes @midscene/ios-playground
```

2. ç‚¹å‡»çª—å£ä¸­çš„é½¿è½®æŒ‰é’®è¿›å…¥é…ç½®é¡µï¼Œç²˜è´´ä½ çš„ API Key é…ç½®ã€‚å¦‚æœè¿˜æ²¡æœ‰ API Keyï¼Œè¯·å›åˆ° [æ¨¡å‹é…ç½®](./model-config) è·å–ã€‚

![](/ios-set-env.png)

## å¼€å§‹ä½“éªŒ

<StartExperience />

## é›†æˆ Midscene Agent

å½“ Playground å·¥ä½œæ­£å¸¸åï¼Œå°±å¯ä»¥åˆ‡æ¢åˆ°å¯å¤ç”¨çš„ JavaScript è„šæœ¬ã€‚

### ç¬¬ 1 æ­¥ï¼šå®‰è£…ä¾èµ–

<PackageManagerTabs command="install @midscene/ios --save-dev" />

### ç¬¬ 2 æ­¥ï¼šç¼–å†™è„šæœ¬

ä¸‹é¢çš„ç¤ºä¾‹ä¼šåœ¨è®¾å¤‡ä¸Šæ‰“å¼€ Safariï¼Œæœç´¢ eBayï¼Œå¹¶æ–­è¨€ç»“æœåˆ—è¡¨ã€‚

```typescript title="./demo.ts"
import {
  IOSAgent,
  IOSDevice,
  agentFromWebDriverAgent,
} from '@midscene/ios';

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    // æ–¹å¼ä¸€ï¼šç›´æ¥åˆ›å»ºè®¾å¤‡å’Œ Agent
    const page = new IOSDevice({
      wdaPort: 8100,
      wdaHost: 'localhost',
    });

    // ğŸ‘€ åˆå§‹åŒ– Midscene Agent
    const agent = new IOSAgent(page, {
      aiActionContext:
        'If any location, permission, user agreement, etc. popup appears, click agree. If login page appears, close it.',
    });
    await page.connect();

    // æ–¹å¼äºŒï¼šä½¿ç”¨ä¾¿æ·å‡½æ•°ï¼ˆæ¨èï¼‰
    // const agent = await agentFromWebDriverAgent({
    //   wdaPort: 8100,
    //   wdaHost: 'localhost',
    //   aiActionContext: 'If any location, permission, user agreement, etc. popup appears, click agree. If login page appears, close it.',
    // });

    // ğŸ‘€ ç›´æ¥æ‰“å¼€ ebay.comï¼ˆæ¨èåšæ³•ï¼‰
    await page.launch('https://ebay.com');
    await sleep(3000);

    // ğŸ‘€ è¾“å…¥å…³é”®å­—å¹¶æ‰§è¡Œæœç´¢
    await agent.aiAct('Search for "Headphones"');

    // ğŸ‘€ ç­‰å¾…åŠ è½½å®Œæˆ
    await agent.aiWaitFor('At least one headphone product is displayed on the page');
    // æˆ–ç®€å•åœ°ç­‰å¾…å‡ ç§’ï¼š
    // await sleep(5000);

    // ğŸ‘€ ç†è§£é¡µé¢å†…å®¹å¹¶æå–æ•°æ®
    const items = await agent.aiQuery(
      '{itemTitle: string, price: Number}[], find product titles and prices in the list',
    );
    console.log('Headphone product information', items);

    // ğŸ‘€ ä½¿ç”¨ AI æ–­è¨€
    await agent.aiAssert('Multiple headphone products are displayed on the interface');

    await page.destroy();
  })(),
);
```

### ç¬¬ 3 æ­¥ï¼šè¿è¡Œç¤ºä¾‹

```bash
npx tsx demo.ts
```

### ç¬¬ 4 æ­¥ï¼šæŸ¥çœ‹æŠ¥å‘Š

è„šæœ¬æˆåŠŸåä¼šè¾“å‡º `Midscene - report file updated: /path/to/report/some_id.html`ã€‚åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å¯¹åº” HTML æ–‡ä»¶å³å¯å›æ”¾æ¯ä¸€æ­¥äº¤äº’ã€æŸ¥è¯¢ä¸æ–­è¨€ã€‚

## API å‚è€ƒä¸æ›´å¤šèµ„æº

éœ€è¦æŸ¥çœ‹æ„é€ å‡½æ•°ã€è¾…åŠ©æ–¹æ³•æˆ–å¹³å°ä¸“å±è®¾å¤‡ APIï¼Ÿè¯·ç§»æ­¥ [iOS API å‚è€ƒ](./ios-api-reference) è·å–è¯¦ç»†å‚æ•°åŠè‡ªå®šä¹‰æ“ä½œç­‰é«˜çº§ä¸»é¢˜ã€‚è‹¥æƒ³äº†è§£è·¨å¹³å°å…±ç”¨çš„ APIï¼Œå¯é˜…è¯» [é€šç”¨ API å‚è€ƒ](./api)ã€‚

## å¸¸è§é—®é¢˜

### ä¸ºä»€ä¹ˆ WebDriverAgent å·²è¿æ¥ï¼Œä½†ä»æ— æ³•æ§åˆ¶è®¾å¤‡ï¼Ÿ

è¯·æ£€æŸ¥ä»¥ä¸‹äº‹é¡¹ï¼š

1. **å¼€å‘è€…æ¨¡å¼**ï¼šåœ¨â€œè®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > å¼€å‘è€…æ¨¡å¼â€ä¸­ç¡®è®¤å·²å¼€å¯ã€‚
2. **UI Automation**ï¼šåœ¨â€œè®¾ç½® > å¼€å‘è€… > UI Automationâ€ä¸­ç¡®è®¤å·²å¼€å¯ã€‚
3. **è®¾å¤‡ä¿¡ä»»**ï¼šç¡®ä¿è®¾å¤‡ä¿¡ä»»å½“å‰ Macã€‚

### æ¨¡æ‹Ÿå™¨ä¸çœŸæœºæœ‰å“ªäº›åŒºåˆ«ï¼Ÿ

| ç‰¹æ€§ | çœŸæœº | æ¨¡æ‹Ÿå™¨ |
|------|------|--------|
| ç«¯å£è½¬å‘ | éœ€è¦ iproxy | ä¸éœ€è¦ |
| å¼€å‘è€…æ¨¡å¼ | å¿…é¡»æ‰‹åŠ¨å¼€å¯ | é»˜è®¤å¼€å¯ |
| UI Automation è®¾ç½® | éœ€æ‰‹åŠ¨å¼€å¯ | é»˜è®¤å¼€å¯ |
| æ€§èƒ½ | çœŸå®è®¾å¤‡æ€§èƒ½ | å–å†³äº Mac æ€§èƒ½ |
| ä¼ æ„Ÿå™¨ | çœŸå®ç¡¬ä»¶ | æ¨¡æ‹Ÿæ•°æ® |

### å¦‚ä½•è‡ªå®šä¹‰ WebDriverAgent çš„ç«¯å£å’Œ Hostï¼Ÿ

å¯ä»¥é€šè¿‡ `IOSDevice` æ„é€ å‡½æ•°æˆ– `agentFromWebDriverAgent` æ¥æŒ‡å®šç«¯å£å’Œ Hostï¼š

```typescript
// æ–¹å¼ä¸€ï¼šä½¿ç”¨ IOSDevice
const device = new IOSDevice({
  wdaPort: 8100,        // è‡ªå®šä¹‰ç«¯å£
  wdaHost: '192.168.1.100', // è‡ªå®šä¹‰ä¸»æœº
});

// æ–¹å¼äºŒï¼šä½¿ç”¨ä¾¿æ·å‡½æ•°ï¼ˆæ¨èï¼‰
const agent = await agentFromWebDriverAgent({
  wdaPort: 8100,        // è‡ªå®šä¹‰ç«¯å£
  wdaHost: '192.168.1.100', // è‡ªå®šä¹‰ä¸»æœº
});
```

é’ˆå¯¹è¿œç¨‹è®¾å¤‡ï¼Œè¿˜éœ€è¦æŒ‰éœ€è®¾ç½®ç«¯å£è½¬å‘ï¼š

```bash
iproxy 8100 8100 YOUR_DEVICE_ID
```

### å¦‚ä½•åœ¨ Playground ä¸­è·å¾—æ›´æµç•…çš„å®æ—¶ç”»é¢ï¼Ÿ

Playground çš„ç”»é¢é¢„è§ˆæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

- **è½®è¯¢æ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰ï¼šé€å¸§è°ƒç”¨ WDA æˆªå›¾ APIï¼Œå¸§ç‡çº¦ 5-10fpsã€‚
- **åŸç”Ÿ MJPEG æµ**ï¼ˆæ¨èï¼‰ï¼šç›´æ¥ä»£ç† WDA å†…ç½®çš„ MJPEG Serverï¼Œå¸§ç‡æ›´é«˜ã€å»¶è¿Ÿæ›´ä½ã€‚

è¦å¯ç”¨åŸç”Ÿ MJPEG æµï¼Œéœ€è¦å°† WDA MJPEG Server çš„ç«¯å£ï¼ˆé»˜è®¤ 9100ï¼‰è½¬å‘åˆ°æœ¬æœºï¼š

```bash
# çœŸæœºéœ€è¦ç«¯å£è½¬å‘ï¼ˆæ¨¡æ‹Ÿå™¨ä¸éœ€è¦ï¼‰
iproxy 9100 9100 YOUR_DEVICE_ID
```

Playground å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ¢æµ‹ 9100 ç«¯å£ã€‚å¦‚æœå¯ç”¨ï¼Œæ—¥å¿—ä¼šæ˜¾ç¤º `MJPEG: streaming via native WDA MJPEG server`ï¼›å¦åˆ™è‡ªåŠ¨å›é€€åˆ°è½®è¯¢æ¨¡å¼ã€‚

## æ›´å¤š

- æŸ¥çœ‹æ‰€æœ‰ Agent æ–¹æ³•ï¼š[API å‚è€ƒï¼ˆé€šç”¨ï¼‰](./api#interaction-methods)
- iOS ä¸“å±å‚æ•°ä¸æ¥å£ï¼š[iOS Agent API](./ios-api-reference)
- ç¤ºä¾‹é¡¹ç›®
  - iOS JavaScript SDK ç¤ºä¾‹ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo](https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo)
  - iOS + Vitest ç¤ºä¾‹ï¼š[https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo](https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo)
