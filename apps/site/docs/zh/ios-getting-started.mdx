import StartExperience from './common/start-experience.mdx';
import SetupEnv from './common/setup-env.mdx';
import PrepareIOS from './common/prepare-ios.mdx';

import { PackageManagerTabs } from '@theme';

# iOS 快速开始

本指南会带你完成使用 Midscene 控制 iOS 设备的全部步骤：如何通过 WebDriverAgent 连接真机、配置模型凭证、体验零代码 Playground、集成 JavaScript SDK，并查阅高级 API 与常见问题。

## 准备工作

在继续之前，请确保 WebDriverAgent 可以与设备通信，并已经准备好 Midscene 所需的 AI 模型凭证。

<PrepareIOS />

### 模型配置（API Keys）

准备任意视觉语言（VL）模型的 API Key，可在 [模型策略](./model-strategy) 查看支持的模型。

<SetupEnv />

## 了解 WebDriverAgent

WebDriver 是 W3C 制定的浏览器自动化标准协议，提供统一的 API 来控制不同的浏览器和应用。该协议定义了客户端与服务端之间的通信方式，使自动化工具能跨平台地操纵各种界面。

得益于 Appium 团队以及其他开源社区的努力，业界已经出现了多个优秀的库，将桌面端和移动端的操作转化为 WebDriver 协议，例如：

- **Appium** —— 跨平台移动自动化框架
- **WebDriverAgent** —— 专注于 iOS 设备自动化的服务
- **Selenium** —— Web 浏览器自动化工具
- **WinAppDriver** —— Windows 应用自动化工具

**Midscene 适配 WebDriver 协议**，这意味着开发者可以在任何支持 WebDriver 的设备上使用 AI 模型执行智能自动化操作。通过该设计，Midscene 不仅能完成点击、输入等传统操作，还可以：

- 理解界面内容与上下文
- 执行复杂的多步骤操作
- 进行智能断言与验证
- 提取并分析界面数据

在 iOS 平台上，Midscene 通过 WebDriverAgent 连接 iOS 设备，让你可以用自然语言描述来控制 iOS App 和系统。

:::info 案例展示

[查看更多案例](./ios-introduction)

<p align="center">
  <img src="/ios.png" alt="ios" width="400" />
</p>

:::

## 试用 Playground

Playground 是验证连接、观察 AI 驱动步骤的最快方式，无需编写代码。它与 `@midscene/ios` 共享相同的核心，因此在 Playground 中通过的流程，在脚本中运行会保持一致。

![](/ios-playground.png)

1. 启动 Playground CLI：

```bash
npx --yes @midscene/ios-playground
```

2. 点击窗口中的齿轮按钮进入配置页，粘贴你的 API Key 配置。如果还没有凭证，请回到 [模型配置](./model-config) 获取。

![](/ios-set-env.png)

<StartExperience />

## 集成 JavaScript SDK

当 Playground 工作正常后，就可以升级到可复用脚本。SDK 提供相同的能力，并额外支持 CI、测试以及自定义流程。

:::info 示例项目
使用 JavaScript 控制 iOS 设备：[https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo](https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo)

集成 Vitest 进行测试：[https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo](https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo)
:::

### 安装依赖

<PackageManagerTabs command="install @midscene/ios --save-dev" />

### 编写首个脚本

下面的示例会在设备上打开 Safari，搜索 eBay，并断言结果列表。

```typescript title="./demo.ts"
import {
  IOSAgent,
  IOSDevice,
  agentFromWebDriverAgent,
} from '@midscene/ios';

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    // 方式一：直接创建设备和 Agent
    const page = new IOSDevice({
      wdaPort: 8100,
      wdaHost: 'localhost',
    });

    // 👀 初始化 Midscene Agent
    const agent = new IOSAgent(page, {
      aiActionContext:
        'If any location, permission, user agreement, etc. popup appears, click agree. If login page appears, close it.',
    });
    await page.connect();

    // 方式二：使用便捷函数（推荐）
    // const agent = await agentFromWebDriverAgent({
    //   wdaPort: 8100,
    //   wdaHost: 'localhost',
    //   aiActionContext: 'If any location, permission, user agreement, etc. popup appears, click agree. If login page appears, close it.',
    // });

    // 👀 直接打开 ebay.com（推荐做法）
    await page.launch('https://ebay.com');
    await sleep(3000);

    // 👀 输入关键字并执行搜索
    await agent.aiAct('Search for "Headphones"');

    // 👀 等待加载完成
    await agent.aiWaitFor('At least one headphone product is displayed on the page');
    // 或简单地等待几秒：
    // await sleep(5000);

    // 👀 理解页面内容并提取数据
    const items = await agent.aiQuery(
      '{itemTitle: string, price: Number}[], find product titles and prices in the list',
    );
    console.log('Headphone product information', items);

    // 👀 使用 AI 断言
    await agent.aiAssert('Multiple headphone products are displayed on the interface');

    await page.destroy();
  })(),
);
```

### 运行示例

```bash
npx tsx demo.ts
```

### 查看 HTML 报告

脚本成功后会输出 `Midscene - report file updated: /path/to/report/some_id.html`。在浏览器中打开对应 HTML 文件即可回放每一步交互、查询与断言。

## API 参考与更多资源

需要查看构造函数、辅助方法或平台专属设备 API？请移步 [iOS API 参考](./ios-api-reference) 获取详细参数及自定义操作等高级主题。若想了解跨平台共用的 API，可阅读 [通用 API 参考](./api)，同时通过 [Prompting tips](./prompting-tips) 提升提示词效果。

## 常见问题

### 为什么 WebDriverAgent 已连接，但仍无法控制设备？

请检查以下事项：

1. **开发者模式**：在“设置 > 隐私与安全性 > 开发者模式”中确认已开启。
2. **UI Automation**：在“设置 > 开发者 > UI Automation”中确认已开启。
3. **设备信任**：确保设备信任当前 Mac。

### 模拟器与真机有哪些区别？

| 特性 | 真机 | 模拟器 |
|------|------|--------|
| 端口转发 | 需要 iproxy | 不需要 |
| 开发者模式 | 必须手动开启 | 默认开启 |
| UI Automation 设置 | 需手动开启 | 默认开启 |
| 性能 | 真实设备性能 | 取决于 Mac 性能 |
| 传感器 | 真实硬件 | 模拟数据 |

### 如何自定义 WebDriverAgent 的端口和 Host？

可以通过 `IOSDevice` 构造函数或 `agentFromWebDriverAgent` 来指定端口和 Host：

```typescript
// 方式一：使用 IOSDevice
const device = new IOSDevice({
  wdaPort: 8100,        // 自定义端口
  wdaHost: '192.168.1.100', // 自定义主机
});

// 方式二：使用便捷函数（推荐）
const agent = await agentFromWebDriverAgent({
  wdaPort: 8100,        // 自定义端口
  wdaHost: '192.168.1.100', // 自定义主机
});
```

针对远程设备，还需要按需设置端口转发：

```bash
iproxy 8100 8100 YOUR_DEVICE_ID
```

## 下一步

- 使用 [与任意界面集成](./integrate-with-any-interface) 将 Midscene 接入更多界面
- 在 [YAML 格式的工作流](./automate-with-scripts-in-yaml) 中探索自动化流程
