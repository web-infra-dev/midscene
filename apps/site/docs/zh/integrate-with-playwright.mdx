import SetupEnv from './common/setup-env.mdx';
import { PackageManagerTabs } from '@theme';

# é›†æˆåˆ° Playwright

[Playwright.js](https://playwright.com/) æ˜¯ç”±å¾®è½¯å¼€å‘çš„ä¸€ä¸ªå¼€æºè‡ªåŠ¨åŒ–åº“ï¼Œä¸»è¦ç”¨äºå¯¹ç½‘ç»œåº”ç”¨ç¨‹åºè¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆend-to-end testï¼‰å’Œç½‘é¡µæŠ“å–ã€‚

ä¸ Playwright çš„é›†æˆæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡ Playwright çš„æµ‹è¯•ç”¨ä¾‹ç®¡ç†é›†æˆ Midsceneï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥ç”¨è„šæœ¬æ–¹å¼é›†æˆå’Œè°ƒç”¨ Midscene Agentã€‚å‰è€…é€‚åˆéœ€è¦ç®¡ç†æµ‹è¯•ç”¨ä¾‹çš„åœºæ™¯ï¼Œåè€…é€‚åˆå¿«é€Ÿä½“éªŒã€åŸå‹å¼€å‘ã€æ•°æ®æŠ“å–å’Œè‡ªåŠ¨åŒ–è„šæœ¬ç­‰åœºæ™¯ã€‚

å‰è€…é€‚åˆéœ€è¦ç®¡ç†æµ‹è¯•ç”¨ä¾‹çš„åœºæ™¯ï¼Œåè€…é€‚åˆå¿«é€Ÿä½“éªŒã€åŸå‹å¼€å‘ã€æ•°æ®æŠ“å–å’Œè‡ªåŠ¨åŒ–è„šæœ¬ã€ä¸ä¸‰æ–¹æµ‹è¯•æ¡†æ¶é›†æˆç­‰åœºæ™¯ã€‚

<SetupEnv />

## è„šæœ¬ç›´è¿å¼é›†æˆ

:::info æ ·ä¾‹é¡¹ç›®
ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°å‘ Playwright é›†æˆçš„æ ·ä¾‹é¡¹ç›®ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/playwright-demo](https://github.com/web-infra-dev/midscene-example/blob/main/playwright-demo)
:::

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

<PackageManagerTabs command="install @midscene/web playwright @playwright/test tsx --save-dev" />

### ç¬¬äºŒæ­¥ï¼šç¼–å†™è„šæœ¬

ç¼–å†™ä¸‹æ–¹ä»£ç ï¼Œä¿å­˜ä¸º `./demo.ts`

```typescript
import { chromium } from 'playwright';
import { PlaywrightAgent } from '@midscene/web/playwright';
import 'dotenv/config'; // read environment variables from .env file

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

Promise.resolve(
  (async () => {
    const browser = await chromium.launch({
      headless: true, // 'true' means we can't see the browser window
      args: ['--no-sandbox', '--disable-setuid-sandbox'],
    });

    const page = await browser.newPage();
    await page.setViewportSize({
      width: 1280,
      height: 768,
    });
    await page.goto('https://www.ebay.com');
    await sleep(5000); // ğŸ‘€ init Midscene agent
    const agent = new PlaywrightAgent(page);

    // ğŸ‘€ type keywords, perform a search
    await agent.aiAction('type "Headphones" in search box, hit Enter');

    // ğŸ‘€ wait for the loading
    await agent.aiWaitFor('there is at least one headphone item on page');
    // or you may use a plain sleep:
    // await sleep(5000);

    // ğŸ‘€ understand the page content, find the items
    const items = await agent.aiQuery(
      '{itemTitle: string, price: Number}[], find item in list and corresponding price',
    );
    console.log('headphones in stock', items);

    const isMoreThan1000 = await agent.aiBoolean(
      'Is the price of the headphones more than 1000?',
    );
    console.log('isMoreThan1000', isMoreThan1000);

    const price = await agent.aiNumber(
      'What is the price of the first headphone?',
    );
    console.log('price', price);

    const name = await agent.aiString(
      'What is the name of the first headphone?',
    );
    console.log('name', name);

    const location = await agent.aiLocate(
      'What is the location of the first headphone?',
    );
    console.log('location', location);

    // ğŸ‘€ assert by AI
    await agent.aiAssert('There is a category filter on the left');

    // ğŸ‘€ click on the first item
    await agent.aiTap('the first item in the list');

    await browser.close();
  })(),
);
```

æ›´å¤š Agent çš„ API è®²è§£è¯·å‚è€ƒ [API å‚è€ƒ](./API)ã€‚

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ

ä½¿ç”¨ `tsx` æ¥è¿è¡Œï¼Œä½ ä¼šçœ‹åˆ°å‘½ä»¤è¡Œæ‰“å°å‡ºäº†è€³æœºçš„å•†å“ä¿¡æ¯ï¼š

```bash
# run
npx tsx demo.ts

# å‘½ä»¤è¡Œåº”è¯¥æœ‰å¦‚ä¸‹è¾“å‡º
#  [
#   {
#     itemTitle: 'JBL Tour Pro 2 - True wireless Noise Cancelling earbuds with Smart Charging Case',
#     price: 551.21
#   },
#   {
#     itemTitle: 'Soundcore Space Oneæ— çº¿è€³æœº40H ANCæ’­æ”¾æ—¶é—´2XStrongerè¯­éŸ³è¿˜åŸ',
#     price: 543.94
#   }
# ]
```

### ç¬¬å››æ­¥ï¼šæŸ¥çœ‹è¿è¡ŒæŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: /path/to/report/some_id.html`ï¼Œ é€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚

### å¦‚ä½•é™åˆ¶é¡µé¢åœ¨å½“å‰ tab æ‰“å¼€

å¦‚æœä½ æƒ³è¦é™åˆ¶é¡µé¢åœ¨å½“å‰ tab æ‰“å¼€ï¼ˆæ¯”å¦‚ç‚¹å‡»ä¸€ä¸ªå¸¦æœ‰ `target="_blank"` å±æ€§çš„é“¾æ¥ï¼‰ï¼Œä½ å¯ä»¥è®¾ç½® `forceSameTabNavigation` é€‰é¡¹ä¸º `true`ï¼š

```typescript
const mid = new PlaywrightAgent(page, {
  forceSameTabNavigation: true,
});
```

## æµ‹è¯•ç”¨ä¾‹ç®¡ç†é›†æˆ

è¿™é‡Œæˆ‘ä»¬å‡è®¾ä½ å·²ç»æ‹¥æœ‰ä¸€ä¸ªé›†æˆäº† Playwright çš„ä»“åº“ã€‚

:::info æ ·ä¾‹é¡¹ç›®
ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°å‘ Playwright é›†æˆçš„æ ·ä¾‹é¡¹ç›®ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/playwright-testing-demo](https://github.com/web-infra-dev/midscene-example/blob/main/playwright-testing-demo)
:::

### ç¬¬ä¸€æ­¥ï¼šæ–°å¢ä¾èµ–ï¼Œæ›´æ–°é…ç½®æ–‡ä»¶

æ–°å¢ä¾èµ–

<PackageManagerTabs command="install @midscene/web --save-dev" />

æ›´æ–° playwright.config.ts

```diff
export default defineConfig({
  testDir: './e2e',
+ timeout: 90 * 1000,
+ reporter: [["list"], ["@midscene/web/playwright-reporter", { type: "merged" }]], // type å¯é€‰, é»˜è®¤å€¼ä¸º "merged"ï¼Œè¡¨ç¤ºå¤šä¸ªæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆä¸€ä¸ªæŠ¥å‘Šï¼Œå¯é€‰å€¼ä¸º "separate"ï¼Œè¡¨ç¤ºä¸ºæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸€ä¸ªæŠ¥å‘Š
});
```

å…¶ä¸­ `reporter` é…ç½®é¡¹çš„ `type` å¯é€‰å€¼ä¸º `merged` æˆ– `separate`ï¼Œé»˜è®¤å€¼ä¸º `merged`ï¼Œè¡¨ç¤ºå¤šä¸ªæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆä¸€ä¸ªæŠ¥å‘Šï¼Œå¯é€‰å€¼ä¸º `separate`ï¼Œè¡¨ç¤ºä¸ºæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸€ä¸ªæŠ¥å‘Šã€‚

### ç¬¬äºŒæ­¥ï¼šæ‰©å±• `test` å®ä¾‹

æŠŠä¸‹æ–¹ä»£ç ä¿å­˜ä¸º `./e2e/fixture.ts`;

```typescript
import { test as base } from '@playwright/test';
import type { PlayWrightAiFixtureType } from '@midscene/web/playwright';
import { PlaywrightAiFixture } from '@midscene/web/playwright';

export const test = base.extend<PlayWrightAiFixtureType>(
  PlaywrightAiFixture({
    waitForNetworkIdleTimeout: 2000, // å¯é€‰, äº¤äº’è¿‡ç¨‹ä¸­ç­‰å¾…ç½‘ç»œç©ºé—²çš„è¶…æ—¶æ—¶é—´, é»˜è®¤å€¼ä¸º 2000ms, è®¾ç½®ä¸º 0 åˆ™ç¦ç”¨è¶…æ—¶
  }),
);
```

### ç¬¬ä¸‰æ­¥ï¼šç¼–å†™æµ‹è¯•ç”¨ä¾‹

#### åŸºç¡€ AI æ“ä½œ

- `ai` æˆ– `aiAction` - é€šç”¨ AI äº¤äº’
- `aiTap` - ç‚¹å‡»æ“ä½œ
- `aiHover` - æ‚¬åœæ“ä½œ
- `aiInput` - è¾“å…¥æ“ä½œ
- `aiKeyboardPress` - é”®ç›˜æ“ä½œ
- `aiScroll` - æ»šåŠ¨æ“ä½œ

#### æŸ¥è¯¢

- `aiAsk` - è¯¢é—® AI æ¨¡å‹ä»»ä½•é—®é¢˜
- `aiQuery` - ä»å½“å‰é¡µé¢æå–ç»“æ„åŒ–çš„æ•°æ®
- `aiNumber` - ä»å½“å‰é¡µé¢æå–æ•°å­—
- `aiString` - ä»å½“å‰é¡µé¢æå–å­—ç¬¦ä¸²
- `aiBoolean` - ä»å½“å‰é¡µé¢æå–å¸ƒå°”å€¼

#### æ›´å¤š API

- `aiAssert` - æ–­è¨€
- `aiWaitFor` - ç­‰å¾…
- `aiLocate` - å®šä½å…ƒç´ 

é™¤äº†ä¸Šè¿°æš´éœ²çš„å¿«æ·æ–¹æ³•ä¹‹å¤–ï¼Œå¦‚æœè¿˜éœ€è¦è°ƒç”¨å…¶å®ƒ agent æä¾›çš„ [API](./API)ï¼Œè¯·ä½¿ç”¨ `agentForPage` è·å– `PageAgent` å®ä¾‹ï¼Œä½¿ç”¨ `PageAgent` è°ƒç”¨ API è¿›è¡Œäº¤äº’ï¼š

````typescript
test('case demo', async ({ agentForPage, page }) => {
  const agent = await agentForPage(page);

  await agent.logScreenshot();
  const logContent = agent._unstableLogContent();
  console.log(logContent);
});

#### ç¤ºä¾‹ä»£ç 

```typescript title="./e2e/ebay-search.spec.ts"
import { expect } from '@playwright/test';
import { test } from './fixture';

test.beforeEach(async ({ page }) => {
  page.setViewportSize({ width: 400, height: 905 });
  await page.goto('https://www.ebay.com');
  await page.waitForLoadState('networkidle');
});

test('search headphone on ebay', async ({
  ai,
  aiQuery,
  aiAssert,
  aiInput,
  aiTap,
  aiScroll,
  aiWaitFor,
}) => {
  // ä½¿ç”¨ aiInput è¾“å…¥æœç´¢å…³é”®è¯
  await aiInput('Headphones', 'æœç´¢æ¡†');

  // ä½¿ç”¨ aiTap ç‚¹å‡»æœç´¢æŒ‰é’®
  await aiTap('æœç´¢æŒ‰é’®');

  // ç­‰å¾…æœç´¢ç»“æœåŠ è½½
  await aiWaitFor('æœç´¢ç»“æœåˆ—è¡¨å·²åŠ è½½', { timeoutMs: 5000 });

  // ä½¿ç”¨ aiScroll æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨
  await aiScroll(
    {
      direction: 'down',
      scrollType: 'untilBottom',
    },
    'æœç´¢ç»“æœåˆ—è¡¨',
  );

  // ä½¿ç”¨ aiQuery è·å–å•†å“ä¿¡æ¯
  const items =
    await aiQuery<Array<{ title: string; price: number }>>(
      'è·å–æœç´¢ç»“æœä¸­çš„å•†å“æ ‡é¢˜å’Œä»·æ ¼',
    );

  console.log('headphones in stock', items);
  expect(items?.length).toBeGreaterThan(0);

  // ä½¿ç”¨ aiAssert éªŒè¯ç­›é€‰åŠŸèƒ½
  await aiAssert('ç•Œé¢å·¦ä¾§æœ‰ç±»ç›®ç­›é€‰åŠŸèƒ½');
});
````

æ›´å¤š Agent çš„ API è®²è§£è¯·å‚è€ƒ [API å‚è€ƒ](./API)ã€‚

### Step 4. è¿è¡Œæµ‹è¯•ç”¨ä¾‹

```bash
npx playwright test ./e2e/ebay-search.spec.ts
```

### Step 5. æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: ./current_cwd/midscene_run/report/some_id.html`ï¼Œé€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚

## æ›´å¤š

- æ›´å¤š Agent ä¸Šçš„ API æ¥å£è¯·å‚è€ƒ [API å‚è€ƒ](./API)ã€‚
- æ›´å¤šå…³äºæç¤ºè¯çš„æŠ€å·§è¯·å‚è€ƒ [æç¤ºè¯æŠ€å·§](./prompting-tips)
