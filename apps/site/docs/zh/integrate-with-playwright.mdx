import SetupEnv from './common/setup-env.mdx';
import { PackageManagerTabs } from '@theme';

# é›†æˆåˆ° Playwright

[Playwright.js](https://playwright.com/) æ˜¯ç”±å¾®è½¯å¼€å‘çš„ä¸€ä¸ªå¼€æºè‡ªåŠ¨åŒ–åº“ï¼Œä¸»è¦ç”¨äºå¯¹ç½‘ç»œåº”ç”¨ç¨‹åºè¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆend-to-end testï¼‰å’Œç½‘é¡µæŠ“å–ã€‚

ä¸ Playwright çš„é›†æˆæ–¹å¼æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š

- ç›´æ¥ç”¨è„šæœ¬æ–¹å¼é›†æˆå’Œè°ƒç”¨ Midscene Agentï¼Œé€‚åˆå¿«é€Ÿä½“éªŒã€åŸå‹å¼€å‘ã€æ•°æ®æŠ“å–å’Œè‡ªåŠ¨åŒ–è„šæœ¬ç­‰åœºæ™¯ã€‚
- åœ¨ Playwright çš„æµ‹è¯•ç”¨ä¾‹ä¸­é›†æˆ Midsceneï¼Œé€‚åˆéœ€è¦æ‰§è¡Œ UI æµ‹è¯•çš„åœºæ™¯ã€‚

<SetupEnv />

## ç›´æ¥é›†æˆ Midscene Agent

:::info æ ·ä¾‹é¡¹ç›®
ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°å‘ Playwright é›†æˆçš„æ ·ä¾‹é¡¹ç›®ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/playwright-demo](https://github.com/web-infra-dev/midscene-example/blob/main/playwright-demo)
:::

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

<PackageManagerTabs command="install @midscene/web playwright @playwright/test tsx --save-dev" />

### ç¬¬äºŒæ­¥ï¼šç¼–å†™è„šæœ¬

ç¼–å†™ä¸‹æ–¹ä»£ç ï¼Œä¿å­˜ä¸º `./demo.ts`

```typescript
import { chromium } from 'playwright';
import { PlaywrightAgent } from '@midscene/web/playwright';
import 'dotenv/config'; // read environment variables from .env file

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

Promise.resolve(
  (async () => {
    const browser = await chromium.launch({
      headless: true, // 'true' means we can't see the browser window
      args: ['--no-sandbox', '--disable-setuid-sandbox'],
    });

    const page = await browser.newPage();
    await page.setViewportSize({
      width: 1280,
      height: 768,
    });
    await page.goto('https://www.ebay.com');
    await sleep(5000); // ğŸ‘€ init Midscene agent
    const agent = new PlaywrightAgent(page);

    // ğŸ‘€ type keywords, perform a search
    await agent.aiAct('type "Headphones" in search box, hit Enter');

    // ğŸ‘€ wait for the loading
    await agent.aiWaitFor('there is at least one headphone item on page');
    // or you may use a plain sleep:
    // await sleep(5000);

    // ğŸ‘€ understand the page content, find the items
    const items = await agent.aiQuery(
      '{itemTitle: string, price: Number}[], find item in list and corresponding price',
    );
    console.log('headphones in stock', items);

    const isMoreThan1000 = await agent.aiBoolean(
      'Is the price of the headphones more than 1000?',
    );
    console.log('isMoreThan1000', isMoreThan1000);

    const price = await agent.aiNumber(
      'What is the price of the first headphone?',
    );
    console.log('price', price);

    const name = await agent.aiString(
      'What is the name of the first headphone?',
    );
    console.log('name', name);

    const location = await agent.aiLocate(
      'What is the location of the first headphone?',
    );
    console.log('location', location);

    // ğŸ‘€ assert by AI
    await agent.aiAssert('There is a category filter on the left');

    // ğŸ‘€ click on the first item
    await agent.aiTap('the first item in the list');

    await browser.close();
  })(),
);
```

æ›´å¤š Agent çš„ API è®²è§£è¯·å‚è€ƒ [API å‚è€ƒ](./api#interaction-methods)ã€‚

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ

ä½¿ç”¨ `tsx` æ¥è¿è¡Œï¼Œä½ ä¼šçœ‹åˆ°å‘½ä»¤è¡Œæ‰“å°å‡ºäº†è€³æœºçš„å•†å“ä¿¡æ¯ï¼š

```bash
# run
npx tsx demo.ts

# å‘½ä»¤è¡Œåº”è¯¥æœ‰å¦‚ä¸‹è¾“å‡º
#  [
#   {
#     itemTitle: 'JBL Tour Pro 2 - True wireless Noise Cancelling earbuds with Smart Charging Case',
#     price: 551.21
#   },
#   {
#     itemTitle: 'Soundcore Space Oneæ— çº¿è€³æœº40H ANCæ’­æ”¾æ—¶é—´2XStrongerè¯­éŸ³è¿˜åŸ',
#     price: 543.94
#   }
# ]
```

### ç¬¬å››æ­¥ï¼šæŸ¥çœ‹è¿è¡ŒæŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: /path/to/report/some_id.html`ï¼Œ é€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚

<a id="playwrightagent"></a>

### å¦‚ä½•é™åˆ¶é¡µé¢åœ¨å½“å‰ tab æ‰“å¼€

å¦‚æœä½ æƒ³è¦é™åˆ¶é¡µé¢åœ¨å½“å‰ tab æ‰“å¼€ï¼ˆæ¯”å¦‚ç‚¹å‡»ä¸€ä¸ªå¸¦æœ‰ `target="_blank"` å±æ€§çš„é“¾æ¥ï¼‰ï¼Œä½ å¯ä»¥è®¾ç½® `forceSameTabNavigation` é€‰é¡¹ä¸º `true`ï¼š

```typescript
const mid = new PlaywrightAgent(page, {
  forceSameTabNavigation: true,
});
```

## åœ¨ Playwright çš„æµ‹è¯•ç”¨ä¾‹ä¸­é›†æˆ Midscene

è¿™é‡Œæˆ‘ä»¬å‡è®¾ä½ å·²ç»æ‹¥æœ‰ä¸€ä¸ªé›†æˆäº† Playwright çš„æµ‹è¯•é¡¹ç›®ã€‚

:::info æ ·ä¾‹é¡¹ç›®
ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°å‘ Playwright é›†æˆçš„æ ·ä¾‹é¡¹ç›®ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/playwright-testing-demo](https://github.com/web-infra-dev/midscene-example/blob/main/playwright-testing-demo)
:::

### ç¬¬ä¸€æ­¥ï¼šæ–°å¢ä¾èµ–ï¼Œæ›´æ–°é…ç½®æ–‡ä»¶

æ–°å¢ä¾èµ–

<PackageManagerTabs command="install @midscene/web --save-dev" />

æ›´æ–° playwright.config.ts

```diff
export default defineConfig({
  testDir: './e2e',
+ timeout: 90 * 1000,
+ reporter: [["list"], ["@midscene/web/playwright-reporter", { type: "merged" }]], // type å¯é€‰, é»˜è®¤å€¼ä¸º "merged"ï¼Œè¡¨ç¤ºå¤šä¸ªæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆä¸€ä¸ªæŠ¥å‘Šï¼Œå¯é€‰å€¼ä¸º "separate"ï¼Œè¡¨ç¤ºä¸ºæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸€ä¸ªæŠ¥å‘Š
});
```

å…¶ä¸­ `reporter` é…ç½®é¡¹çš„ `type` å¯é€‰å€¼ä¸º `merged` æˆ– `separate`ï¼Œé»˜è®¤å€¼ä¸º `merged`ï¼Œè¡¨ç¤ºå¤šä¸ªæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆä¸€ä¸ªæŠ¥å‘Šï¼Œå¯é€‰å€¼ä¸º `separate`ï¼Œè¡¨ç¤ºä¸ºæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸€ä¸ªæŠ¥å‘Šã€‚

### ç¬¬äºŒæ­¥ï¼šæ‰©å±• `test` å®ä¾‹

æŠŠä¸‹æ–¹ä»£ç ä¿å­˜ä¸º `./e2e/fixture.ts`;

```typescript
import { test as base } from '@playwright/test';
import type { PlayWrightAiFixtureType } from '@midscene/web/playwright';
import { PlaywrightAiFixture } from '@midscene/web/playwright';

export const test = base.extend<PlayWrightAiFixtureType>(
  PlaywrightAiFixture({
    waitForNetworkIdleTimeout: 2000, // å¯é€‰, äº¤äº’è¿‡ç¨‹ä¸­ç­‰å¾…ç½‘ç»œç©ºé—²çš„è¶…æ—¶æ—¶é—´, é»˜è®¤å€¼ä¸º 2000ms, è®¾ç½®ä¸º 0 åˆ™ç¦ç”¨è¶…æ—¶
  }),
);
```

### ç¬¬ä¸‰æ­¥ï¼šç¼–å†™æµ‹è¯•ç”¨ä¾‹

å®Œæ•´çš„äº¤äº’ã€æŸ¥è¯¢å’Œè¾…åŠ© API è¯·å‚è€ƒ [Agent API å‚è€ƒ](./api#interaction-methods)ã€‚å¦‚æœéœ€è¦è°ƒç”¨æ›´åº•å±‚çš„èƒ½åŠ›ï¼Œå¯ä»¥ä½¿ç”¨ `agentForPage` è·å– `PageAgent` å®ä¾‹ï¼Œå†ç›´æ¥è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼š

```typescript
test('case demo', async ({ agentForPage, page }) => {
  const agent = await agentForPage(page);

  await agent.recordToReport();
  const logContent = agent._unstableLogContent();
  console.log(logContent);
});
```

#### ç¤ºä¾‹ä»£ç 

```typescript title="./e2e/ebay-search.spec.ts"
import { expect } from '@playwright/test';
import { test } from './fixture';

test.beforeEach(async ({ page }) => {
  page.setViewportSize({ width: 400, height: 905 });
  await page.goto('https://www.ebay.com');
  await page.waitForLoadState('networkidle');
});

test('search headphone on ebay', async ({
  ai,
  aiQuery,
  aiAssert,
  aiInput,
  aiTap,
  aiScroll,
  aiWaitFor,
  aiRightClick,
  recordToReport,
}) => {
  // ä½¿ç”¨ aiInput è¾“å…¥æœç´¢å…³é”®è¯
  await aiInput('Headphones', 'æœç´¢æ¡†');

  // ä½¿ç”¨ aiTap ç‚¹å‡»æœç´¢æŒ‰é’®
  await aiTap('æœç´¢æŒ‰é’®');

  // ç­‰å¾…æœç´¢ç»“æœåŠ è½½
  await aiWaitFor('æœç´¢ç»“æœåˆ—è¡¨å·²åŠ è½½', { timeoutMs: 5000 });

  // ä½¿ç”¨ aiScroll æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨
  await aiScroll(
    {
      direction: 'down',
      scrollType: 'untilBottom',
    },
    'æœç´¢ç»“æœåˆ—è¡¨',
  );

  // ä½¿ç”¨ aiQuery è·å–å•†å“ä¿¡æ¯
  const items =
    await aiQuery<Array<{ title: string; price: number }>>(
      'è·å–æœç´¢ç»“æœä¸­çš„å•†å“æ ‡é¢˜å’Œä»·æ ¼',
    );

  console.log('headphones in stock', items);
  expect(items?.length).toBeGreaterThan(0);

  // ä½¿ç”¨ aiAssert éªŒè¯ç­›é€‰åŠŸèƒ½
  await aiAssert('ç•Œé¢å·¦ä¾§æœ‰ç±»ç›®ç­›é€‰åŠŸèƒ½');

  // ä½¿ç”¨ recordToReport è®°å½•å½“å‰çŠ¶æ€
  await recordToReport('æœç´¢ç»“æœ', { content: 'è€³æœºæœç´¢çš„æœ€ç»ˆç»“æœ' });
});
```

æ›´å¤š Agent çš„ API è®²è§£è¯·å‚è€ƒ [API å‚è€ƒ](./api#interaction-methods)ã€‚

### Step 4. è¿è¡Œæµ‹è¯•ç”¨ä¾‹

```bash
npx playwright test ./e2e/ebay-search.spec.ts
```

### Step 5. æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: ./current_cwd/midscene_run/report/some_id.html`ï¼Œé€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚

## ç¤ºä¾‹ï¼šè¿æ¥è¿œç¨‹ Playwright æµè§ˆå™¨å¹¶æ¥å…¥ Midscene Agent

å½“ä½ æƒ³å¤ç”¨å·²æœ‰çš„è¿œç¨‹æµè§ˆå™¨ï¼ˆä¾‹å¦‚äº‘ç«¯å¸¸é©»çš„ workerã€ç¬¬ä¸‰æ–¹æµè§ˆå™¨æœåŠ¡æˆ–æœ¬åœ°å†…ç½‘æ¡Œé¢ï¼‰æ—¶ï¼Œå¯é€šè¿‡æ­¤æµç¨‹å°† Midscene ä¸è¿œç¨‹ Playwright å®ä¾‹æ‰“é€šã€‚è¿™æ ·å¯ä»¥è®©æµè§ˆå™¨è´´è¿‘ç›®æ ‡ç¯å¢ƒã€é™ä½å¯åŠ¨å¼€é”€ï¼Œå¹¶é›†ä¸­ç®¡ç†æµè§ˆå™¨èµ„æºï¼ŒåŒæ—¶ä¿æŒä¸€è‡´çš„ AI è‡ªåŠ¨åŒ–èƒ½åŠ›ã€‚

å®è·µä¸­ä½ éœ€è¦æ‰‹åŠ¨ï¼š
1. ä»è¿œç¨‹æµè§ˆå™¨æœåŠ¡è·å– CDP WebSocket URL
2. ä½¿ç”¨ Playwright è¿æ¥åˆ°è¿œç¨‹æµè§ˆå™¨
3. åˆ›å»º Midscene ä»£ç†è¿›è¡Œ AI é©±åŠ¨çš„è‡ªåŠ¨åŒ–

å¯¹åº”çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```typescript
import { chromium } from 'playwright';
import { PlaywrightAgent } from '@midscene/web/playwright';

// å‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ª CDP WebSocket URL
const cdpWsUrl = 'ws://your-remote-browser.com/devtools/browser/your-session-id';

// è¿æ¥åˆ°è¿œç¨‹æµè§ˆå™¨
const browser = await chromium.connectOverCDP(cdpWsUrl);

// è·å–ä¸Šä¸‹æ–‡å’Œé¡µé¢
const context = browser.contexts()[0];
const page = context.pages()[0] || await context.newPage();

// åˆ›å»º Midscene ä»£ç†
const agent = new PlaywrightAgent(page);

// ä½¿ç”¨ AI æ–¹æ³•
await agent.aiAction('è·³è½¬åˆ° https://example.com');
await agent.aiAction('åœ¨é‚®ç®±è¾“å…¥æ¡†ä¸­è¾“å…¥ "user@example.com"');

// æ¸…ç†
await agent.destroy();
await browser.close();
```

## æ‰©å±•è‡ªå®šä¹‰äº¤äº’åŠ¨ä½œ

ä½¿ç”¨ `customActions` é€‰é¡¹ï¼Œç»“åˆ `defineAction` å®šä¹‰çš„è‡ªå®šä¹‰äº¤äº’åŠ¨ä½œï¼Œå¯ä»¥æ‰©å±• Agent çš„åŠ¨ä½œç©ºé—´ã€‚è¿™äº›åŠ¨ä½œä¼šè¿½åŠ åœ¨å†…ç½®åŠ¨ä½œä¹‹åï¼Œæ–¹ä¾¿ Agent åœ¨è§„åˆ’é˜¶æ®µè°ƒç”¨ã€‚

```typescript
import { getMidsceneLocationSchema, z } from '@midscene/core';
import { defineAction } from '@midscene/core/device';

const ContinuousClick = defineAction({
  name: 'continuousClick',
  description: 'Click the same target repeatedly',
  paramSchema: z.object({
    locate: getMidsceneLocationSchema(),
    count: z
      .number()
      .int()
      .positive()
      .describe('How many times to click'),
  }),
  async call(param) {
    const { locate, count } = param;
    console.log('click target center', locate.center);
    console.log('click count', count);
    // åœ¨è¿™é‡Œç»“åˆ locate + count å®ç°è‡ªå®šä¹‰ç‚¹å‡»é€»è¾‘
  },
});

const agent = new PlaywrightAgent(page, {
  customActions: [ContinuousClick],
});

await agent.aiAct('ç‚¹å‡»çº¢è‰²æŒ‰é’®äº”æ¬¡');
```

æ›´å¤šå…³äºè‡ªå®šä¹‰åŠ¨ä½œçš„ç»†èŠ‚ï¼Œè¯·å‚è€ƒ [é›†æˆåˆ°ä»»æ„ç•Œé¢](./integrate-with-any-interface)ã€‚

## æ›´å¤š

- æ›´å¤š Agent ä¸Šçš„ API æ¥å£è¯·å‚è€ƒ [API å‚è€ƒ](./api#interaction-methods)ã€‚
- æ›´å¤šå…³äºæç¤ºè¯çš„æŠ€å·§è¯·å‚è€ƒ [æç¤ºè¯æŠ€å·§](./prompting-tips)
