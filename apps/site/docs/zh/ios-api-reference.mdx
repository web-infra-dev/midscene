# API 参考（iOS）

当你需要自定义 iOS 设备的行为、将 Midscene 接入依赖 WebDriverAgent 的工作流，或排查 WDA 请求问题时，请查阅本节内容。关于通用构造函数（报告、Hook、缓存等），请参考平台无关的 [API 参考](./api.mdx) 以及 [Prompting tips](./prompting-tips) 获取提示词相关指导。

## 导入与基础用法

要操作 iOS 设备，请导入 iOS SDK：

```typescript
import {
  IOSAgent,
  IOSDevice,
  agentFromWebDriverAgent,
} from '@midscene/ios';
```

基础示例：

```typescript
const device = new IOSDevice({
  wdaPort: 8100,
  wdaHost: 'localhost',
});

await device.connect();

const agent = new IOSAgent(device, {
  aiActionContext:
    'If any permission dialog appears, accept it. Close login popups.',
});

await device.launch('https://ebay.com');
await agent.aiAct('Search for "Headphones" and list a price');
const items = await agent.aiQuery(
  '{itemTitle: string, price: Number}[], list headphone products',
);
console.log(items);

await device.destroy();
```

## 构造函数

<a id="iosdevice"></a>

### IOSDevice 构造函数 {#iosdevice-constructor}

```ts
new IOSDevice(opts?: IOSDeviceOpt)
```

- `opts?: IOSDeviceOpt` —— 用于配置设备的可选参数。
  - `wdaPort?: number` —— WebDriverAgent 端口，默认 `8100`。
  - `wdaHost?: string` —— WebDriverAgent host，默认 `'localhost'`。
  - `autoDismissKeyboard?: boolean` —— 文本输入后自动隐藏键盘，默认 `true`。
  - `customActions?: DeviceAction<any>[]` —— 向 Agent 暴露的额外设备动作。

<a id="iosagent"></a>

### IOSAgent 构造函数 {#iosagent-constructor}

```ts
new IOSAgent(device: IOSDevice, options?: PageAgentOpt)
```

- `device: IOSDevice` —— 负责截图、点击、键盘输入和其他设备级操作。
- `options?: PageAgentOpt` —— 与 [API constructors](./api#constructors) 中的通用 Agent 选项一致，可用于配置报告、缓存、提示上下文、自定义 Hook 以及模型重写等。
- 便捷方法：[`agentFromWebDriverAgent`](#agentfromwebdriveragent) 可直接连接 WebDriverAgent 并返回可用的 Agent。

## iOS Agent 方法

### `agent.launch()`

打开网页、原生应用或自定义 Scheme。

```typescript
function launch(uri: string): Promise<void>;
```

- `uri: string` —— 目标地址（网页 URL、Bundle Identifier、URL scheme、tel/mailto 等）。

```typescript
const agent = await agentFromWebDriverAgent();

await agent.launch('https://www.apple.com');
await agent.launch('com.apple.Preferences');
await agent.launch('myapp://profile/user/123');
await agent.launch('tel:+1234567890');
```

### `agent.runWdaRequest()`

当你需要更底层的控制能力时，执行原始的 WebDriverAgent REST 请求。

```typescript
function runWdaRequest(
  method: string,
  endpoint: string,
  data?: Record<string, any>,
): Promise<any>;
```

- `method: string` —— HTTP 动词（`GET`、`POST`、`DELETE` 等）。
- `endpoint: string` —— WebDriverAgent 接口路径。
- `data?: Record<string, any>` —— 可选的 JSON 请求体。

```typescript
const agent = await agentFromWebDriverAgent();

const screen = await agent.runWdaRequest('GET', '/wda/screen');
await agent.runWdaRequest('POST', '/session/test/wda/pressButton', {
  name: 'home',
});
const info = await agent.runWdaRequest('GET', '/wda/device/info');
console.log(screen, info);
```

:::info YAML 用法
`launch` 和 `runWdaRequest` 等 iOS 专属辅助函数也可以在 YAML 脚本中使用。语法请参考 [iOS 平台特定动作](./automate-with-scripts-in-yaml#the-ios-part)。
:::

### `agent.home()`

回到主屏。

```typescript
function home(): Promise<void>;
```

```typescript
const agent = await agentFromWebDriverAgent();
await agent.home();
```

### `agent.appSwitcher()`

打开多任务视图。

```typescript
function appSwitcher(): Promise<void>;
```

```typescript
const agent = await agentFromWebDriverAgent();
await agent.appSwitcher();
```

## iOS 辅助工具

### `agentFromWebDriverAgent()` {#agentfromwebdriveragent}

通过连接 WebDriverAgent 创建 IOSAgent。该方法封装了设备创建和连接逻辑。

```typescript
function agentFromWebDriverAgent(
  opts?: PageAgentOpt & IOSDeviceOpt,
): Promise<IOSAgent>;
```

- `opts?: PageAgentOpt & IOSDeviceOpt` —— 在一个对象中同时传入通用 Agent 选项与 [`IOSDevice` 构造函数](#iosdevice-constructor) 的配置。

```typescript
import { agentFromWebDriverAgent } from '@midscene/ios';

const agent = await agentFromWebDriverAgent({
  wdaHost: 'localhost',
  wdaPort: 8100,
  aiActionContext: 'Accept permission dialogs automatically.',
});
```

## 扩展自定义交互动作

通过 `defineAction` 创建处理器并传入 `customActions`，即可扩展 Agent 的动作空间。这些动作会追加在内置动作之后，可在规划阶段被调用。

```typescript
import { getMidsceneLocationSchema, z } from '@midscene/core';
import { defineAction } from '@midscene/core/device';
import { agentFromWebDriverAgent } from '@midscene/ios';

const ContinuousClick = defineAction({
  name: 'continuousClick',
  description: 'Click the same target repeatedly',
  paramSchema: z.object({
    locate: getMidsceneLocationSchema(),
    count: z
      .number()
      .int()
      .positive()
      .describe('How many times to click'),
  }),
  async call({ locate, count }) {
    console.log('click target center', locate.center);
    console.log('click count', count);
  },
});

const agent = await agentFromWebDriverAgent({
  customActions: [ContinuousClick],
});

await agent.aiAct('Click the red button five times');
```

关于自定义动作的更多细节，请参阅 [将 Midscene 集成到任意界面](./integrate-with-any-interface)。
