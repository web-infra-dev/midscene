import SetupEnv from './common/setup-env.mdx';

# é›†æˆåˆ° Puppeteer

import { PackageManagerTabs } from '@theme';

[Puppeteer](https://pptr.dev/) æ˜¯ä¸€ä¸ª Node.js åº“ï¼Œå®ƒé€šè¿‡ DevTools åè®®æˆ– WebDriver BiDi æä¾›æ§åˆ¶ Chrome æˆ– Firefox çš„é«˜çº§ APIã€‚Puppeteer é»˜è®¤åœ¨æ— ç•Œé¢æ¨¡å¼ï¼ˆheadlessï¼‰ä¸‹è¿è¡Œï¼Œä½†å¯ä»¥é…ç½®ä¸ºåœ¨å¯è§çš„æµè§ˆå™¨æ¨¡å¼ï¼ˆheadedï¼‰ä¸­è¿è¡Œã€‚

:::info æ ·ä¾‹é¡¹ç›®
ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°å‘ Puppeteer é›†æˆçš„æ ·ä¾‹é¡¹ç›®ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/puppeteer-demo](https://github.com/web-infra-dev/midscene-example/blob/main/puppeteer-demo)

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª Puppeteer å’Œ Vitest ç»“åˆçš„æ ·ä¾‹é¡¹ç›®ï¼š[https://github.com/web-infra-dev/midscene-example/tree/main/puppeteer-with-vitest-demo](https://github.com/web-infra-dev/midscene-example/tree/main/puppeteer-with-vitest-demo)
:::

<SetupEnv />

## ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

<PackageManagerTabs command="install @midscene/web puppeteer tsx --save-dev" />

## ç¬¬äºŒæ­¥ï¼šç¼–å†™è„šæœ¬

ç¼–å†™ä¸‹æ–¹ä»£ç ï¼Œä¿å­˜ä¸º `./demo.ts`

```typescript title="./demo.ts"
import puppeteer from "puppeteer";
import { PuppeteerAgent } from "@midscene/web/puppeteer";

const sleep = (ms: number) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    const browser = await puppeteer.launch({
      headless: false, // here we use headed mode to help debug
    });

    const page = await browser.newPage();
    await page.setViewport({
      width: 1280,
      height: 800,
      deviceScaleFactor: 1,
    });

    await page.goto("https://www.ebay.com");
    await sleep(5000);

    // ğŸ‘€ åˆå§‹åŒ– Midscene agent 
    const agent = new PuppeteerAgent(page);

    // ğŸ‘€ æ‰§è¡Œæœç´¢
    // æ³¨ï¼šå°½ç®¡è¿™æ˜¯ä¸€ä¸ªè‹±æ–‡é¡µé¢ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ä¸­æ–‡æŒ‡ä»¤æ§åˆ¶å®ƒ
    await agent.aiAction('åœ¨æœç´¢æ¡†è¾“å…¥ "Headphones" ï¼Œæ•²å›è½¦');
    await sleep(5000);

    // ğŸ‘€ ç†è§£é¡µé¢ï¼Œæå–æ•°æ®
    const items = await agent.aiQuery(
      '{itemTitle: string, price: Number}[], æ‰¾åˆ°åˆ—è¡¨é‡Œçš„å•†å“æ ‡é¢˜å’Œä»·æ ¼',
    );
    console.log("è€³æœºå•†å“ä¿¡æ¯", items);

    // ğŸ‘€ ç”¨ AI æ–­è¨€
    await agent.aiAssert("ç•Œé¢å·¦ä¾§æœ‰ç±»ç›®ç­›é€‰åŠŸèƒ½");

    await browser.close();
  })()
);
```

æ›´å¤š Agent çš„ API è®²è§£è¯·å‚è€ƒ [API å‚è€ƒ](./api.mdx)ã€‚

## ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ

ä½¿ç”¨ `tsx` æ¥è¿è¡Œï¼Œä½ ä¼šçœ‹åˆ°å‘½ä»¤è¡Œæ‰“å°å‡ºäº†è€³æœºçš„å•†å“ä¿¡æ¯ï¼š

```bash
# run
npx tsx demo.ts

# å‘½ä»¤è¡Œåº”è¯¥æœ‰å¦‚ä¸‹è¾“å‡º
#  [
#   {
#     itemTitle: 'JBL Tour Pro 2 - True wireless Noise Cancelling earbuds with Smart Charging Case',
#     price: 551.21
#   },
#   {
#     itemTitle: 'Soundcore Space Oneæ— çº¿è€³æœº40H ANCæ’­æ”¾æ—¶é—´2XStrongerè¯­éŸ³è¿˜åŸ',
#     price: 543.94
#   }
# ]
```

## ç¬¬å››æ­¥ï¼šæŸ¥çœ‹è¿è¡ŒæŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: /path/to/report/some_id.html`ï¼Œ é€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚

## å¦‚ä½•é™åˆ¶é¡µé¢åœ¨å½“å‰ tab æ‰“å¼€

å¦‚æœä½ æƒ³è¦é™åˆ¶é¡µé¢åœ¨å½“å‰ tab æ‰“å¼€ï¼ˆæ¯”å¦‚ç‚¹å‡»ä¸€ä¸ªå¸¦æœ‰ `target="_blank"` å±æ€§çš„é“¾æ¥ï¼‰ï¼Œä½ å¯ä»¥è®¾ç½® `forceSameTabNavigation` é€‰é¡¹ä¸º `true`ï¼š

```typescript
const mid = new PuppeteerAgent(page, {
  forceSameTabNavigation: true,
});
```

## æ›´å¤š

* æ›´å¤š Agent ä¸Šçš„ API æ¥å£è¯·å‚è€ƒ [API å‚è€ƒ](./api.mdx)ã€‚
* æ›´å¤šå…³äºæç¤ºè¯çš„æŠ€å·§è¯·å‚è€ƒ [æç¤ºè¯æŠ€å·§](./prompting-tips)
