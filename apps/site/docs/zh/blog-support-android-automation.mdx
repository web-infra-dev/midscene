# æ”¯æŒ Android è‡ªåŠ¨åŒ–

æˆ‘ä»¬å¾ˆé«˜å…´åœ°å®£å¸ƒï¼šä» Midscene v0.15.0 å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹æ”¯æŒ Android è‡ªåŠ¨åŒ–ï¼

## Demo

è¿™é‡Œæœ‰ä¸€äº› Demoï¼Œå±•ç¤ºäº† Midscene é©±åŠ¨ä¸‹çš„ Android è‡ªåŠ¨åŒ–ï¼š

### åœ°å›¾å¯¼èˆªåˆ°æ™¯ç‚¹

<video src="https://lf3-static.bytednsdoc.com/obj/eden-cn/nupipfups/Midscene/android-maps.mp4" controls/>

### Twitter è‡ªåŠ¨ç‚¹èµ

<video src="https://lf3-static.bytednsdoc.com/obj/eden-cn/nupipfups/Midscene/android-twitter.mp4" controls/>

## é€‚é…æ‰€æœ‰çš„åº”ç”¨

å¯¹äºæˆ‘ä»¬çš„å¼€å‘è€…æ¥è¯´ï¼Œä½ åªéœ€è¦ adb å’Œä¸€ä¸ªè§†è§‰è¯­è¨€ï¼ˆvisual language, VLï¼‰æ¨¡å‹æœåŠ¡ã€‚æ‰€æœ‰çš„å‡†å¤‡å·¥ä½œå°±åšå¥½äº†ï¼

åœ¨è¿è¡ŒæœŸï¼Œæˆ‘ä»¬åˆ©ç”¨ VL æ¨¡å‹çš„è§†è§‰å®šä½èƒ½åŠ›æ¥å®šä½å±å¹•ä¸Šçš„ç›®æ ‡å…ƒç´ ã€‚å› æ­¤ï¼Œæ— è®ºæ˜¯åŸç”Ÿ App è¿˜æ˜¯ Hybrid App ä¸­çš„ webviewï¼Œå®ƒéƒ½æ— å…³ç´§è¦ã€‚å¼€å‘è€…å¯ä»¥ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œè€Œæ— éœ€æ‹…å¿ƒ App æœ¬èº«çš„æŠ€æœ¯æ ˆã€‚

## å¼•å…¥ Midscene çš„å…¨éƒ¨ç‰¹æ€§

å½“ä½¿ç”¨ Midscene è¿›è¡Œ Web è‡ªåŠ¨åŒ–æ—¶ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·å–œæ¬¢ä½¿ç”¨æˆ‘ä»¬çš„ Playground å’Œè¿è¡ŒæŠ¥å‘Šèƒ½åŠ›ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å°†è¿™äº›ç‰¹æ€§å¼•å…¥åˆ° Android è‡ªåŠ¨åŒ–ä¸­ï¼

### ä½¿ç”¨ Playground æ¥è¯•ç”¨ Android è‡ªåŠ¨åŒ–ï¼Œè€Œä¸éœ€è¦å†™ä»»ä½•ä»£ç 

<video src="https://lf3-static.bytednsdoc.com/obj/eden-cn/nupipfups/Midscene/android-playground-lark-en.mp4" poster="/blog/android-playground-lark-poster-en.png" controls/>

### ä½¿ç”¨æŠ¥å‘Šé‡æ”¾æ•´ä¸ªè¿‡ç¨‹

<video src="https://lf3-static.bytednsdoc.com/obj/eden-cn/nupipfups/Midscene/android-ebay.mp4" controls/>

### ä½¿ç”¨ YAML æ–‡ä»¶ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬

```yaml 
# search headphone on ebay, extract the items info into a json file, and assert the shopping cart icon

android:
  deviceId: s4ey59ytbitot4yp

tasks:
  - name: search headphones
    flow:
      - aiAction: open browser and navigate to ebay.com
      - aiAction: type 'Headphones' in ebay search box, hit Enter
      - sleep: 5000
      - aiAction: scroll down the page for 800px

  - name: extract headphones info
    flow:
      - aiQuery: >
          {name: string, price: number, subTitle: string}[], return item name, price and the subTitle on the lower right corner of each item
        name: headphones

  - name: assert Filter button
    flow:
      - aiAssert: There is a Filter button on the page
```

### ä½¿ç”¨ JavaScript SDK æ¥ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬

```ts 
import { AndroidAgent, AndroidDevice, getConnectedDevices } from '@midscene/android';
import "dotenv/config"; // read environment variables from .env file

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    const devices = await getConnectedDevices();
    const page = new AndroidDevice(devices[0].udid);

    // ğŸ‘€ init Midscene agent
    const agent = new AndroidAgent(page,{
      aiActionContext:
        'If any location, permission, user agreement, etc. popup, click agree. If login page pops up, close it.',
    });
    await page.connect();
    await page.launch('https://www.ebay.com');

    await sleep(5000);

    // ğŸ‘€ type keywords, perform a search
    await agent.aiAction('type "Headphones" in search box, hit Enter');

    // ğŸ‘€ wait for the loading
    await agent.aiWaitFor("there is at least one headphone item on page");
    // or you may use a plain sleep:
    // await sleep(5000);

    // ğŸ‘€ understand the page content, find the items
    const items = await agent.aiQuery(
      "{itemTitle: string, price: Number}[], find item in list and corresponding price"
    );
    console.log("headphones in stock", items);

    // ğŸ‘€ assert by AI
    await agent.aiAssert("There is a category filter on the left");
  })()
);

```

### ä½¿ç”¨ä¸¤ç§é£æ ¼çš„ API æ¥æ‰§è¡Œäº¤äº’

è‡ªåŠ¨è§„åˆ’ï¼ˆAuto-planningï¼‰é£æ ¼ï¼š

```javascript
await agent.ai('input "Headphones" in search box, hit Enter');
```

å³æ—¶æ“ä½œï¼ˆInstant Actionsï¼‰é£æ ¼ï¼š

```javascript
await agent.aiInput('Headphones', 'search box');
await agent.aiKeyboardPress('Enter');
```

### ç¤ºä¾‹é¡¹ç›®

æˆ‘ä»¬ä¸º JavaScript SDK å‡†å¤‡äº†ä¸€ä¸ªç¤ºä¾‹é¡¹ç›®ï¼š

[JavaScript ç¤ºä¾‹é¡¹ç›®](https://github.com/web-infra-dev/midscene-example/blob/main/android/javascript-sdk-demo)

å¦‚æœä½ æƒ³è¦ä½¿ç”¨è‡ªåŠ¨åŒ–è¿›è¡Œæµ‹è¯•ï¼Œä½ å¯ä»¥ä½¿ç”¨ JavaScript å’Œ vitestã€‚æˆ‘ä»¬ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ªç¤ºä¾‹é¡¹ç›®ï¼Œæ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š

[Vitest demo project](https://github.com/web-infra-dev/midscene-example/blob/main/android/vitest-demo)

æ­¤å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ yaml æ–‡ä»¶æ¥ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬ï¼š

[YAML ç¤ºä¾‹é¡¹ç›®](https://github.com/web-infra-dev/midscene-example/blob/main/android/yaml-scripts-demo)

## é™åˆ¶

1. æ— æ³•ä½¿ç”¨å…ƒç´ å®šä½çš„ç¼“å­˜åŠŸèƒ½ã€‚ç”±äºæ²¡æœ‰æ”¶é›†è§†å›¾æ ‘ï¼Œæˆ‘ä»¬æ— æ³•ç¼“å­˜å…ƒç´ æ ‡è¯†ç¬¦å¹¶é‡ç”¨å®ƒã€‚
2. ç›®å‰åªæ”¯æŒä¸€äº›å·²çŸ¥çš„ VL æ¨¡å‹ã€‚å¦‚æœä½ æƒ³è¦å¼•å…¥å…¶ä»– VL æ¨¡å‹ï¼Œè¯·è®©æˆ‘ä»¬çŸ¥é“ã€‚
3. è¿è¡Œæ€§èƒ½è¿˜ä¸å¤Ÿå¥½ã€‚æˆ‘ä»¬è¿˜åœ¨åŠªåŠ›æ”¹è¿›å®ƒã€‚
4. VL æ¨¡å‹åœ¨ `.aiQuery` å’Œ `.aiAssert` ä¸­è¡¨ç°ä¸ä½³ã€‚æˆ‘ä»¬å°†åœ¨æœªæ¥æä¾›ä¸€ç§æ–¹æ³•æ¥åˆ‡æ¢æ¨¡å‹ä»¥é€‚åº”ä¸åŒçš„ä»»åŠ¡ã€‚

## è‡´è°¢

æˆ‘ä»¬æƒ³è¦æ„Ÿè°¢ä»¥ä¸‹é¡¹ç›®ï¼š

- [scrcpy](https://github.com/Genymobile/scrcpy) å’Œ [yume-chan](https://github.com/yume-chan) å…è®¸æˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨æ§åˆ¶ Android è®¾å¤‡ã€‚
- [appium-adb](https://github.com/appium/appium-adb) ä¸º adb æä¾›äº† javascript æ¡¥æ¥ã€‚
- [YADB](https://github.com/ysbing/YADB) ä¸ºæ–‡æœ¬è¾“å…¥æä¾›äº†æ€§èƒ½æå‡ã€‚
