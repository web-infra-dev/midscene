import PrepareAndroid from './common/prepare-android.mdx';
import SetupEnv from './common/setup-env.mdx';

# ä¸ Android(adb) é›†æˆ

åœ¨ä½¿ç”¨ adb è¿æ¥ Android è®¾å¤‡åï¼Œä½ å¯ä»¥ä½¿ç”¨ Midscene javascript SDK æ¥æ§åˆ¶ Android è®¾å¤‡ã€‚

import { PackageManagerTabs } from '@theme';

:::info æ ·ä¾‹é¡¹ç›®
ä½¿ç”¨ javascript SDK æ§åˆ¶ Android è®¾å¤‡ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/android/javascript-sdk-demo](https://github.com/web-infra-dev/midscene-example/blob/main/android/javascript-sdk-demo)

ä¸ Vitest é›†æˆå’Œæµ‹è¯•ï¼š[https://github.com/web-infra-dev/midscene-example/tree/main/android/vitest-demo](https://github.com/web-infra-dev/midscene-example/tree/main/android/vitest-demo)
:::

<PrepareAndroid />

<SetupEnv />


## ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

<PackageManagerTabs command="install @midscene/android --save-dev" />

## ç¬¬äºŒæ­¥ï¼šç¼–å†™è„šæœ¬

è¿™é‡Œä»¥ä½¿ç”¨å®‰å“æµè§ˆå™¨æœç´¢è€³æœºä¸ºä¾‹ã€‚(å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è®¾å¤‡ä¸Šçš„å…¶ä»–ä»»ä½•åº”ç”¨)

ç¼–å†™ä¸‹æ–¹ä»£ç ï¼Œä¿å­˜ä¸º `./demo.ts`

```typescript title="./demo.ts"
import { AndroidAgent, AndroidDevice, getConnectedDevices } from '@midscene/android';

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    const devices = await getConnectedDevices();
    const page = new AndroidDevice(devices[0].udid);

    // ğŸ‘€ åˆå§‹åŒ– Midscene agent
    const agent = new AndroidAgent(page,{
      aiActionContext:
        'å¦‚æœå‡ºç°ä½ç½®ã€æƒé™ã€ç”¨æˆ·åè®®ç­‰å¼¹çª—ï¼Œç‚¹å‡»åŒæ„ã€‚å¦‚æœå‡ºç°ç™»å½•é¡µé¢ï¼Œå…³é—­å®ƒã€‚',
    });
    await page.connect();

    // ğŸ‘€ æ‰“å¼€æµè§ˆå™¨å¹¶å¯¼èˆªåˆ° ebay.comï¼ˆè¯·ç¡®ä¿å½“å‰é¡µé¢æœ‰æµè§ˆå™¨ App å–”ï¼‰
    await agent.aiAction('open browser and navigate to ebay.com');

    await sleep(5000);

    // ğŸ‘€ è¾“å…¥å…³é”®è¯ï¼Œæ‰§è¡Œæœç´¢
    await agent.aiAction('åœ¨æœç´¢æ¡†è¾“å…¥ "Headphones" ï¼Œæ•²å›è½¦');

    // ğŸ‘€ ç­‰å¾…åŠ è½½å®Œæˆ
    await agent.aiWaitFor("é¡µé¢ä¸­è‡³å°‘æœ‰ä¸€ä¸ªè€³æœºå•†å“");
    // æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ™®é€šçš„ sleep:
    // await sleep(5000);

    // ğŸ‘€ ç†è§£é¡µé¢å†…å®¹ï¼Œæå–æ•°æ®
    const items = await agent.aiQuery(
      "{itemTitle: string, price: Number}[], æ‰¾åˆ°åˆ—è¡¨é‡Œçš„å•†å“æ ‡é¢˜å’Œä»·æ ¼"
    );
    console.log("è€³æœºå•†å“ä¿¡æ¯", items);

    // ğŸ‘€ ç”¨ AI æ–­è¨€
    await agent.aiAssert("ç•Œé¢å·¦ä¾§æœ‰ç±»ç›®ç­›é€‰åŠŸèƒ½");
  })()
);

```

## ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ

ä½¿ç”¨ `tsx` æ¥è¿è¡Œ

```bash
# run
npx tsx demo.ts
```

ç¨ç­‰ç‰‡åˆ»ï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```log
[
 {
   itemTitle: 'JBL Tour Pro 2 - True wireless Noise Cancelling earbuds with Smart Charging Case',
   price: 551.21
 },
 {
   itemTitle: 'Soundcore Space Oneæ— çº¿è€³æœº40H ANCæ’­æ”¾æ—¶é—´2XStrongerè¯­éŸ³è¿˜åŸ',
   price: 543.94
 }
]
```

## ç¬¬å››æ­¥ï¼šæŸ¥çœ‹è¿è¡ŒæŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: /path/to/report/some_id.html`ï¼Œ é€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚


## `AndroidDevice` çš„æ„é€ å‡½æ•°

AndroidDevice çš„æ„é€ å‡½æ•°æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š

* `deviceId: string` - è®¾å¤‡ id
* `opts?: AndroidDeviceOpt` - å¯é€‰å‚æ•°ï¼Œç”¨äºåˆå§‹åŒ– AndroidDevice çš„é…ç½®
  * `autoDismissKeyboard?: boolean` - å¯é€‰å‚æ•°ï¼Œæ˜¯å¦åœ¨è¾“å…¥æ–‡æœ¬åè‡ªåŠ¨å…³é—­é”®ç›˜ã€‚é»˜è®¤å€¼ä¸º trueã€‚
  * `androidAdbPath?: string` - å¯é€‰å‚æ•°ï¼Œç”¨äºæŒ‡å®š adb å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚
  * `remoteAdbHost?: string` - å¯é€‰å‚æ•°ï¼Œç”¨äºæŒ‡å®šè¿œç¨‹ adb ä¸»æœºã€‚
  * `remoteAdbPort?: number` - å¯é€‰å‚æ•°ï¼Œç”¨äºæŒ‡å®šè¿œç¨‹ adb ç«¯å£ã€‚


## Android Agent ä¸Šçš„æ›´å¤šæ¥å£

é™¤äº† [API å‚è€ƒ](./API) ä¸­çš„é€šç”¨ Agent æ¥å£ï¼ŒAndroidAgent è¿˜æä¾›äº†ä¸€äº›å…¶ä»–æ¥å£ï¼š

### `agent.launch()`

å¯åŠ¨ä¸€ä¸ªç½‘é¡µæˆ–åŸç”Ÿé¡µé¢ã€‚

* ç±»å‹

```typescript
function launch(uri: string): Promise<void>;
```

* å‚æ•°ï¼š
  * `uri: string` - è¦æ‰“å¼€çš„ uriï¼Œå¯ä»¥æ˜¯ç½‘é¡µ url æˆ–åŸç”Ÿ app çš„ package name æˆ– activity nameï¼Œå¦‚æœå­˜åœ¨ activity nameï¼Œåˆ™ä»¥ / åˆ†éš”ï¼ˆä¾‹å¦‚ï¼šcom.android.settings/.Settingsï¼‰

* è¿”å›å€¼ï¼š
  * `Promise<void>`

* ç¤ºä¾‹ï¼š

```typescript
import { AndroidAgent, AndroidDevice } from '@midscene/android';

const page = new AndroidDevice('s4ey59');
const agent = new AndroidAgent(page);

await agent.launch('https://www.ebay.com'); // æ‰“å¼€ç½‘é¡µ
await agent.launch('com.android.settings'); // æ‰“å¼€ç³»ç»Ÿè®¾ç½® app(package name)
await agent.launch('com.android.settings/.Settings'); // æ‰“å¼€ç³»ç»Ÿè®¾ç½® app(package name) çš„ .Settings(activity name) é¡µé¢
```

### `agentFromAdbDevice()`

ä»å·²è¿æ¥çš„ adb è®¾å¤‡ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª AndroidAgentã€‚

* ç±»å‹

```typescript
function agentFromAdbDevice(deviceId?: string, opts?: PageAgentOpt): Promise<AndroidAgent>;
```

* å‚æ•°ï¼š
  * `deviceId?: string` - å¯é€‰å‚æ•°ï¼Œè¦è¿æ¥çš„ adb è®¾å¤‡ idï¼Œå¦‚æœæœªä¼ å…¥ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿æ¥çš„è®¾å¤‡
  * `opts?: PageAgentOpt & AndroidDeviceOpt` - å¯é€‰å‚æ•°ï¼Œç”¨äºåˆå§‹åŒ– AndroidAgent çš„é…ç½®ï¼Œå…¶ä¸­ PageAgentOpt å‚è€ƒ [æ„é€ å™¨](./API)ï¼ŒAndroidDeviceOpt çš„é…ç½®å€¼å‚è€ƒ [AndroidDevice çš„æ„é€ å‡½æ•°](./integrate-with-android#androiddevice-%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0)

* è¿”å›å€¼ï¼š
  * `Promise<AndroidAgent>` è¿”å›ä¸€ä¸ª AndroidAgent å®ä¾‹

* ç¤ºä¾‹ï¼š

```typescript
import { agentFromAdbDevice } from '@midscene/android';

const agent = await agentFromAdbDevice('s4ey59'); // ä¼ å…¥ deviceId
const agent = await agentFromAdbDevice(); // ä¸ä¼ å…¥ deviceIdï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿æ¥çš„è®¾å¤‡
```

### `getConnectedDevices()`

è·å–æ‰€æœ‰è¿æ¥çš„ Android è®¾å¤‡ã€‚

* ç±»å‹

```typescript 
function getConnectedDevices(): Promise<Device[]>;
interface Device {
  /**
   * The device udid.
   */
  udid: string;
  /**
   * Current device state, as it is visible in
   * _adb devices -l_ output.
   */
  state: string;
  port?: number;
}
```

* è¿”å›å€¼ï¼š
  * `Promise<Device[]>` è¿”å›ä¸€ä¸ª Device æ•°ç»„

* ç¤ºä¾‹ï¼š

```typescript
import { agentFromAdbDevice, getConnectedDevices } from '@midscene/android'

const devices = await getConnectedDevices();
console.log(devices);
const agent = await agentFromAdbDevice(devices[0].udid);
```

## æ›´å¤š

* æ›´å¤š Agent ä¸Šçš„ API æ¥å£è¯·å‚è€ƒ [API å‚è€ƒ](./API)ã€‚
* æ›´å¤šå…³äºæç¤ºè¯çš„æŠ€å·§è¯·å‚è€ƒ [æç¤ºè¯æŠ€å·§](./prompting-tips)

## FAQ

### ä¸ºä»€ä¹ˆæˆ‘è¿æ¥äº†è®¾å¤‡ï¼Œä½†æ˜¯é€šè¿‡ adb ä»ç„¶æ— æ³•æ§åˆ¶ï¼Ÿ

è¯·æ£€æŸ¥æ˜¯å¦åœ¨ç³»ç»Ÿè®¾ç½®çš„å¼€å‘è€…é€‰é¡¹ä¸­ï¼Œå¦‚æœå­˜åœ¨ã€USB è°ƒè¯•ï¼ˆå®‰å…¨è®¾ç½®ï¼‰ã€ï¼Œä¹Ÿéœ€è¦å¼€å¯ã€‚

<p align="center">
  <img src="/android-usb-debug.png" alt="android usb debug" width="400"/>
</p>

### å¦‚ä½•ä½¿ç”¨è‡ªå®šä¹‰çš„ adb è·¯å¾„ã€è¿œç¨‹ adb ä¸»æœºå’Œç«¯å£ï¼Ÿ

ä½ å¯ä»¥ä½¿ç”¨ `MIDSCENE_ADB_PATH` ç¯å¢ƒå˜é‡æ¥æŒ‡å®š adb å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ï¼Œ`MIDSCENE_ADB_REMOTE_HOST` ç¯å¢ƒå˜é‡æ¥æŒ‡å®šè¿œç¨‹ adb ä¸»æœºï¼Œ`MIDSCENE_ADB_REMOTE_PORT` ç¯å¢ƒå˜é‡æ¥æŒ‡å®šè¿œç¨‹ adb ç«¯å£ã€‚

```bash
export MIDSCENE_ADB_PATH=/path/to/adb
export MIDSCENE_ADB_REMOTE_HOST=192.168.1.100
export MIDSCENE_ADB_REMOTE_PORT=5037
```

æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ AndroidDevice çš„æ„é€ å‡½æ•°æ¥æŒ‡å®š adb å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€è¿œç¨‹ adb ä¸»æœºå’Œç«¯å£ã€‚

```typescript
const device = new AndroidDevice('s4ey59', {
  androidAdbPath: '/path/to/adb',
  remoteAdbHost: '192.168.1.100',
  remoteAdbPort: 5037,
});
```
