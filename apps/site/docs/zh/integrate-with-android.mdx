# ä¸ Android(adb) é›†æˆ

Midscene æ”¯æŒä½¿ç”¨è§†è§‰è¯­è¨€ï¼ˆVLï¼‰æ¨¡å‹æ¥æ§åˆ¶ Android è®¾å¤‡ã€‚

import { PackageManagerTabs } from '@theme';

:::info æ ·ä¾‹é¡¹ç›®
ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°å‘ Android é›†æˆçš„æ ·ä¾‹é¡¹ç›®ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/android-demo](https://github.com/web-infra-dev/midscene-example/blob/main/android-demo)

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª Android å’Œ Vitest ç»“åˆçš„æ ·ä¾‹é¡¹ç›®ï¼š[https://github.com/web-infra-dev/midscene-example/tree/main/android-with-vitest-demo](https://github.com/web-infra-dev/midscene-example/tree/main/android-with-vitest-demo)
:::

## å‡†å¤‡å·¥ä½œ

### é…ç½® API Key

é…ç½® VL æ¨¡å‹çš„ API Keyã€‚å¦‚æœä½¿ç”¨ qwen-2.5-vlï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹ï¼š

```bash
OPENAI_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"
OPENAI_API_KEY="......"
MIDSCENE_MODEL_NAME="qwen-vl-max-latest"
MIDSCENE_USE_QWEN_VL=1
```

æ§åˆ¶ Android è®¾å¤‡æ—¶ï¼Œä½ åªèƒ½ä½¿ç”¨ VL æ¨¡å‹ã€‚æ›´å¤šè¯¦æƒ…è¯·å‚è€ƒ [é€‰æ‹©æ¨¡å‹](./choose-a-model)ã€‚

### å‡†å¤‡ adb ç¯å¢ƒ

`adb` æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå…è®¸ä½ ä¸ Android è®¾å¤‡é€šä¿¡ã€‚

- æ–¹å¼ä¸€ï¼šä½¿ç”¨ [Android Studio](https://developer.android.com/studio?hl=zh-cn) å®‰è£…
- æ–¹å¼äºŒï¼šä½¿ç”¨ [Android command-line tools](https://developer.android.com/studio#command-line-tools-only) å®‰è£…

éªŒè¯ adb æ˜¯å¦å®‰è£…æˆåŠŸï¼š

```bash
adb --version
```

å½“ä½ çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼Œè¯´æ˜ adb å·²ç»å®‰è£…æˆåŠŸï¼š

```log
Android Debug Bridge version 1.0.41
Version 34.0.4-10411341
Installed as /usr/local/bin//adb
Running on Darwin 24.3.0 (arm64)
```

### ä½¿ç”¨ adb è¿æ¥ Android è®¾å¤‡

åœ¨ç³»ç»Ÿè®¾ç½®çš„å¼€å‘è€…é€‰é¡¹ä¸­ï¼Œå¼€å¯å®‰å“è®¾å¤‡çš„ã€USB è°ƒè¯•ã€ï¼Œå¦‚æœå­˜åœ¨ã€USB è°ƒè¯•ï¼ˆå®‰å…¨è®¾ç½®ï¼‰ã€ï¼Œä¹Ÿéœ€è¦å¼€å¯ï¼Œæ¥ç€ä½¿ç”¨æ•°æ®çº¿è¿æ¥ä¸€å°å®‰å“è®¾å¤‡

<p align="center">
  <img src="/android-usb-debug.png" alt="android usb debug" width="400"/>
</p>

é€šè¿‡ä¸‹é¢å‘½ä»¤ç¡®è®¤å·²ç»è¿æ¥ï¼š

```bash
adb devices -l
```

å½“ä½ çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼Œè¯´æ˜è¿æ¥æˆåŠŸï¼š

```log
List of devices attached
s4ey59	device usb:34603008X product:cezanne model:M2006J device:cezan transport_id:3
```

## ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

<PackageManagerTabs command="install @midscene/android --save-dev" />

## ç¬¬äºŒæ­¥ï¼šç¼–å†™è„šæœ¬

è¿™é‡Œä»¥ä½¿ç”¨å®‰å“æµè§ˆå™¨æœç´¢è€³æœºä¸ºä¾‹ã€‚(å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è®¾å¤‡ä¸Šçš„å…¶ä»–ä»»ä½•åº”ç”¨)

ç¼–å†™ä¸‹æ–¹ä»£ç ï¼Œä¿å­˜ä¸º `./demo.ts`

```typescript title="./demo.ts"
import { AndroidAgent, AndroidDevice, getConnectedDevices } from '@midscene/android';

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    const devices = await getConnectedDevices();
    const page = new AndroidDevice(devices[0].udid);

    // ğŸ‘€ åˆå§‹åŒ– Midscene agent
    const agent = new AndroidAgent(page,{
      aiActionContext:
        'å¦‚æœå‡ºç°ä½ç½®ã€æƒé™ã€ç”¨æˆ·åè®®ç­‰å¼¹çª—ï¼Œç‚¹å‡»åŒæ„ã€‚å¦‚æœå‡ºç°ç™»å½•é¡µé¢ï¼Œå…³é—­å®ƒã€‚',
    });
    await page.connect();

    // ğŸ‘€ æ‰“å¼€æµè§ˆå™¨å¹¶å¯¼èˆªåˆ° ebay.comï¼ˆè¯·ç¡®ä¿å½“å‰é¡µé¢æœ‰æµè§ˆå™¨ App å–”ï¼‰
    await agent.aiAction('open browser and navigate to ebay.com');

    await sleep(5000);

    // ğŸ‘€ è¾“å…¥å…³é”®è¯ï¼Œæ‰§è¡Œæœç´¢
    await agent.aiAction('åœ¨æœç´¢æ¡†è¾“å…¥ "Headphones" ï¼Œæ•²å›è½¦');

    // ğŸ‘€ ç­‰å¾…åŠ è½½å®Œæˆ
    await agent.aiWaitFor("é¡µé¢ä¸­è‡³å°‘æœ‰ä¸€ä¸ªè€³æœºå•†å“");
    // æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ™®é€šçš„ sleep:
    // await sleep(5000);

    // ğŸ‘€ ç†è§£é¡µé¢å†…å®¹ï¼Œæå–æ•°æ®
    const items = await agent.aiQuery(
      "{itemTitle: string, price: Number}[], æ‰¾åˆ°åˆ—è¡¨é‡Œçš„å•†å“æ ‡é¢˜å’Œä»·æ ¼"
    );
    console.log("è€³æœºå•†å“ä¿¡æ¯", items);

    // ğŸ‘€ ç”¨ AI æ–­è¨€
    await agent.aiAssert("ç•Œé¢å·¦ä¾§æœ‰ç±»ç›®ç­›é€‰åŠŸèƒ½");
  })()
);

```

## ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ

ä½¿ç”¨ `tsx` æ¥è¿è¡Œ

```bash
# run
npx tsx demo.ts
```

ç¨ç­‰ç‰‡åˆ»ï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```log
[
 {
   itemTitle: 'JBL Tour Pro 2 - True wireless Noise Cancelling earbuds with Smart Charging Case',
   price: 551.21
 },
 {
   itemTitle: 'Soundcore Space Oneæ— çº¿è€³æœº40H ANCæ’­æ”¾æ—¶é—´2XStrongerè¯­éŸ³è¿˜åŸ',
   price: 543.94
 }
]
```

## ç¬¬å››æ­¥ï¼šæŸ¥çœ‹è¿è¡ŒæŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: /path/to/report/some_id.html`ï¼Œ é€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚

## Android Agent ä¸Šçš„æ›´å¤šæ¥å£

é™¤äº† [API å‚è€ƒ](./API) ä¸­çš„é€šç”¨ Agent æ¥å£ï¼ŒAndroidAgent è¿˜æä¾›äº†ä¸€äº›å…¶ä»–æ¥å£ï¼š

### `agent.launch()`

å¯åŠ¨ä¸€ä¸ªç½‘é¡µæˆ–åŸç”Ÿé¡µé¢ã€‚

* ç±»å‹

```typescript
function launch(uri: string): Promise<void>;
```

* å‚æ•°ï¼š
  * `uri: string` - è¦æ‰“å¼€çš„ uriï¼Œå¯ä»¥æ˜¯ç½‘é¡µ url æˆ–åŸç”Ÿ app çš„ package name æˆ– activity nameï¼Œå¦‚æœå­˜åœ¨ activity nameï¼Œåˆ™ä»¥ / åˆ†éš”ï¼ˆä¾‹å¦‚ï¼šcom.android.settings/.Settingsï¼‰

* è¿”å›å€¼ï¼š
  * `Promise<void>`

* ç¤ºä¾‹ï¼š

```typescript
import { AndroidAgent, AndroidDevice } from '@midscene/android';

const page = new AndroidDevice('s4ey59ytbitot4yp');
const agent = new AndroidAgent(page);

await agent.launch('https://www.ebay.com'); // æ‰“å¼€ç½‘é¡µ
await agent.launch('com.android.settings'); // æ‰“å¼€ç³»ç»Ÿè®¾ç½® app(package name)
await agent.launch('com.android.settings/.Settings'); // æ‰“å¼€ç³»ç»Ÿè®¾ç½® app(package name) çš„ .Settings(activity name) é¡µé¢
```

### `agentFromAdbDevice()`

ä»å·²è¿æ¥çš„ adb è®¾å¤‡ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª AndroidAgentã€‚

* ç±»å‹

```typescript
function agentFromAdbDevice(deviceId?: string, opts?: PageAgentOpt): Promise<AndroidAgent>;
```

* å‚æ•°ï¼š
  * `deviceId?: string` - å¯é€‰å‚æ•°ï¼Œè¦è¿æ¥çš„ adb è®¾å¤‡ idï¼Œå¦‚æœæœªä¼ å…¥ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿æ¥çš„è®¾å¤‡
  * `opts?: PageAgentOpt` - å¯é€‰å‚æ•°ï¼Œç”¨äºåˆå§‹åŒ– AndroidAgent çš„é…ç½®ï¼Œå‚è€ƒ [æ„é€ å™¨](./API)

* è¿”å›å€¼ï¼š
  * `Promise<AndroidAgent>` è¿”å›ä¸€ä¸ª AndroidAgent å®ä¾‹

* ç¤ºä¾‹ï¼š

```typescript
import { agentFromAdbDevice } from '@midscene/android';

const agent = await agentFromAdbDevice('s4ey59ytbitot4yp'); // ä¼ å…¥ deviceId
const agent = await agentFromAdbDevice(); // ä¸ä¼ å…¥ deviceIdï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿æ¥çš„è®¾å¤‡
```

### `getConnectedDevices()`

è·å–æ‰€æœ‰è¿æ¥çš„ Android è®¾å¤‡ã€‚

* ç±»å‹

```typescript 
function getConnectedDevices(): Promise<Device[]>;
interface Device {
  /**
   * The device udid.
   */
  udid: string;
  /**
   * Current device state, as it is visible in
   * _adb devices -l_ output.
   */
  state: string;
  port?: number;
}
```

* è¿”å›å€¼ï¼š
  * `Promise<Device[]>` è¿”å›ä¸€ä¸ª Device æ•°ç»„

* ç¤ºä¾‹ï¼š

```typescript
import { agentFromAdbDevice, getConnectedDevices } from '@midscene/android'

const devices = await getConnectedDevices();
console.log(devices);
const agent = await agentFromAdbDevice(devices[0].udid);
```

## æ›´å¤š

* æ›´å¤š Agent ä¸Šçš„ API æ¥å£è¯·å‚è€ƒ [API å‚è€ƒ](./API)ã€‚
* æ›´å¤šå…³äºæç¤ºè¯çš„æŠ€å·§è¯·å‚è€ƒ [æç¤ºè¯æŠ€å·§](./prompting-tips)

## FAQ

### ä¸ºä»€ä¹ˆæˆ‘è¿æ¥äº†è®¾å¤‡ï¼Œä½†æ˜¯é€šè¿‡ adb ä»ç„¶æ— æ³•æ§åˆ¶ï¼Ÿ

è¯·æ£€æŸ¥æ˜¯å¦åœ¨ç³»ç»Ÿè®¾ç½®çš„å¼€å‘è€…é€‰é¡¹ä¸­ï¼Œå¦‚æœå­˜åœ¨ã€USB è°ƒè¯•ï¼ˆå®‰å…¨è®¾ç½®ï¼‰ã€ï¼Œä¹Ÿéœ€è¦å¼€å¯ã€‚

<p align="center">
  <img src="/android-usb-debug.png" alt="android usb debug" width="400"/>
</p>

### ä¸ºä»€ä¹ˆæˆ‘è¿æ¥äº†è®¾å¤‡ï¼Œä½†æ˜¯é€šè¿‡ `adb devices -l` å‘½ä»¤çœ‹ä¸åˆ°è®¾å¤‡ï¼Ÿ

[è¿æ¥è®¾å¤‡](./integrate-with-android#ä½¿ç”¨-adb-è¿æ¥-android-è®¾å¤‡) æ—¶ï¼Œè¯·ç¡®ä¿è®¾å¤‡å¤„äºè§£é”çŠ¶æ€ã€‚