import SetupEnv from './common/setup-env.mdx';

# ä¸ iOS(WebDriverAgent) é›†æˆ

åœ¨ä½¿ç”¨ WebDriverAgent è¿æ¥ iOS è®¾å¤‡åï¼Œä½ å¯ä»¥ä½¿ç”¨ Midscene javascript SDK æ¥æ§åˆ¶ iOS è®¾å¤‡ã€‚

import { PackageManagerTabs } from '@theme';

:::info æ ·ä¾‹é¡¹ç›®
ä½¿ç”¨ javascript SDK æ§åˆ¶ iOS è®¾å¤‡ï¼š[https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo](https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo)

ä¸ Vitest é›†æˆå’Œæµ‹è¯•ï¼š[https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo](https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo)
:::

## å‡†å¤‡ç¯å¢ƒ

åœ¨å¼€å§‹ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆè®¾ç½® iOS å¼€å‘ç¯å¢ƒï¼š

### å‰ç½®è¦æ±‚

- **macOS**ï¼ˆiOS å¼€å‘å¿…éœ€ï¼‰
- **Xcode** å’Œ Xcode å‘½ä»¤è¡Œå·¥å…·
- **iOS æ¨¡æ‹Ÿå™¨** æˆ–çœŸæœºè®¾å¤‡
- **WebDriverAgent**ï¼ˆè‡ªåŠ¨åŒ–å¿…éœ€ï¼‰

### 1. åŸºç¡€ç¯å¢ƒå®‰è£…

```bash
# å®‰è£… Xcode å‘½ä»¤è¡Œå·¥å…·
xcode-select --install

# éªŒè¯ simctl å¯ç”¨ï¼ˆæ¨¡æ‹Ÿå™¨éœ€è¦ï¼‰
xcrun simctl list devices

# å®‰è£… libimobiledeviceï¼ˆçœŸæœºè®¾å¤‡éœ€è¦ï¼‰
brew install libimobiledevice
```

### 2. WebDriverAgent è®¾ç½®

Midscene iOS ä½¿ç”¨ WebDriverAgent è¿›è¡Œè®¾å¤‡è‡ªåŠ¨åŒ–ã€‚ä½ éœ€è¦åœ¨ä½¿ç”¨åº“ä¹‹å‰å‡†å¤‡ WebDriverAgentï¼š

#### æ¨¡æ‹Ÿå™¨è®¾ç½®

1. **å®‰è£… WebDriverAgent ä¾èµ–**ï¼š
   ```bash
   npm install appium-webdriveragent
   ```

2. **æ„å»ºå¹¶å¯åŠ¨ WebDriverAgent**ï¼š
   ```bash
   # è¿›å…¥ WebDriverAgent é¡¹ç›®ç›®å½•
   cd node_modules/appium-webdriveragent

   # ä¸ºæ¨¡æ‹Ÿå™¨æ„å»ºå¹¶è¿è¡Œï¼ˆä»¥ iPhone 15 ä¸ºä¾‹ï¼‰
   xcodebuild -project WebDriverAgent.xcodeproj \
             -scheme WebDriverAgentRunner \
             -destination 'platform=iOS Simulator,name=iPhone 15' \
             test
   ```

#### çœŸæœºè®¾å¤‡è®¾ç½®

1. **é…ç½®å¼€å‘å›¢é˜Ÿ**ï¼š
   åœ¨ Xcode ä¸­æ‰“å¼€ `node_modules/appium-webdriveragent/WebDriverAgent.xcodeproj`ï¼Œå‚è€ƒä¸‹é¢æ–‡æ¡£ä¸ºä½ çš„ iOS çœŸæœºæ„å»ºåº”ç”¨ï¼š[Real Device Configuration](https://appium.github.io/appium-xcuitest-driver/4.25/real-device-config) å’Œ [WebDriverAgent](https://appium.github.io/appium-xcuitest-driver/4.25/wda-custom-server)


2. **æ„å»ºå¹¶éƒ¨ç½²åˆ°è®¾å¤‡**ï¼š
   ```bash
   # å°† YOUR_DEVICE_UDID æ›¿æ¢ä¸ºä½ çš„è®¾å¤‡ UDID
   xcodebuild -project WebDriverAgent.xcodeproj \
             -scheme WebDriverAgentRunner \
             -destination 'id=YOUR_DEVICE_UDID' \
             test
   ```

3. **ä¿¡ä»»å¼€å‘è€…è¯ä¹¦**ï¼š
   - åœ¨ iOS è®¾å¤‡ä¸Šï¼Œè¿›å…¥ è®¾ç½® > é€šç”¨ > VPN ä¸è®¾å¤‡ç®¡ç†
   - ä¿¡ä»»ä½ çš„å¼€å‘è€…è¯ä¹¦

4. **å¯ç”¨å¼€å‘è€…æ¨¡å¼å’Œ UI è‡ªåŠ¨åŒ–**ï¼š
   - è¿›å…¥ è®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > å¼€å‘è€…æ¨¡å¼ï¼Œå¼€å¯å¹¶é‡å¯è®¾å¤‡
   - è¿›å…¥ è®¾ç½® > å¼€å‘è€… > UI è‡ªåŠ¨åŒ–ï¼Œå¯ç”¨ UI è‡ªåŠ¨åŒ–

5. **è®¾ç½®ç«¯å£è½¬å‘ï¼ˆçœŸæœºè®¾å¤‡ï¼‰**ï¼š
   ```bash
   # å°†æœ¬åœ°ç«¯å£ 8100 è½¬å‘åˆ°è®¾å¤‡ç«¯å£ 8100
   iproxy 8100 8100 YOUR_DEVICE_UDID
   ```

   ä¿æŒæ­¤å‘½ä»¤åœ¨å•ç‹¬çš„ç»ˆç«¯çª—å£ä¸­è¿è¡Œã€‚

#### é«˜çº§è®¾ç½®æ–¹æ³•

æ›´å¤šé«˜çº§è®¾ç½®é€‰é¡¹å’Œæ•…éšœæ’é™¤ï¼Œè¯·å‚è€ƒå®˜æ–¹ WebDriverAgent æ–‡æ¡£ï¼š
**ğŸ“– [WebDriverAgent è®¾ç½®æŒ‡å—](https://appium.github.io/appium-xcuitest-driver/4.25/wda-custom-server/)**

<SetupEnv />

## ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

<PackageManagerTabs command="install @midscene/ios --save-dev" />

## ç¬¬äºŒæ­¥ï¼šç¼–å†™è„šæœ¬

è¿™é‡Œä»¥ä½¿ç”¨ iOS Safari æµè§ˆå™¨æœç´¢è€³æœºä¸ºä¾‹ã€‚

ç¼–å†™ä¸‹æ–¹ä»£ç ï¼Œä¿å­˜ä¸º `./demo.ts`

```typescript title="./demo.ts"
import {
  IOSAgent,
  IOSDevice,
  getConnectedDevices,
} from '@midscene/ios';

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    const devices = await getConnectedDevices();
    const page = new IOSDevice(devices[0].udid, {
      wdaPort: 8100,
      wdaHost: 'localhost',
    });

    // ğŸ‘€ åˆå§‹åŒ– Midscene agent
    const agent = new IOSAgent(page, {
      aiActionContext:
        'å¦‚æœå‡ºç°ä½ç½®ã€æƒé™ã€ç”¨æˆ·åè®®ç­‰å¼¹çª—ï¼Œç‚¹å‡»åŒæ„ã€‚å¦‚æœå‡ºç°ç™»å½•é¡µé¢ï¼Œå…³é—­å®ƒã€‚',
    });
    await page.connect();

    // ğŸ‘€ æ‰“å¼€ ebay.com ç½‘é¡µ
    await page.launch('https://ebay.com');
    await sleep(3000);

    // ğŸ‘€ è¾“å…¥å…³é”®è¯ï¼Œæ‰§è¡Œæœç´¢
    await agent.aiAction('åœ¨æœç´¢æ¡†è¾“å…¥ "Headphones" ï¼Œæ•²å›è½¦');

    // ğŸ‘€ ç­‰å¾…åŠ è½½å®Œæˆ
    await agent.aiWaitFor('é¡µé¢ä¸­è‡³å°‘æœ‰ä¸€ä¸ªè€³æœºå•†å“');
    // æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ™®é€šçš„ sleep:
    // await sleep(5000);

    // ğŸ‘€ ç†è§£é¡µé¢å†…å®¹ï¼Œæå–æ•°æ®
    const items = await agent.aiQuery(
      '{itemTitle: string, price: Number}[], æ‰¾åˆ°åˆ—è¡¨é‡Œçš„å•†å“æ ‡é¢˜å’Œä»·æ ¼',
    );
    console.log('è€³æœºå•†å“ä¿¡æ¯', items);

    // ğŸ‘€ ç”¨ AI æ–­è¨€
    await agent.aiAssert('ç•Œé¢ä¸­æœ‰å¤šä¸ªè€³æœºäº§å“');

    await page.destroy();
  })(),
);
```

## ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ

ä½¿ç”¨ `tsx` æ¥è¿è¡Œ

```bash
# run
npx tsx demo.ts
```

ç¨ç­‰ç‰‡åˆ»ï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```log
[
 {
   itemTitle: 'AirPods Pro (2nd generation) with MagSafe Charging Case (USB-C)',
   price: 249
 },
 {
   itemTitle: 'Sony WH-1000XM4 Wireless Premium Noise Canceling Overhead Headphones',
   price: 278
 }
]
```

## ç¬¬å››æ­¥ï¼šæŸ¥çœ‹è¿è¡ŒæŠ¥å‘Š

å½“ä¸Šé¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š`Midscene - report file updated: /path/to/report/some_id.html`ï¼Œ é€šè¿‡æµè§ˆå™¨æ‰“å¼€è¯¥æ–‡ä»¶å³å¯çœ‹åˆ°æŠ¥å‘Šã€‚

## `IOSDevice` çš„æ„é€ å‡½æ•°

IOSDevice çš„æ„é€ å‡½æ•°æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š

- `udid: string` - è®¾å¤‡ UDID æˆ–æ¨¡æ‹Ÿå™¨æ ‡è¯†ç¬¦
- `opts?: IOSDeviceOpt` - å¯é€‰å‚æ•°ï¼Œç”¨äºåˆå§‹åŒ– IOSDevice çš„é…ç½®
  - `wdaPort?: number` - å¯é€‰å‚æ•°ï¼ŒWebDriverAgent ç«¯å£ã€‚é»˜è®¤å€¼ä¸º 8100ã€‚
  - `wdaHost?: string` - å¯é€‰å‚æ•°ï¼ŒWebDriverAgent ä¸»æœºã€‚é»˜è®¤å€¼ä¸º 'localhost'ã€‚
  - `autoDismissKeyboard?: boolean` - å¯é€‰å‚æ•°ï¼Œæ˜¯å¦åœ¨è¾“å…¥æ–‡æœ¬åè‡ªåŠ¨å…³é—­é”®ç›˜ã€‚é»˜è®¤å€¼ä¸º trueã€‚
  - `keyboardDismissStrategy?: 'done-first' | 'escape-first'` - å¯é€‰å‚æ•°ï¼Œå…³é—­é”®ç›˜çš„ç­–ç•¥ã€‚'done-first' ä¼˜å…ˆå°è¯• Done é”®ï¼Œå¦‚æœé”®ç›˜ä»å­˜åœ¨åˆ™å°è¯• Escape é”®ã€‚'escape-first' ä¼˜å…ˆå°è¯• Escape é”®ï¼Œå¦‚æœé”®ç›˜ä»å­˜åœ¨åˆ™å°è¯• Done é”®ã€‚é»˜è®¤å€¼ä¸º 'done-first'ã€‚
  - `customActions?: DeviceAction<any>[]` - å¯é€‰å‚æ•°ï¼Œè‡ªå®šä¹‰è®¾å¤‡åŠ¨ä½œåˆ—è¡¨ã€‚

## iOS Agent ä¸Šçš„æ›´å¤šæ¥å£

é™¤äº† [API å‚è€ƒ](./api.mdx) ä¸­çš„é€šç”¨ Agent æ¥å£ï¼ŒIOSAgent è¿˜æä¾›äº†ä¸€äº›å…¶ä»–æ¥å£ï¼š

### `agent.launch()`

å¯åŠ¨ä¸€ä¸ªç½‘é¡µæˆ–åŸç”Ÿ iOS åº”ç”¨ã€‚

- ç±»å‹

```typescript
function launch(uri: string): Promise<void>;
```

- å‚æ•°ï¼š

  - `uri: string` - è¦æ‰“å¼€çš„ uriï¼Œå¯ä»¥æ˜¯ç½‘é¡µ urlã€åŸç”Ÿ app çš„ bundle identifier æˆ–è‡ªå®šä¹‰ URL scheme

- è¿”å›å€¼ï¼š

  - `Promise<void>`

- ç¤ºä¾‹ï¼š

```typescript
import { IOSAgent, IOSDevice } from '@midscene/ios';

const page = new IOSDevice('00008120-001234567890123E');
const agent = new IOSAgent(page);

await agent.launch('https://www.apple.com'); // æ‰“å¼€ç½‘é¡µ
await agent.launch('com.apple.mobilesafari'); // å¯åŠ¨ Safari
await agent.launch('com.apple.Preferences'); // å¯åŠ¨è®¾ç½®åº”ç”¨
await agent.launch('myapp://profile/user/123'); // æ‰“å¼€åº”ç”¨æ·±åº¦é“¾æ¥
await agent.launch('tel:+1234567890'); // æ‹¨æ‰“ç”µè¯
await agent.launch('mailto:example@email.com'); // å‘é€é‚®ä»¶
```

### `agentFromIOSDevice()`

ä»å·²è¿æ¥çš„ iOS è®¾å¤‡ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª IOSAgentã€‚

- ç±»å‹

```typescript
function agentFromIOSDevice(
  udid?: string,
  opts?: PageAgentOpt,
): Promise<IOSAgent>;
```

- å‚æ•°ï¼š

  - `udid?: string` - å¯é€‰å‚æ•°ï¼Œè¦è¿æ¥çš„ iOS è®¾å¤‡ UDIDï¼Œå¦‚æœæœªä¼ å…¥ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿æ¥çš„è®¾å¤‡
  - `opts?: PageAgentOpt & IOSDeviceOpt` - å¯é€‰å‚æ•°ï¼Œç”¨äºåˆå§‹åŒ– IOSAgent çš„é…ç½®ï¼Œå…¶ä¸­ PageAgentOpt å‚è€ƒ [æ„é€ å™¨](./api.mdx)ï¼ŒIOSDeviceOpt çš„é…ç½®å€¼å‚è€ƒ [IOSDevice çš„æ„é€ å‡½æ•°](./integrate-with-ios#iosdevice-%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0)

- è¿”å›å€¼ï¼š

  - `Promise<IOSAgent>` è¿”å›ä¸€ä¸ª IOSAgent å®ä¾‹

- ç¤ºä¾‹ï¼š

```typescript
import { agentFromIOSDevice } from '@midscene/ios';

const agent = await agentFromIOSDevice('00008120-001234567890123E'); // ä¼ å…¥ UDID
const agent = await agentFromIOSDevice(); // ä¸ä¼ å…¥ UDIDï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿æ¥çš„è®¾å¤‡
```

### `getConnectedDevices()`

è·å–æ‰€æœ‰è¿æ¥çš„ iOS è®¾å¤‡å’Œæ¨¡æ‹Ÿå™¨ã€‚

- ç±»å‹

```typescript
function getConnectedDevices(): Promise<Device[]>;
interface Device {
  /**
   * The device udid or simulator identifier.
   */
  udid: string;
  /**
   * Device name
   */
  name: string;
  /**
   * Device type: 'device' for real device, 'simulator' for simulator
   */
  type: 'device' | 'simulator';
}
```

- è¿”å›å€¼ï¼š

  - `Promise<Device[]>` è¿”å›ä¸€ä¸ª Device æ•°ç»„

- ç¤ºä¾‹ï¼š

```typescript
import { agentFromIOSDevice, getConnectedDevices } from '@midscene/ios';

const devices = await getConnectedDevices();
console.log(devices);
const agent = await agentFromIOSDevice(devices[0].udid);
```

## æ‰©å±•è‡ªå®šä¹‰äº¤äº’åŠ¨ä½œ

ä½¿ç”¨ `customActions` é€‰é¡¹ï¼Œç»“åˆ `defineAction` å®šä¹‰çš„è‡ªå®šä¹‰äº¤äº’åŠ¨ä½œï¼Œå¯ä»¥æ‰©å±• Agent çš„åŠ¨ä½œç©ºé—´ã€‚è¿™äº›åŠ¨ä½œä¼šè¿½åŠ åœ¨å†…ç½®åŠ¨ä½œä¹‹åï¼Œæ–¹ä¾¿ Agent åœ¨è§„åˆ’é˜¶æ®µè°ƒç”¨ã€‚

```typescript
import { getMidsceneLocationSchema, z } from '@midscene/core';
import { defineAction } from '@midscene/core/device';
import { IOSAgent, IOSDevice } from '@midscene/ios';

const ContinuousClick = defineAction({
  name: 'continuousClick',
  description: 'Click the same target repeatedly',
  paramSchema: z.object({
    locate: getMidsceneLocationSchema(),
    count: z
      .number()
      .int()
      .positive()
      .describe('How many times to click'),
  }),
  async call(param) {
    const { locate, count } = param;
    console.log('click target center', locate.center);
    console.log('click count', count);
    // åœ¨è¿™é‡Œç»“åˆ locate + count å®ç°è‡ªå®šä¹‰ç‚¹å‡»é€»è¾‘
  },
});

const page = new IOSDevice('your-device-udid');
const agent = new IOSAgent(page, {
  customActions: [ContinuousClick],
});

await agent.aiAction('ç‚¹å‡»çº¢è‰²æŒ‰é’®äº”æ¬¡');
```

æ›´å¤šå…³äºè‡ªå®šä¹‰åŠ¨ä½œçš„ç»†èŠ‚ï¼Œè¯·å‚è€ƒ [é›†æˆåˆ°ä»»æ„ç•Œé¢](./integrate-with-any-interface)ã€‚

## æ›´å¤š

- æ›´å¤š Agent ä¸Šçš„ API æ¥å£è¯·å‚è€ƒ [API å‚è€ƒ](./api.mdx)ã€‚
- æ›´å¤šå…³äºæç¤ºè¯çš„æŠ€å·§è¯·å‚è€ƒ [æç¤ºè¯æŠ€å·§](./prompting-tips)

## FAQ

### ä¸ºä»€ä¹ˆæˆ‘è¿æ¥äº†è®¾å¤‡ï¼Œä½†æ˜¯é€šè¿‡ WebDriverAgent ä»ç„¶æ— æ³•æ§åˆ¶ï¼Ÿ

è¯·æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **å¼€å‘è€…æ¨¡å¼**ï¼šç¡®ä¿åœ¨è®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > å¼€å‘è€…æ¨¡å¼ ä¸­å·²å¼€å¯
2. **UI è‡ªåŠ¨åŒ–**ï¼šç¡®ä¿åœ¨è®¾ç½® > å¼€å‘è€… > UI è‡ªåŠ¨åŒ–ï¼Œå¯ç”¨ UI è‡ªåŠ¨åŒ–
3. **è®¾å¤‡ä¿¡ä»»**ï¼šç¡®ä¿è®¾å¤‡å·²ä¿¡ä»»å½“å‰ Mac

### æ¨¡æ‹Ÿå™¨å’ŒçœŸæœºæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç‰¹æ€§ | çœŸæœº | æ¨¡æ‹Ÿå™¨ |
|------|------|---------|
| ç«¯å£è½¬å‘ | éœ€è¦ iproxy | ä¸éœ€è¦ |
| å¼€å‘è€…æ¨¡å¼ | éœ€è¦å¯ç”¨ | è‡ªåŠ¨å¯ç”¨ |
| UI è‡ªåŠ¨åŒ–è®¾ç½® | éœ€è¦æ‰‹åŠ¨å¯ç”¨ | è‡ªåŠ¨å¯ç”¨ |
| æ€§èƒ½ | çœŸå®è®¾å¤‡æ€§èƒ½ | ä¾èµ– Mac æ€§èƒ½ |
| ä¼ æ„Ÿå™¨ | çœŸå®ç¡¬ä»¶ | æ¨¡æ‹Ÿæ•°æ® |

### å¦‚ä½•ä½¿ç”¨è‡ªå®šä¹‰çš„ WebDriverAgent ç«¯å£å’Œä¸»æœºï¼Ÿ

ä½ å¯ä»¥é€šè¿‡ IOSDevice çš„æ„é€ å‡½æ•°æ¥æŒ‡å®š WebDriverAgent çš„ç«¯å£å’Œä¸»æœºï¼š

```typescript
const device = new IOSDevice('00008120-001234567890123E', {
  wdaPort: 8200,        // è‡ªå®šä¹‰ç«¯å£
  wdaHost: '192.168.1.100', // è‡ªå®šä¹‰ä¸»æœº
});
```

å¯¹äºè¿œç¨‹è®¾å¤‡ï¼Œè¿˜éœ€è¦ç›¸åº”åœ°è®¾ç½®ç«¯å£è½¬å‘ï¼š

```bash
iproxy -u DEVICE_UDID 8200:8100
```