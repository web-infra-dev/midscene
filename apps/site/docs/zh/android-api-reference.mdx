# API 参考（Android）

当你需要自定义设备行为、把 Midscene 接入框架，或排查 adb 问题时，请查阅本节。关于通用构造函数（报告、Hook、缓存等）的参数说明，请参考平台无关的 [API 参考](./api) 以及 [Prompting tips](./prompting-tips)。

## AndroidDevice {#androiddevice}

创建一个可供 AndroidAgent 驱动的 adb 设备实例。

### 导入

```ts
import { AndroidDevice, getConnectedDevices } from '@midscene/android';
```

### 构造函数

```ts
const device = new AndroidDevice(deviceId, {
  // 设备参数...
});
```

### 设备选项

- `deviceId: string` —— 来自 `adb devices` 或 `getConnectedDevices()` 的值。
- `autoDismissKeyboard?: boolean` —— 输入完成后自动隐藏键盘，默认 `true`。
- `keyboardDismissStrategy?: 'esc-first' | 'back-first'` —— 关闭键盘的顺序，默认 `'esc-first'`。
- `androidAdbPath?: string` —— adb 可执行文件的自定义路径。
- `remoteAdbHost?: string` / `remoteAdbPort?: number` —— 指向远程 adb server。
- `imeStrategy?: 'always-yadb' | 'yadb-for-non-ascii'` —— 控制何时调用 [yadb](https://github.com/ysbing/YADB) 进行文本输入，默认 `'yadb-for-non-ascii'`。
- `displayId?: number` —— 在设备镜像多个屏幕时，选择特定虚拟屏幕。
- `screenshotResizeScale?: number` —— 在发送给模型前对截图进行缩放，默认 `1 / devicePixelRatio`。
- `alwaysRefreshScreenInfo?: boolean` —— 每一步都重新查询旋转角度与屏幕尺寸，默认 `false`。

### 使用说明

:::info
- 使用 `getConnectedDevices()` 发现设备，`udid` 与 `adb devices` 输出一致。
- 通过 `remoteAdbHost/remoteAdbPort` 支持远程 adb；如果 adb 不在 PATH 中，可设置 `androidAdbPath`。
:::

### 示例

#### 快速开始

```ts
import { AndroidAgent, AndroidDevice, getConnectedDevices } from '@midscene/android';

const [first] = await getConnectedDevices();
const device = new AndroidDevice(first.udid);
await device.connect();

const agent = new AndroidAgent(device, {
  aiActionContext: 'If a permissions dialog appears, accept it.',
});

await agent.launch('https://www.ebay.com');
await agent.aiAct('search "Headphones" and wait for results');
const items = await agent.aiQuery(
  '{itemTitle: string, price: number}[], find item in list and corresponding price',
);
console.log(items);
```

#### 启动原生 App

```ts
await agent.launch('com.android.settings/.Settings');
await agent.back();
await agent.home();
```

## AndroidAgent {#androidagent}

将 Midscene 的 AI 规划能力绑定到 AndroidDevice，实现 UI 自动化。

### 导入

```ts
import { AndroidAgent } from '@midscene/android';
```

### 构造函数

```ts
const agent = new AndroidAgent(device, {
  // 通用 Agent 参数...
});
```

### Android 特有选项

- `customActions?: DeviceAction[]` —— 通过 `defineAction` 扩展规划器的可用动作。
- 其余字段与 [API constructors](./api#common-parameters) 一致：`generateReport`、`reportFileName`、`aiActionContext`、`modelConfig`、`cacheId`、`createOpenAIClient`、`onTaskStartTip` 等。

### 使用说明

:::info
- 一个设备连接对应一个 Agent。
- `launch`、`runAdbShell` 等 Android 专属辅助函数也可在 YAML 脚本中使用，语法见 [Android 平台特定动作](./automate-with-scripts-in-yaml#the-android-part)。
- 通用交互方法请查阅 [API 参考（通用）](./api#interaction-methods)。
:::

### Android 特有方法

#### `agent.launch()`

启动网页或原生 Android activity/package。

```ts
function launch(uri: string): Promise<void>;
```

- `uri: string` —— 可以是网页 URL，也可以是 `package/.Activity` 形式的字符串，例如 `com.android.settings/.Settings`。

#### `agent.runAdbShell()`

通过连接的设备运行原始的 `adb shell` 命令。

```ts
function runAdbShell(command: string): Promise<string>;
```

- `command: string` —— 原样传递给 `adb shell` 的命令。

```ts
const result = await agent.runAdbShell('dumpsys battery');
console.log(result);
```

#### 导航辅助

- `agent.back(): Promise<void>` —— 触发 Android 系统的返回操作。
- `agent.home(): Promise<void>` —— 返回桌面。
- `agent.recentApps(): Promise<void>` —— 打开多任务/最近应用界面。

### 辅助工具

#### `agentFromAdbDevice()`

从任意已连接的 adb 设备创建 `AndroidAgent`。

```ts
function agentFromAdbDevice(
  deviceId?: string,
  opts?: PageAgentOpt & AndroidDeviceOpt,
): Promise<AndroidAgent>;
```

- `deviceId?: string` —— 连接特定设备；留空表示使用“第一个可用设备”。
- `opts?: PageAgentOpt & AndroidDeviceOpt` —— 在一个对象中合并 Agent 选项与 [`AndroidDevice`](#androiddevice) 的设置。

#### `getConnectedDevices()`

列举 Midscene 可驱动的 adb 设备。

```ts
function getConnectedDevices(): Promise<Array<{
  udid: string;
  state: string;
  port?: number;
}>>;
```

### 相关阅读

- [Android 快速开始](./android-getting-started) 获取搭建与脚本示例。
