# API reference

## Constructors

Midscene ships multiple agents tuned for specific automation environments. Every constructor takes the target page/device plus a shared options bag (reporting, caching, AI configuration, hooks), and then layers on platform-only switches such as navigation guards in browsers or ADB wiring on Android. Use the sections below to review the import path and platform-specific parameters for each agent:

- In Puppeteer, use [PuppeteerAgent](#puppeteer-agent)
- In Playwright, use [PlaywrightAgent](#playwright-agent)
- In Bridge Mode, use [AgentOverChromeBridge](#chrome-bridge-agent)
- On Android, use [AndroidAgent](#android-agent)
- For GUI agents integrating with your own interface, refer to [Custom Interface Agent](#custom-interface-agent)

All agents share these base options:

- `generateReport: boolean`: If true, a report file will be generated. (Default: true)
- `reportFileName: string`: The name of the report file. (Default: generated by midscene)
- `autoPrintReportMsg: boolean`: If true, report messages will be printed. (Default: true)
- `cacheId: string | undefined`: If provided, this cacheId will be used to save or match the cache. (Default: undefined, means cache feature is disabled)
- `actionContext: string`: Some background knowledge that should be sent to the AI model when calling `agent.aiAct()`, like 'close the cookie consent dialog first if it exists' (Default: undefined)
- `onTaskStartTip: (tip: string) => void | Promise<void>`: Optional hook that fires before each execution task begins with a human-readable summary of the task (Default: undefined)
- `modelConfig: (params: { intent: TIntent }) => IModelConfig`: Optional. Custom model configuration function. Allows you to dynamically configure different models through code instead of environment variables. This is particularly useful when you need to use different models for different AI tasks (such as Insight, Planning, etc.).

  The function receives a parameter object with an `intent` field indicating the current task type:
  - `'insight'`: Visual understanding tasks (such as `aiAssert`, `aiQuery`, etc.)
  - `'planning'`: UI Automation related planning tasks (such as `aiAct`, `aiTap`)

  **Basic Example:**
  ```typescript
  const agent = new PuppeteerAgent(page, {
    modelConfig: () => ({
      MIDSCENE_MODEL_NAME: 'qwen3-vl-plus',
      MIDSCENE_MODEL_BASE_URL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
      MIDSCENE_MODEL_API_KEY: 'sk-...',
      MIDSCENE_LOCATOR_MODE: 'qwen3-vl'
    })
  });
  ```

  **Configure different models for different task types:**
  ```typescript
  const agent = new PuppeteerAgent(page, {
    modelConfig: ({ intent }) => {
      // Use Qwen-VL model for Insight tasks (for visual understanding and location)
      if (intent === 'insight') {
        return {
          MIDSCENE_INSIGHT_MODEL_NAME: 'qwen-vl-plus',
          MIDSCENE_INSIGHT_MODEL_API_KEY: 'sk-insight-key',
          MIDSCENE_INSIGHT_MODEL_BASE_URL: 'https://dashscope.aliyuncs.com/compatible-mode/v1'
        };
      }

      // Use GPT-4o model for Planning tasks (for task planning)
      if (intent === 'planning') {
        return {
          MIDSCENE_PLANNING_MODEL_NAME: 'gpt-4o',
          MIDSCENE_PLANNING_MODEL_API_KEY: 'sk-planning-key',
          MIDSCENE_PLANNING_MODEL_BASE_URL: 'https://api.openai.com/v1',
          MIDSCENE_INSIGHT_LOCATOR_MODE: 'qwen3-vl'
        };
      }

      // Default configuration
      return {
        MIDSCENE_MODEL_NAME: 'gpt-4o',
        MIDSCENE_MODEL_API_KEY: 'sk-default-key',
      };
    }
  });
  ```

  For more information about configuring models by task type, refer to the [Model configuration](./model-config#configure-models-by-task-type-advanced) documentation.

- `createOpenAIClient: (openai, options) => Promise<OpenAI | undefined>`: Optional. Custom OpenAI client wrapper function. Allows you to wrap the OpenAI client instance for integrating observability tools (such as LangSmith, LangFuse) or applying custom middleware.

  **Parameter Description:**
  - `openai: OpenAI` - The base OpenAI client instance created by Midscene with all necessary configurations (API key, base URL, proxy, etc.)
  - `options: Record<string, unknown>` - OpenAI initialization options, including:
    - `baseURL?: string` - API endpoint URL
    - `apiKey?: string` - API key
    - `dangerouslyAllowBrowser: boolean` - Always true in Midscene
    - Other OpenAI configuration options

  **Return Value:**
  - Return the wrapped OpenAI client instance, or `undefined` to use the original instance

  **Example (LangSmith Integration):**
  ```typescript
  import { wrapOpenAI } from 'langsmith/wrappers';

  const agent = new PuppeteerAgent(page, {
    createOpenAIClient: async (openai, options) => {
      // Wrap with LangSmith for planning tasks
      if (options.baseURL?.includes('planning')) {
        return wrapOpenAI(openai, {
          metadata: { task: 'planning' }
        });
      }

      // Return the original client for other tasks
      return openai;
    }
  });
  ```

  **Note:** `createOpenAIClient` overrides the behavior of the `MIDSCENE_LANGSMITH_DEBUG` environment variable. If you provide a custom client wrapper function, you need to handle the integration of LangSmith or other observability tools yourself.

## Interaction methods

Below are the main APIs available for the various Agents in Midscene.

:::info Auto Planning v.s. Instant Action

In Midscene, you can choose to use either auto planning or instant action.

- `agent.ai()` is for Auto Planning: Midscene will automatically plan the steps and execute them. It's more smart and looks like more fashionable style for AI agents. But it may be slower and heavily rely on the quality of the AI model.
- `agent.aiTap()`, `agent.aiHover()`, `agent.aiInput()`, `agent.aiKeyboardPress()`, `agent.aiScroll()`, `agent.aiDoubleClick()`, `agent.aiRightClick()` are for Instant Action: Midscene will directly perform the specified action, while the AI model is responsible for basic tasks such as locating elements. It's faster and more reliable if you are certain about the action you want to perform.

:::

### Agent API quick reference

Use this cheat sheet to find the right helper quickly; detailed signatures live in the sections below.

#### Basic AI operations

- `ai` / `aiAct` &mdash; General AI interaction
- `aiTap` &mdash; Click operation
- `aiHover` &mdash; Hover operation
- `aiInput` &mdash; Input operation
- `aiKeyboardPress` &mdash; Keyboard operation
- `aiScroll` &mdash; Scroll operation
- `aiRightClick` &mdash; Right-click operation

#### Query helpers

- `aiAsk` &mdash; Ask the AI model anything about the current page
- `aiQuery` &mdash; Extract structured data from the current page
- `aiNumber` &mdash; Extract a number
- `aiString` &mdash; Extract a string
- `aiBoolean` &mdash; Extract a boolean

#### Utility APIs

- `aiAssert` &mdash; AI Assertion
- `aiWaitFor` &mdash; AI Wait
- `aiLocate` &mdash; Locate element
- `runYaml` &mdash; Execute a YAML automation script
- `setAIActionContext` &mdash; Provide background knowledge for subsequent `agent.aiAct()` calls
- `evaluateJavaScript` &mdash; Execute JavaScript in the page context
- `recordToReport` &mdash; Capture a screenshot plus description in the report
- `freezePageContext` / `unfreezePageContext` &mdash; Control Playwright/Puppeteer page snapshotting

### `agent.aiAct()` or `.ai()`

This method allows you to perform a series of UI actions described in natural language. Midscene automatically plans the steps and executes them.

:::info Backward Compatibility

This method was previously named `aiAction()` in earlier versions. The current version supports both names for backward compatibility. We recommend using the new `aiAct()` method for code consistency.

:::

- Type

```typescript
function aiAct(
  prompt: string,
  options?: {
    cacheable?: boolean;
  },
): Promise<void>;
function ai(prompt: string): Promise<void>; // shorthand form
```

- Parameters:

  - `prompt: string` - A natural language description of the UI steps.
  - `options?: Object` - Optional, a configuration object containing:
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.

- Return Value:

  - Returns a Promise that resolves to void when all steps are completed; if execution fails, an error is thrown.

- Examples:

```typescript
// Basic usage
await agent.aiAct(
  'Type "JavaScript" into the search box, then click the search button',
);

// Using the shorthand .ai form
await agent.ai(
  'Click the login button at the top of the page, then enter "test@example.com" in the username field',
);

// When using UI Agent models like ui-tars, you can try a more goal-driven prompt
await agent.aiAct('Post a Tweet "Hello World"');
```

:::tip

Under the hood, Midscene uses AI model to split the instruction into a series of steps (a.k.a. "Planning"). It then executes these steps sequentially. If Midscene determines that the actions cannot be performed, an error will be thrown.

For optimal results, please provide clear and detailed instructions for `agent.aiAct()`. For guides about writing prompts, you may read this doc: [Tips for Writing Prompts](./prompting-tips).

Related Documentation:

- [Model strategy](./model-strategy)

:::

### `agent.aiTap()`

Tap something.

- Type

```typescript
function aiTap(locate: string | Object, options?: Object): Promise<void>;
```

- Parameters:

  - `locate: string | Object` - A natural language description of the element to tap, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `deepThink?: boolean` - If true, Midscene will call AI model twice to precisely locate the element. False by default.
    - `xpath?: string` - The xpath of the element to operate. If provided, Midscene will first use this xpath to locate the element before using the cache and the AI model. Empty by default.
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.

- Return Value:

  - Returns a `Promise<void>`

- Examples:

```typescript
await agent.aiTap('The login button at the top of the page');

// Use deepThink feature to precisely locate the element
await agent.aiTap('The login button at the top of the page', {
  deepThink: true,
});
```

### `agent.aiHover()`

> Only available in web pages, not available in Android.

Move mouse over something.

- Type

```typescript
function aiHover(locate: string | Object, options?: Object): Promise<void>;
```

- Parameters:

  - `locate: string | Object` - A natural language description of the element to hover over, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `deepThink?: boolean` - If true, Midscene will call AI model twice to precisely locate the element. False by default.
    - `xpath?: string` - The xpath of the element to operate. If provided, Midscene will first use this xpath to locate the element before using the cache and the AI model. Empty by default.
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.

- Return Value:

  - Returns a `Promise<void>`

- Examples:

```typescript
await agent.aiHover('The version number of the current page');
```

### `agent.aiInput()`

Input text into something.

- Type

```typescript
function aiInput(
  text: string | Object,
  locate: string,
  options?: Object,
): Promise<void>;
```

- Parameters:

  - `text: string` - The text content to input.
    - When `mode` is `'replace'`: The text will replace all existing content in the input field.
    - When `mode` is `'append'`: The text will be appended to the existing content.
    - When `mode` is `'clear'`: The text is ignored and the input field will be cleared.
  - `locate: string | Object` - A natural language description of the element to input text into, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `deepThink?: boolean` - If true, Midscene will call AI model twice to precisely locate the element. False by default.
    - `xpath?: string` - The xpath of the element to operate. If provided, Midscene will first use this xpath to locate the element before using the cache and the AI model. Empty by default.
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.
    - `autoDismissKeyboard?: boolean` - If true, the keyboard will be dismissed after input text, only available in Android/iOS. (Default: true)
    - `mode?: 'replace' | 'clear' | 'append'` - Input mode. (Default: 'replace')
      - `'replace'`: Clear the input field first, then input the text.
      - `'append'`: Append the text to existing content without clearing.
      - `'clear'`: Clear the input field without entering new text.

- Return Value:

  - Returns a `Promise<void>`

- Examples:

```typescript
await agent.aiInput('Hello World', 'The search input box');
```

### `agent.aiKeyboardPress()`

Press a keyboard key.

- Type

```typescript
function aiKeyboardPress(
  key: string,
  locate?: string | Object,
  options?: Object,
): Promise<void>;
```

- Parameters:

  - `key: string` - The web key to press, e.g. 'Enter', 'Tab', 'Escape', etc. Key Combination is not supported.
  - `locate?: string | Object` - Optional, a natural language description of the element to press the key on, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `deepThink?: boolean` - If true, Midscene will call AI model twice to precisely locate the element. False by default.
    - `xpath?: string` - The xpath of the element to operate. If provided, Midscene will first use this xpath to locate the element before using the cache and the AI model. Empty by default.
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.

- Return Value:

  - Returns a `Promise<void>`

- Examples:

```typescript
await agent.aiKeyboardPress('Enter', 'The search input box');
```

### `agent.aiScroll()`

Scroll a page or an element.

- Type

```typescript
function aiScroll(
  scrollParam: PlanningActionParamScroll,
  locate?: string | Object,
  options?: Object,
): Promise<void>;
```

- Parameters:

  - `scrollParam: PlanningActionParamScroll` - The scroll parameter
    - `direction?: 'down' | 'up' | 'right' | 'left'` - The direction to scroll. Defaults to `down`. Whether it is Android or Web, the scrolling direction here all refers to which direction of the page's content will appear on the screen. For example, when the scrolling direction is `down`, the hidden content at the bottom of the page will gradually reveal itself from the bottom of the screen upwards.
    - `scrollType?: 'singleAction' | 'scrollToBottom' | 'scrollToTop' | 'scrollToRight' | 'scrollToLeft'` - The scroll behavior. Defaults to `singleAction`.
    - `distance?: number | null` - Optional, the distance to scroll in px. Use `null` to allow Midscene to decide automatically.
  - `locate?: string | Object` - Optional, a natural language description of the element to scroll on, or [prompting with images](#prompting-with-images). If not provided, Midscene will perform scroll on the current mouse position.
  - `options?: Object` - Optional, a configuration object containing:
    - `deepThink?: boolean` - If true, Midscene will call AI model twice to precisely locate the element. False by default.
    - `xpath?: string` - The xpath of the element to operate. If provided, Midscene will first use this xpath to locate the element before using the cache and the AI model. Empty by default.
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.

- Return Value:

  - Returns a `Promise<void>`

- Examples:

```typescript
await agent.aiScroll(
  { direction: 'up', distance: 100, scrollType: 'singleAction' },
  'The form panel',
);
```

### `agent.aiDoubleClick()`

Double-click on an element.

- Type

```typescript
function aiDoubleClick(locate: string | Object, options?: Object): Promise<void>;
```

- Parameters:

  - `locate: string | Object` - A natural language description of the element to double-click on, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `deepThink?: boolean` - If true, Midscene will call AI model twice to precisely locate the element. False by default.
    - `xpath?: string` - The xpath of the element to operate. If provided, Midscene will first use this xpath to locate the element before using the cache and the AI model. Empty by default.
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.

- Return Value:

  - Returns a `Promise<void>`

- Examples:

```typescript
await agent.aiDoubleClick('The file name at the top of the page');

// Use deepThink feature to precisely locate the element
await agent.aiDoubleClick('The file name at the top of the page', {
  deepThink: true,
});
```

### `agent.aiRightClick()`

> Only available in web pages, not available in Android.

Right-click on an element. Please note that Midscene cannot interact with the native context menu in browser after right-clicking. This interface is usually used for the element that listens to the right-click event by itself.

- Type

```typescript
function aiRightClick(locate: string, options?: Object): Promise<void>;
```

- Parameters:

  - `locate: string | Object` - A natural language description of the element to right-click on, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `deepThink?: boolean` - If true, Midscene will call AI model twice to precisely locate the element. False by default.
    - `xpath?: string` - The xpath of the element to operate. If provided, Midscene will first use this xpath to locate the element before using the cache and the AI model. Empty by default.
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.

- Return Value:

  - Returns a `Promise<void>`

- Examples:

```typescript
await agent.aiRightClick('The file name at the top of the page');

// Use deepThink feature to precisely locate the element
await agent.aiRightClick('The file name at the top of the page', {
  deepThink: true,
});
```

:::tip About the `deepThink` feature

The `deepThink` feature is a powerful feature that allows Midscene to call AI model twice to precisely locate the element. False by default. It is useful when the AI model find it hard to distinguish the element from its surroundings.

:::

## Data extraction

### `agent.aiAsk()`

Ask the AI model any question about the current page. It returns the answer in string from the AI model.

- Type

```typescript
function aiAsk(prompt: string | Object, options?: Object): Promise<string>;
```

- Parameters:

  - `prompt: string | Object` - A natural language description of the question, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `domIncluded?: boolean | 'visible-only'` - Whether to send simplified DOM information to the model, usually used for extracting invisible attributes like image links. If set to `'visible-only'`, only the visible elements will be sent. False by default.
    - `screenshotIncluded?: boolean` - Whether to send screenshot to the model. True by default.

- Return Value:

  - Return a Promise. Return the answer from the AI model.

- Examples:

```typescript
const result = await agent.aiAsk('What should I do to test this page?');
console.log(result); // Output the answer from the AI model
```

Besides `aiAsk`, you can also use `aiQuery` to extract structured data from the UI.

### `agent.aiQuery()`

This method allows you to extract structured data from current page. Simply define the expected format (e.g., string, number, JSON, or an array) in the `dataDemand`, and Midscene will return a result that matches the format.

- Type

```typescript
function aiQuery<T>(dataDemand: string | Object, options?: Object): Promise<T>;
```

- Parameters:

  - `dataDemand: T`: A description of the expected data and its return format.
  - `options?: Object` - Optional, a configuration object containing:
    - `domIncluded?: boolean | 'visible-only'` - Whether to send simplified DOM information to the model, usually used for extracting invisible attributes like image links. If set to `'visible-only'`, only the visible elements will be sent. False by default.
    - `screenshotIncluded?: boolean` - Whether to send screenshot to the model. True by default.

- Return Value:

  - Returns any valid basic type, such as string, number, JSON, array, etc.
  - Just describe the format in `dataDemand`, and Midscene will return a matching result.

- Examples:

```typescript
const dataA = await agent.aiQuery({
  time: 'The date and time displayed in the top-left corner as a string',
  userInfo: 'User information in the format {name: string}',
  tableFields: 'An array of table field names, string[]',
  tableDataRecord:
    'Table records in the format {id: string, [fieldName]: string}[]',
});

// You can also describe the expected return format using a string:

// dataB will be an array of strings
const dataB = await agent.aiQuery('string[], list of task names');

// dataC will be an array of objects
const dataC = await agent.aiQuery(
  '{name: string, age: string}[], table data records',
);

// Use domIncluded feature to extract invisible attributes
const dataD = await agent.aiQuery(
  '{name: string, age: string, avatarUrl: string}[], table data records',
  { domIncluded: true },
);
```

### `agent.aiBoolean()`

Extract a boolean value from the UI.

- Type

```typescript
function aiBoolean(prompt: string | Object, options?: Object): Promise<boolean>;
```

- Parameters:
  - `prompt: string | Object` - A natural language description of the expected value, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `domIncluded?: boolean | 'visible-only'` - Whether to send simplified DOM information to the model, usually used for extracting invisible attributes like image links. If set to `'visible-only'`, only the visible elements will be sent. False by default.
    - `screenshotIncluded?: boolean` - Whether to send screenshot to the model. True by default.
- Return Value:

  - Returns a `Promise<boolean>` when AI returns a boolean value.

- Examples:

```typescript
const boolA = await agent.aiBoolean('Whether there is a login dialog');

// Use domIncluded feature to extract invisible attributes
const boolB = await agent.aiBoolean('Whether the login button has a link', {
  domIncluded: true,
});
```

### `agent.aiNumber()`

Extract a number value from the UI.

- Type

```typescript
function aiNumber(prompt: string | Object, options?: Object): Promise<number>;
```

- Parameters:
  - `prompt: string | Object` - A natural language description of the expected value, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `domIncluded?: boolean | 'visible-only'` - Whether to send simplified DOM information to the model, usually used for extracting invisible attributes like image links. If set to `'visible-only'`, only the visible elements will be sent. False by default.
    - `screenshotIncluded?: boolean` - Whether to send screenshot to the model. True by default.
- Return Value:

  - Returns a `Promise<number>` when AI returns a number value.

- Examples:

```typescript
const numberA = await agent.aiNumber('The remaining points of the account');

// Use domIncluded feature to extract invisible attributes
const numberB = await agent.aiNumber(
  'The value of the remaining points element',
  { domIncluded: true },
);
```

### `agent.aiString()`

Extract a string value from the UI.

- Type

```typescript
function aiString(prompt: string | Object, options?: Object): Promise<string>;
```

- Parameters:
  - `prompt: string | Object` - A natural language description of the expected value, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `domIncluded?: boolean | 'visible-only'` - Whether to send simplified DOM information to the model, usually used for extracting invisible attributes like image links. If set to `'visible-only'`, only the visible elements will be sent. False by default.
    - `screenshotIncluded?: boolean` - Whether to send screenshot to the model. True by default.
- Return Value:

  - Returns a `Promise<string>` when AI returns a string value.

- Examples:

```typescript
const stringA = await agent.aiString('The first item in the list');

// Use domIncluded feature to extract invisible attributes
const stringB = await agent.aiString('The link of the first item in the list', {
  domIncluded: true,
});
```

## More APIs

### `agent.aiAssert()`

Specify an assertion in natural language, and the AI determines whether the condition is true. If the assertion fails, the SDK throws an error that includes both the optional `errorMsg` and a detailed reason generated by the AI.

- Type

```typescript
function aiAssert(
  assertion: string | Object, 
  errorMsg?: string, 
  options?: Object
): Promise<void>;
```

- Parameters:

  - `assertion: string | Object` - The assertion described in natural language, or [prompting with images](#prompting-with-images).
  - `errorMsg?: string` - An optional error message to append if the assertion fails.
  - `options?: Object` - Optional, a configuration object containing:
    - `domIncluded?: boolean | 'visible-only'` - Whether to send simplified DOM information to the model, usually used for extracting invisible attributes like image links. If set to `'visible-only'`, only the visible elements will be sent. False by default.
    - `screenshotIncluded?: boolean` - Whether to send screenshot to the model. True by default.

- Return Value:

  - Returns a Promise that resolves to void if the assertion passes; if it fails, an error is thrown with `errorMsg` and additional AI-provided information.

- Example:

```typescript
await agent.aiAssert('The price of "Sauce Labs Onesie" is 7.99');
```

:::tip
Assertions are critical in test scripts. To reduce the risk of errors due to AI hallucination (e.g., missing an error), you can also combine `.aiQuery` with standard JavaScript assertions instead of using `.aiAssert`.

For example, you might replace the above code with:

```typescript
const items = await agent.aiQuery(
  '"{name: string, price: number}[], return product names and prices',
);
const onesieItem = items.find((item) => item.name === 'Sauce Labs Onesie');
expect(onesieItem).toBeTruthy();
expect(onesieItem.price).toBe(7.99);
```

:::

### `agent.aiLocate()`

Locate an element using natural language.

- Type

```typescript
function aiLocate(
  locate: string | Object,
  options?: Object,
): Promise<{
  rect: {
    left: number;
    top: number;
    width: number;
    height: number;
  };
  center: [number, number];
  scale: number; // device pixel ratio
}>;
```

- Parameters:

  - `locate: string | Object` - A natural language description of the element to locate, or [prompting with images](#prompting-with-images).
  - `options?: Object` - Optional, a configuration object containing:
    - `deepThink?: boolean` - If true, Midscene will call AI model twice to precisely locate the element. False by default.
    - `xpath?: string` - The xpath of the element to operate. If provided, Midscene will first use this xpath to locate the element before using the cache and the AI model. Empty by default.
    - `cacheable?: boolean` - Whether cacheable when enabling [caching feature](./caching.mdx). True by default.

- Return Value:

  - Returns a `Promise` when the element is located parsed as an locate info object.

- Examples:

```typescript
const locateInfo = await agent.aiLocate(
  'The login button at the top of the page',
);
console.log(locateInfo);
```

### `agent.aiWaitFor()`

Wait until a specified condition, described in natural language, becomes true. Considering the cost of AI calls, the check interval will not exceed the specified `checkIntervalMs`.

- Type

```typescript
function aiWaitFor(
  assertion: string,
  options?: {
    timeoutMs?: number;
    checkIntervalMs?: number;
  },
): Promise<void>;
```

- Parameters:

  - `assertion: string` - The condition described in natural language.
  - `options?: object` - An optional configuration object containing:
    - `timeoutMs?: number` - Maximum window in milliseconds for starting a new check (default: 15000). If the previous evaluation began before this window closes, Midscene keeps checking; otherwise it stops with a timeout.
    - `checkIntervalMs?: number` - Interval for checking in milliseconds (default: 3000).

- Return Value:

  - Returns a Promise that resolves to void if the condition is met; if not, an error is thrown when the timeout is reached.

- Examples:

```typescript
// Basic usage
await agent.aiWaitFor(
  'There is at least one headphone information displayed on the interface',
);

// Using custom options
await agent.aiWaitFor('The shopping cart icon shows a quantity of 2', {
  timeoutMs: 30000, // Wait for 30 seconds
  checkIntervalMs: 5000, // Check every 5 seconds
});
```

:::tip
Given the time consumption of AI services, `.aiWaitFor` might not be the most efficient method. Sometimes, using a simple sleep function may be a better alternative.
:::

### `agent.runYaml()`

Execute an automation script written in YAML. Only the `tasks` part of the script is executed, and it returns the results of all `.aiQuery` calls within the script.

- Type

```typescript
function runYaml(yamlScriptContent: string): Promise<{ result: any }>;
```

- Parameters:

  - `yamlScriptContent: string` - The YAML-formatted script content.

- Return Value:

  - Returns an object with a `result` property that includes the results of all `.aiQuery` calls.

- Example:

```typescript
const { result } = await agent.runYaml(`
tasks:
  - name: search weather
    flow:
      - ai: input 'weather today' in input box, click search button
      - sleep: 3000

  - name: query weather
    flow:
      - aiQuery: "the result shows the weather info, {description: string}"
`);
console.log(result);
```

:::tip
For more information about YAML scripts, please refer to [Automate with Scripts in YAML](./automate-with-scripts-in-yaml).
:::

### `agent.setAIActionContext()`

Set the background knowledge that should be sent to the AI model when calling `agent.aiAct()` or `agent.ai()`. This will override the previous setting.

For instant action type APIs, like `aiTap()`, this setting will not take effect.

- Type

```typescript
function setAIActionContext(actionContext: string): void;
```

- Parameters:

  - `actionContext: string` - The background knowledge that should be sent to the AI model.

- Example:

```typescript
await agent.setAIActionContext(
  'Close the cookie consent dialog first if it exists',
);
```

### `agent.evaluateJavaScript()`

> Only available in web pages, not available in Android.

Evaluate a JavaScript expression in the web page context.

- Type

```typescript
function evaluateJavaScript(script: string): Promise<any>;
```

- Parameters:

  - `script: string` - The JavaScript expression to evaluate.

- Return Value:

  - Returns the result of the JavaScript expression.

- Example:

```typescript
const result = await agent.evaluateJavaScript('document.title');
console.log(result);
```

### `agent.recordToReport()`

Log the current screenshot with a description in the report file.

- Type

```typescript
function recordToReport(title?: string, options?: Object): Promise<void>;
```

- Parameters:

  - `title?: string` - Optional, the title of the screenshot, if not provided, the title will be 'untitled'.
  - `options?: Object` - Optional, a configuration object containing:
    - `content?: string` - The description of the screenshot.

- Return Value:

  - Returns a `Promise<void>`

- Examples:

```typescript
await agent.recordToReport('Login page', {
  content: 'User A',
});
```

### `agent.freezePageContext()`

Freeze the current page context, allowing all subsequent operations to reuse the same page snapshot without retrieving the page state repeatedly. This significantly improves performance when executing a large number of concurrent operations. 

Some notes:
* Usually, you do not need to use this method, unless you are certain that "context retrieval" is the bottleneck of your test script.
* You need to call `agent.unfreezePageContext()` in time to restore the real-time page state.
* Do not call this method in interaction operations, it will make the AI model unable to perceive the latest page state, causing confusing errors.

- Type

```typescript
function freezePageContext(): Promise<void>;
```

- Return Value:

  - `Promise<void>`

- Examples:

```typescript
// Freeze the page context
await agent.freezePageContext();

// Some queries...
const results = await Promise.all([
  await agent.aiQuery('Username input box value'),
  await agent.aiQuery('Password input box value'),
  await agent.aiLocate('Login button'),
]);
console.log(results);

// Unfreeze the page context, subsequent operations will use real-time page state
await agent.unfreezePageContext();
```

:::tip
In the report, operations using frozen context will display a üßä icon in the Insight tab.
:::

### `agent.unfreezePageContext()`

Unfreezes the page context, restoring the use of real-time page state.

- Type

```typescript
function unfreezePageContext(): Promise<void>;
```

- Return Value:

  - `Promise<void>`


## Prompting with images

You can use images as supplements in the prompt to describe things that cannot be expressed in natural language.

When prompting with images, the format of the prompt parameters is as follows:

```javascript
{
  // Prompt text, in which images can be referred
  prompt: string,
  // The images referred in the prompt text
  images?: {
    // Image name, corresponding to the names referred in the prompt text
    name: string,
    // Image url, can be a local image path, Base64 string, or http link
    url: string
  }[]
  // When convertHttpImage2Base64 is trueÔºåthe image links in the http format will be converted into Base64 encoding and sent to the LLM.
  // Which is applicable when the image links are not publicly accessible.
  convertHttpImage2Base64?: boolean
}
```

- Example 1: use images to inspect the tap position.

```javascript
await agent.aiTap({
  prompt: 'The specific logo',
  images: [
    {
      name: 'The specific logo',
      url: 'https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png',
    },
  ],
});
```

- Example 2: use images to assert the page content.

```javascript
await agent.aiAssert({
  prompt: 'Whether there is a specific logo on the page.',
  images: [
    {
      name: 'The specific logo',
      url: 'https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png',
    },
  ],
});
```

**Notes on Image Size**

When prompting with images, it is necessary to pay attention to the requirements of the AI model provider regarding the size and dimensions of the images. Images that are too large (such as exceeding 10M) or too small (such as being less than 10 pixels) may cause errors when the model is invoked. The specific restrictions should be based on the documentation provided by the AI model provider you are using.

## Properties

### `.reportFile`

The path to the report file.


## Puppeteer Agent

To import the Puppeteer agent, use:

```typescript
import { PuppeteerAgent } from '@midscene/web/puppeteer';
```

In addition to the common parameters above, the Puppeteer agent exposes browser-specific options (see [Puppeteer integration](./integrate-with-puppeteer#puppeteeragent) for full details):

- `forceSameTabNavigation: boolean`: If true, page navigation is restricted to the current tab. (Default: true)
- `waitForNavigationTimeout: number`: The timeout for waiting for navigation to finish. (Default: 5000ms, set to 0 to skip waiting)
- `waitForNetworkIdleTimeout: number`: The timeout for waiting for network idle between each action. (Default: 2000ms, set to 0 to skip waiting)
- `customActions: DeviceAction[]`: Extend the agent with bespoke actions defined via `defineAction`, so planning can call your domain-specific steps.

## Playwright Agent

To import the Playwright agent, use:

```typescript
import { PlaywrightAgent } from '@midscene/web/playwright';
```

Playwright shares the same core configuration and adds the following commonly used options (see [Playwright integration](./integrate-with-playwright#playwrightagent)):

- `forceSameTabNavigation: boolean`: Keep navigation inside the active tab (Default: true)
- `waitForNavigationTimeout: number`: Maximum wait for navigation completion after each action. (Default: 5000ms, set to 0 to disable)
- `waitForNetworkIdleTimeout: number`: Wait for network idle between actions to reduce flakiness. (Default: 2000ms, set to 0 to disable)
- `customActions: DeviceAction[]`: Register custom actions so the agent can execute project-specific behaviors during planning.

## Chrome Bridge Agent

Bridge Mode lets you connect Midscene to the Chrome extension so the AI can operate your currently active desktop browser tab without launching a separate automation instance.

```typescript
import { AgentOverChromeBridge } from '@midscene/web/bridge-mode';

const agent = new AgentOverChromeBridge({
  allowRemoteAccess: false,
});
```

In addition to the shared constructor options, `AgentOverChromeBridge` exposes a lightweight server configuration layer:

- `allowRemoteAccess?: boolean`: Enable this to allow remote machines to attach. Defaults to `false`, which binds the server to `127.0.0.1`.
- `host?: string`: Override the network interface used by the Bridge server. When set, this takes precedence over `allowRemoteAccess`.
- `port?: number`: Custom TCP port for the bridge server (Default: `3766`).

See [Bridge Mode by Chrome extension](./bridge-mode#constructor) for details on installing the extension and exposing additional Chrome-specific actions.

## Android Agent

To work with Android devices, import the Android SDK package:

```typescript
import {
  AndroidAgent,
  AndroidDevice,
  getConnectedDevices,
} from '@midscene/android';
```

Basic usage:

```typescript
const devices = await getConnectedDevices();
const device = new AndroidDevice(devices[0].udid);
await device.connect();

const agent = new AndroidAgent(device, {
  actionContext: 'If a permissions dialog appears, accept it.',
});
```

Android automation reuses the common constructor options and adds a few platform-specific considerations:

- `device: AndroidDevice` (required): Wraps the physical/emulated device obtained through `getConnectedDevices()` or a known `udid`. Configure device behavior through the [AndroidDevice constructor](./integrate-with-android#androiddevice-constructor) to tweak keyboard dismissal, screenshot scale, display id, and ADB connection settings.
- `opts?: PageAgentOpt`: Same option bag described in the common parameters (`actionContext`, `generateReport`, `modelConfig`, etc.). You can also pass in test metadata such as `groupName` for report merging.

Helper utilities:
- `agentFromAdbDevice(deviceId?, opts?)` creates and configures both the `AndroidDevice` and the agent in one call. See [Android integration](./integrate-with-android#androidagent) for usage plus extra APIs like `agent.launch` or `agent.runAdbShell`.

### Methods

#### `agent.launch()`

Launch a web URL or native Android activity/package.

```typescript
function launch(uri: string): Promise<void>;
```

- `uri: string` &mdash; Either a webpage URL or a package/`package/.Activity` string such as `com.android.settings/.Settings`.

```typescript
const agent = new AndroidAgent(device);
await agent.launch('https://www.ebay.com');
await agent.launch('com.android.settings');
await agent.launch('com.android.settings/.Settings');
```

#### `agent.runAdbShell()`

Run a raw `adb shell` command through the connected device.

```typescript
function runAdbShell(command: string): Promise<string>;
```

- `command: string` &mdash; Command passed verbatim to `adb shell`.

```typescript
const result = await agent.runAdbShell('dumpsys battery');
console.log(result);
```

:::info YAML usage
Android-only helpers such as `launch` and `runAdbShell` are also exposed in YAML scripts. See [Android platform-specific actions](./automate-with-scripts-in-yaml#the-android-part) for syntax.
:::

#### `agent.back()`

Trigger the Android system Back action.

```typescript
function back(): Promise<void>;
```

#### `agent.home()`

Return to the launcher.

```typescript
function home(): Promise<void>;
```

#### `agent.recentApps()`

Open the Recents/Overview screen.

```typescript
function recentApps(): Promise<void>;
```

### Android helper utilities

#### `agentFromAdbDevice()`

Create an `AndroidAgent` from any connected adb device.

```typescript
function agentFromAdbDevice(
  deviceId?: string,
  opts?: PageAgentOpt & AndroidDeviceOpt,
): Promise<AndroidAgent>;
```

- `deviceId?: string` &mdash; Connect to a specific device; omitted means ‚Äúfirst available‚Äù.
- `opts?: PageAgentOpt & AndroidDeviceOpt` &mdash; Combine agent options with [AndroidDevice constructor](./integrate-with-android#androiddevice-constructor) settings.

#### `getConnectedDevices()`

Enumerate adb devices Midscene can drive.

```typescript
function getConnectedDevices(): Promise<Array<{
  udid: string;
  state: string;
  port?: number;
}>>;
```

## Custom Interface Agent

If you're building a GUI agent for your own hardware or software surface, instantiate the generic `Agent` class with any implementation of `AbstractInterface`:

```typescript
import { Agent } from '@midscene/core/agent';
import { SampleDevice } from 'my-interface-package';

const device = new SampleDevice();
await device.launch?.();

const agent = new Agent(device, {
  actionContext: 'Close consent dialogs before proceeding.',
});
```

- `device: AbstractInterface`: Your custom controller must implement the methods described in [Integrate with any interface](./integrate-with-any-interface). Its `actionSpace()` defines what the AI planner can call.
- `opts?: PageAgentOpt`: Identical to the shared constructor options; use this to control reporting, caching, or provide a custom `modelConfig`.
- Once constructed, the agent supports the full API surface (`aiAct`, `aiQuery`, YAML runner, playground, MCP server). Refer to the [custom interface guide](./integrate-with-any-interface#agent-constructor) for a deeper walk-through.


## `ReportMergingTool`

When running multiple automation workflows, each agent generates its own report file. The `ReportMergingTool` provides the ability to merge multiple automation reports into a single report for unified viewing and management of automation results.

### Constructor

Create a report merging tool instance.

```typescript
import { ReportMergingTool } from '@midscene/core/report';

const reportMergingTool = new ReportMergingTool();
```

### `.append()`

Add an automation report to the list of reports to be merged.

- Type

```typescript
function append(reportInfo: ReportFileWithAttributes): void;
```

- Parameters:

  - `reportInfo: ReportFileWithAttributes` - Report information object containing:
    - `reportFilePath: string` - Path to the report file
    - `reportAttributes: object` - Report attributes
      - `testId: string` - Unique identifier for the automation workflow
      - `testTitle: string` - Automation workflow title
      - `testDescription: string` - Automation workflow description
      - `testDuration: number` - Automation execution duration (in milliseconds)
      - `testStatus: TestStatus` - Automation status, options: `'passed' | 'failed' | 'skipped' | 'timedOut'`

- Examples:

```typescript
reportMergingTool.append({
  reportFilePath: agent.reportFile as string,
  reportAttributes: {
    testId: 'automation-001',
    testTitle: 'Login Automation',
    testDescription: 'Automated user login workflow',
    testDuration: 5000,
    testStatus: 'passed',
  },
});
```

### `.mergeReports()`

Merge all added reports into a single report file.

- Type

```typescript
function mergeReports(
  reportFileName?: 'AUTO' | string,
  opts?: {
    rmOriginalReports?: boolean;
    overwrite?: boolean;
  },
): string | null;
```

- Parameters:

  - `reportFileName?: 'AUTO' | string` - Report filename (optional)
    - If `'AUTO'` or not specified, a filename will be automatically generated
    - If a custom name is provided, it will be used as the report filename
  - `opts?: object` - Optional configuration object containing:
    - `rmOriginalReports?: boolean` - Whether to delete the original report files after merging (default: false)
    - `overwrite?: boolean` - Whether to overwrite if the report file already exists (default: false)

- Return Value:

  - Returns the path to the merged report file on success, or `null` if there are not enough reports to merge (less than 2 reports)

- Examples:

```typescript
// Automatically generate report filename
const reportPath = reportMergingTool.mergeReports();

// Custom report filename
const reportPath = reportMergingTool.mergeReports('my-test-report');

// Merge and delete original reports
const reportPath = reportMergingTool.mergeReports('my-test-report', {
  rmOriginalReports: true,
});
```

### `.clear()`

Clear all added report information.

- Type

```typescript
function clear(): void;
```

- Examples:

```typescript
reportMergingTool.clear();
```
