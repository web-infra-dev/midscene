# v0.17.4 Changelog: Let AI See the DOM of the Page!

## Data Query API Enhanced

To meet more frontend automation and data extraction scenarios, the following APIs have been enhanced with the `options` parameter, supporting more flexible DOM information and screenshots:

- `agent.aiQuery`
- `agent.aiBoolean`
- `agent.aiNumber`
- `agent.aiString`

### New options parameter

- `domIncluded`: Whether to pass the simplified DOM information (suitable for extracting hidden attributes, such as image links), default is off.
- `screenshotIncluded`: Whether to pass the screenshot, default is on.

### Code Example

```typescript
// Extract all contact information (including hidden avatarUrl attributes)
const contactsData = await agent.aiQuery(
  "{name: string, id: number, company: string, department: string, avatarUrl: string}[], extract all contact information including hidden avatarUrl attributes",
  { domIncluded: true }
);

// Check if the id attribute of the first contact is 1
const isId1 = await agent.aiBoolean(
  "Is the first contact's id is 1?",
  { domIncluded: true }
);

// Get the ID of the first contact (hidden attribute)
const firstContactId = await agent.aiNumber("First contact's id?", { domIncluded: true });

// Get the avatar URL of the first contact (invisible attribute on the page)
const avatarUrl = await agent.aiString(
  "What is the Avatar URL of the first contact?",
  { domIncluded: true }
);
```

## New Right-Click Ability

Have you ever encountered a scenario where you need to automate a right-click operation? Now, Midscene supports a new `agent.aiRightClick()` method!

- **Function**: Automatically right-click on page elements, suitable for scenarios where right-click events are customized (note: cannot interact with the browser's native menu).
- **Real Scenario Example**:
  ```typescript
  // Right-click on a contact in the contacts application, triggering a custom context menu
  await agent.aiRightClick("Alice Johnson", { deepThink: true });
  
  // Then you can click on the options in the menu
  await agent.aiTap("Copy Info"); // Copy contact information to the clipboard
  ```
- **Parameter Description**:
  - `locate`: Describe the element you want to operate in natural language
  - `options`: Optional, supports `deepThink` (AI fine-grained positioning) and `cacheable` (result caching)

## Example and Report

### Example Page

<iframe src="https://lf3-static.bytednsdoc.com/obj/eden-cn/nupipfups/Midscene/contacts3.html" width="100%" height="800"></iframe>

### Example Report

<iframe src="https://lf3-static.bytednsdoc.com/obj/eden-cn/nupipfups/Midscene/puppeteer-2025-06-04_20-34-48-zyh4ry4e.html" width="100%" height="800"></iframe>

### Example Code

```typescript
import puppeteer from "puppeteer";
import os from "node:os";
import { PuppeteerAgent } from "@midscene/web/puppeteer";
import "dotenv/config"; // read environment variables from .env file

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

Promise.resolve(
  (async () => {
    const browser = await puppeteer.launch({
      headless: false, // set to 'false' to see the browser window for demo
      args: ["--no-sandbox", "--disable-setuid-sandbox"],
    });

    const page = await browser.newPage();
    await page.setViewport({
      width: 1280,
      height: 768,
      deviceScaleFactor: os.platform() === "darwin" ? 2 : 1,
    });

    // Load the contacts demo page (replace with your actual file path or URL)
    await page.goto("https://lf3-static.bytednsdoc.com/obj/eden-cn/nupipfups/Midscene/contacts3.html");
    
    // await sleep(2000);

    // ü§ñ Initialize Midscene agent
    const agent = new PuppeteerAgent(page);

    console.log("üöÄ Starting Smart Contacts Demo with Midscene AI");
    console.log("================================================");

    // ‚ú® NEW FEATURE DEMO 1: aiRightClick - Right-click on a contact
    console.log("\n1. üñ±Ô∏è Testing aiRightClick feature...");
    await agent.aiRightClick("Alice Johnson", { deepThink: true });
    await sleep(1000);
    console.log("‚úÖ Successfully right-clicked on Alice Johnson's contact card");
    
    // Click on "Copy Info" option in context menu
    await agent.aiTap("Copy Info");
    await sleep(1000);
    console.log("‚úÖ Successfully triggered 'Copy Info' action from context menu");

    // ‚ú® NEW FEATURE DEMO 2: aiQuery with domIncluded - Extract contact data including hidden attributes
    console.log("\n2. üìä Testing aiQuery with domIncluded feature...");
    const contactsData = await agent.aiQuery(
      "{name: string, id: number, company: string, department: string, avatarUrl: string}[], extract all contact information including hidden avatarUrl attributes",
      { domIncluded: true }
    );
    console.log("‚úÖ Successfully extracted contact data with hidden attributes:");
    console.log(JSON.stringify(contactsData, null, 2));

    // ‚ú® NEW FEATURE DEMO 3: aiBoolean with domIncluded - Check for ID fields
    console.log("\n3. ‚ùì Testing aiBoolean with domIncluded feature...");
    const isId1 = await agent.aiBoolean(
      "is First contact's id is 1?",
      { domIncluded: true }
    );
    console.log("‚úÖ Is First contact's id is 1?", isId1);

    // ‚ú® NEW FEATURE DEMO 4: aiNumber - with domIncluded - Count contacts
    console.log("\n4. üî¢ Testing aiNumber with domIncluded feature...");
    const contactCount = await agent.aiNumber("First contact's id?", { domIncluded: true });
    console.log("‚úÖ First contact's id:", contactCount);

    // ‚ú® NEW FEATURE DEMO 5: aiString with domIncluded - Get first contact's ID
    console.log("\n5. üÜî Testing aiString with domIncluded feature...");
    const firstContactId = await agent.aiString(
      "What is the Avatar URL of the first contact?",
      { domIncluded: true }
    );
    console.log("‚úÖ First contact's Avatar URL:", firstContactId);

    console.log("\nüéâ Smart Contacts Demo completed!");
    console.log("================================================");
    console.log("‚ú® New Midscene features demonstrated:");
    console.log("   ‚Ä¢ aiRightClick() with deepThink - Custom context menus");
    console.log("   ‚Ä¢ aiQuery() with domIncluded - Extract hidden ID attributes");
    console.log("   ‚Ä¢ aiBoolean() with domIncluded - DOM-based boolean checks");
    console.log("   ‚Ä¢ aiNumber() - with domIncluded - Hidden ID attributes");
    console.log("   ‚Ä¢ aiString() with domIncluded - Extract hidden Avatar URL values");

    // Keep browser open for a few seconds to see the results
    await sleep(3000);
    await browser.close();
  })()
);
```

**Welcome to experience the new Midscene API, more automation possibilities await you!**

If you have any suggestions, please submit an issue on [GitHub](https://github.com/web-infra-dev/midscene/issues).
