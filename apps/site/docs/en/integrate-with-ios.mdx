import SetupEnv from './common/setup-env.mdx';

# Integrate with iOS (WebDriverAgent)

After connecting iOS devices using WebDriverAgent, you can use Midscene javascript SDK to control iOS devices.

import { PackageManagerTabs } from '@theme';

:::info Sample Projects
Control iOS devices with javascript SDK: [https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo](https://github.com/web-infra-dev/midscene-example/blob/main/ios/javascript-sdk-demo)

Integrate with Vitest for testing: [https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo](https://github.com/web-infra-dev/midscene-example/tree/main/ios/vitest-demo)
:::

## Environment Setup

Before getting started, you need to set up your iOS development environment:

### Prerequisites

- **macOS** (required for iOS development)
- **Xcode** and Xcode Command Line Tools
- **iOS Simulator** or physical iOS device
- **WebDriverAgent** (required for automation)

### 1. Basic Environment Installation

```bash
# Install Xcode Command Line Tools
xcode-select --install

# Verify simctl is available (required for simulators)
xcrun simctl list devices

# Install libimobiledevice (required for real devices)
brew install libimobiledevice
```

### 2. WebDriverAgent Setup

Midscene iOS uses WebDriverAgent for device automation. You need to prepare WebDriverAgent before using the library:

#### Simulator Setup

1. **Install WebDriverAgent dependency**:
   ```bash
   npm install appium-webdriveragent
   ```

2. **Build and start WebDriverAgent**:
   ```bash
   # Navigate to WebDriverAgent project directory
   cd node_modules/appium-webdriveragent

   # Build and run for simulator (using iPhone 15 as example)
   xcodebuild -project WebDriverAgent.xcodeproj \
             -scheme WebDriverAgentRunner \
             -destination 'platform=iOS Simulator,name=iPhone 15' \
             test
   ```

#### Real Device Setup

1. **Configure Development Team**:
   Open `node_modules/appium-webdriveragent/WebDriverAgent.xcodeproj` in Xcode, and refer to the following documentation to build the app for your real iOS device: [Real Device Configuration](https://appium.github.io/appium-xcuitest-driver/4.25/real-device-config) and [WebDriverAgent](https://appium.github.io/appium-xcuitest-driver/4.25/wda-custom-server)

2. **Build and deploy to device**:
   ```bash
   # Replace YOUR_DEVICE_UDID with your device's UDID
   xcodebuild -project WebDriverAgent.xcodeproj \
             -scheme WebDriverAgentRunner \
             -destination 'id=YOUR_DEVICE_UDID' \
             test
   ```

3. **Trust Developer Certificate**:
   - On your iOS device, go to Settings > General > VPN & Device Management
   - Trust your developer certificate

4. **Enable Developer Mode and UI Automation**:
   - Go to Settings > Privacy & Security > Developer Mode, enable and restart device
   - Go to Settings > Developer > UI Automation, enable UI Automation

5. **Set up port forwarding (for real devices)**:
   ```bash
   # Forward local port 8100 to device port 8100
   iproxy 8100 8100 YOUR_DEVICE_UDID
   ```

   Keep this command running in a separate terminal window.

#### Advanced Setup Methods

For more advanced setup options and troubleshooting, refer to the official WebDriverAgent documentation:
**ðŸ“– [WebDriverAgent Setup Guide](https://appium.github.io/appium-xcuitest-driver/4.25/wda-custom-server/)**

<SetupEnv />

## Step 1. Install dependencies

<PackageManagerTabs command="install @midscene/ios --save-dev" />

## Step 2. Write scripts

Here's an example using iOS Safari browser to search for headphones.

Write the following code and save it as `./demo.ts`

```typescript title="./demo.ts"
import {
  IOSAgent,
  IOSDevice,
  getConnectedDevices,
} from '@midscene/ios';

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
Promise.resolve(
  (async () => {
    const devices = await getConnectedDevices();
    const page = new IOSDevice(devices[0].udid, {
      wdaPort: 8100,
      wdaHost: 'localhost',
    });

    // ðŸ‘€ Initialize Midscene agent
    const agent = new IOSAgent(page, {
      aiActionContext:
        'If any location, permission, user agreement, etc. popup appears, click agree. If login page appears, close it.',
    });
    await page.connect();

    // ðŸ‘€ Launch Safari and navigate to ebay.com
    await page.launch('com.apple.mobilesafari');
    await sleep(3000);

    // ðŸ‘€ Enter keywords and perform search
    await agent.aiAction('Navigate to ebay.com and search for "Headphones"');

    // ðŸ‘€ Wait for loading to complete
    await agent.aiWaitFor('At least one headphone product is displayed on the page');
    // Or you can use a simple sleep:
    // await sleep(5000);

    // ðŸ‘€ Understand page content and extract data
    const items = await agent.aiQuery(
      '{itemTitle: string, price: Number}[], find product titles and prices in the list',
    );
    console.log('Headphone product information', items);

    // ðŸ‘€ Use AI assertion
    await agent.aiAssert('Multiple headphone products are displayed on the interface');

    await page.destroy();
  })(),
);
```

## Step 3. Run

Use `tsx` to run the script

```bash
# run
npx tsx demo.ts
```

Shortly after, you will see output like this:

```log
[
 {
   itemTitle: 'AirPods Pro (2nd generation) with MagSafe Charging Case (USB-C)',
   price: 249
 },
 {
   itemTitle: 'Sony WH-1000XM4 Wireless Premium Noise Canceling Overhead Headphones',
   price: 278
 }
]
```

## Step 4. View execution report

When the above command executes successfully, it will output in the console: `Midscene - report file updated: /path/to/report/some_id.html`. Open this file in a browser to view the report.

## IOSDevice Constructor

The IOSDevice constructor supports the following parameters:

- `udid: string` - Device UDID or simulator identifier
- `opts?: IOSDeviceOpt` - Optional parameters for IOSDevice configuration
  - `wdaPort?: number` - Optional, WebDriverAgent port. Default is 8100.
  - `wdaHost?: string` - Optional, WebDriverAgent host. Default is 'localhost'.
  - `autoDismissKeyboard?: boolean` - Optional, whether to automatically dismiss keyboard after text input. Default is true.
  - `keyboardDismissStrategy?: 'done-first' | 'escape-first'` - Optional, strategy for dismissing keyboard. 'done-first' tries Done key first, then Escape if keyboard persists. 'escape-first' tries Escape key first, then Done if keyboard persists. Default is 'done-first'.
  - `customActions?: DeviceAction<any>[]` - Optional, list of custom device actions.

## Additional iOS Agent Interfaces

In addition to the common Agent interfaces in [API Reference](./api.mdx), IOSAgent provides some additional interfaces:

### `agent.launch()`

Launch an iOS application.

- Type

```typescript
function launch(bundleId: string): Promise<void>;
```

- Parameters:

  - `bundleId: string` - Bundle identifier of the iOS app to launch

- Return Value:

  - `Promise<void>`

- Example:

```typescript
import { IOSAgent, IOSDevice } from '@midscene/ios';

const page = new IOSDevice('00008120-001234567890123E');
const agent = new IOSAgent(page);

await agent.launch('com.apple.mobilesafari'); // Launch Safari
await agent.launch('com.apple.Preferences'); // Launch Settings app
await agent.launch('com.apple.camera'); // Launch Camera app
```

### `agentFromIOSDevice()`

Create an IOSAgent from a connected iOS device.

- Type

```typescript
function agentFromIOSDevice(
  udid?: string,
  opts?: PageAgentOpt,
): Promise<IOSAgent>;
```

- Parameters:

  - `udid?: string` - Optional, UDID of the iOS device to connect to. If not provided, uses the first connected device
  - `opts?: PageAgentOpt & IOSDeviceOpt` - Optional, configuration for initializing IOSAgent. PageAgentOpt refers to [Constructor](./api.mdx), IOSDeviceOpt configuration values refer to [IOSDevice Constructor](./integrate-with-ios#iosdevice-constructor)

- Return Value:

  - `Promise<IOSAgent>` Returns an IOSAgent instance

- Example:

```typescript
import { agentFromIOSDevice } from '@midscene/ios';

const agent = await agentFromIOSDevice('00008120-001234567890123E'); // Pass UDID
const agent = await agentFromIOSDevice(); // No UDID, uses first connected device
```

### `getConnectedDevices()`

Get all connected iOS devices and simulators.

- Type

```typescript
function getConnectedDevices(): Promise<Device[]>;
interface Device {
  /**
   * The device udid or simulator identifier.
   */
  udid: string;
  /**
   * Device name
   */
  name: string;
  /**
   * Device type: 'device' for real device, 'simulator' for simulator
   */
  type: 'device' | 'simulator';
}
```

- Return Value:

  - `Promise<Device[]>` Returns an array of Device objects

- Example:

```typescript
import { agentFromIOSDevice, getConnectedDevices } from '@midscene/ios';

const devices = await getConnectedDevices();
console.log(devices);
const agent = await agentFromIOSDevice(devices[0].udid);
```

## Extending Custom Interaction Actions

Using the `customActions` option combined with custom interaction actions defined by `defineAction`, you can extend the Agent's action space. These actions are appended after built-in actions, making them available for the Agent to call during planning.

```typescript
import { getMidsceneLocationSchema, z } from '@midscene/core';
import { defineAction } from '@midscene/core/device';
import { IOSAgent, IOSDevice } from '@midscene/ios';

const ContinuousClick = defineAction({
  name: 'continuousClick',
  description: 'Click the same target repeatedly',
  paramSchema: z.object({
    locate: getMidsceneLocationSchema(),
    count: z
      .number()
      .int()
      .positive()
      .describe('How many times to click'),
  }),
  async call(param) {
    const { locate, count } = param;
    console.log('click target center', locate.center);
    console.log('click count', count);
    // Implement custom click logic combining locate + count
  },
});

const page = new IOSDevice('your-device-udid');
const agent = new IOSAgent(page, {
  customActions: [ContinuousClick],
});

await agent.aiAction('Click the red button five times');
```

For more details about custom actions, refer to [Integrate with any interface](./integrate-with-any-interface).

## More

- For more Agent API interfaces, refer to [API Reference](./api.mdx).
- For more prompting tips, refer to [Prompting Tips](./prompting-tips)

## FAQ

### Why can't I control my device through WebDriverAgent even though it's connected?

Please check the following:

1. **Developer Mode**: Ensure it's enabled in Settings > Privacy & Security > Developer Mode
2. **UI Automation**: Ensure it's enabled in Settings > Developer > UI Automation
3. **Device Trust**: Ensure the device trusts the current Mac

### What are the differences between simulators and real devices?

| Feature | Real Device | Simulator |
|---------|-------------|-----------|
| Port Forwarding | Requires iproxy | Not required |
| Developer Mode | Must enable | Auto-enabled |
| UI Automation Settings | Must enable manually | Auto-enabled |
| Performance | Real device performance | Depends on Mac performance |
| Sensors | Real hardware | Simulated data |

### How to use custom WebDriverAgent port and host?

You can specify WebDriverAgent port and host through the IOSDevice constructor:

```typescript
const device = new IOSDevice('00008120-001234567890123E', {
  wdaPort: 8200,        // Custom port
  wdaHost: '192.168.1.100', // Custom host
});
```

For remote devices, you also need to set up port forwarding accordingly:

```bash
iproxy -u DEVICE_UDID 8200:8100
```

## iOS-Specific Actions

The iOS package includes iOS-specific actions that can be used in automation:

```typescript
// Press home button
await agent.callAction('IOSHomeButton');

// Open app switcher
await agent.callAction('IOSAppSwitcher');

// Long press with custom duration
await agent.callAction('IOSLongPress', {
  locate: 'menu item',
  duration: 2000, // 2 seconds
});
```

## Best Practices

### 1. Device Management

Always properly connect and destroy devices:

```typescript
try {
  await device.connect();
  // Your automation code here
} finally {
  await device.destroy();
}
```

### 2. Wait for UI Updates

iOS animations and transitions may need time to complete:

```typescript
await agent.aiTap('button');
await sleep(1000); // Wait for animation
await agent.aiAssert('new screen loaded');
```

### 3. Handle Keyboard Input

For better text input handling:

```typescript
await agent.aiInput('text', 'input field', {
  autoDismissKeyboard: true, // Automatically dismiss keyboard
});
```

### 4. Bundle Identifiers

Common iOS app bundle identifiers:

- Safari: `com.apple.mobilesafari`
- Settings: `com.apple.Preferences`
- Messages: `com.apple.MobileSMS`
- Camera: `com.apple.camera`
- Photos: `com.apple.mobileslideshow`

## Testing Integration

### Vitest Integration

```typescript title="test/ios.test.ts"
import { describe, it, beforeAll, afterAll } from 'vitest';
import { IOSDevice, IOSAgent, getConnectedDevices } from '@midscene/ios';

describe('iOS App Tests', () => {
  let device: IOSDevice;
  let agent: IOSAgent;

  beforeAll(async () => {
    const devices = await getConnectedDevices();
    device = new IOSDevice(devices[0].udid);
    agent = new IOSAgent(device);
    await device.connect();
  });

  afterAll(async () => {
    await device.destroy();
  });

  it('should launch Safari and navigate', async () => {
    await device.launch('com.apple.mobilesafari');
    await agent.aiAssert('Safari is open');
  });
});
```

## Troubleshooting

### WebDriverAgent Connection Issues

If you encounter WebDriverAgent connection issues:

1. **Check port forwarding**:
   ```bash
   lsof -i:8100  # Should show iproxy process
   ```

2. **Rebuild WebDriverAgent**:
   ```bash
   # The iOS package will automatically rebuild when needed
   ```

3. **Check device trust**:
   - Ensure your Mac is trusted on the iOS device
   - Check Developer Mode is enabled

### Common Errors

**"Device not found"**:
- Verify device is connected via USB
- Check UDID with `idevice_id -l`
- Ensure port forwarding is active

**"WebDriverAgent session failed"**:
- Restart port forwarding
- Check if WebDriverAgent is running on device
- Verify development team configuration

**"Element not found"**:
- Use more descriptive element descriptions
- Wait for UI animations to complete
- Check if element is visible on screen

## Next Steps

- Explore [API Reference](./api) for complete method documentation
- Check out [Prompting Tips](./prompting-tips) for better AI interactions
- Learn about [Model Configuration](./model-provider) for optimal performance