import SetupEnv from './common/setup-env.mdx';

# Command line tools

Use the Midscene command-line interface to install dependencies, execute YAML workflows, and review reports without writing a custom test harness. If you are looking for help authoring YAML files, see [Automate with scripts in YAML](./automate-with-scripts-in-yaml).

<SetupEnv />

## Manage configuration with `.env`

Place credentials or model configuration in a `.env` file that lives where you run the CLI. Midscene automatically loads this file whenever you invoke `midscene`.

```ini filename=.env
MIDSCENE_MODEL_BASE_URL="replace with your model service URL"
MIDSCENE_MODEL_API_KEY="replace with your API Key"
MIDSCENE_MODEL_NAME="replace with your model name"
MIDSCENE_MODEL_FAMILY="replace with your model family"
```

For more configuration details, please refer to [Model strategy](./model-strategy).

## Install the command-line tool

Install `@midscene/cli` globally:

```bash
npm i -g @midscene/cli
# Or install it within your project
npm i @midscene/cli --save-dev
```

## Run your first script

Create a file named `bing-search.yaml` to drive a web browser automation task:

```yaml
web:
  url: https://www.bing.com

tasks:
  - name: Search for weather
    flow:
      - ai: Search for "today's weather"
      - sleep: 3000
      - aiAssert: The results show weather information
```

Need to target Android instead? Connect your device via adb and use:

```yaml
android:
  # launch: https://www.bing.com
  deviceId: s4ey59

tasks:
  - name: Search for weather
    flow:
      - ai: Open the browser and navigate to bing.com
      - ai: Search for "today's weather"
      - sleep: 3000
      - aiAssert: The results show weather information
```

Or, to automate iOS with WebDriverAgent configured:

```yaml
ios:
  # launch: com.apple.mobilesafari
  wdaPort: 8100

tasks:
  - name: Search for weather
    flow:
      - ai: Open the browser and navigate to bing.com
      - ai: Search for "today's weather"
      - sleep: 3000
      - aiAssert: The results show weather information
```

Run the script:

```bash
midscene ./bing-search.yaml
# Or if you installed Midscene in your project
npx midscene ./bing-search.yaml
```

The CLI prints execution progress and writes a visual report when it finishes.

## Advanced usage of the command-line tool

`@midscene/cli` provides flexible ways to run your automation scripts.

### Run one or more scripts

You can pass a single `.yaml` script file or use a glob pattern to match multiple `.yaml` files to the `midscene` command. This is a shorthand for the `--files` argument.

```bash
# Run a single script
midscene ./bing-search.yaml

# Use a glob pattern to run all matching scripts
midscene './scripts/**/*.yaml'
```

### Command-line options

The command-line tool provides several options to control the execution behavior of your scripts.

- `--files <file1> <file2> ...`: Specifies a list of script files to execute. Files will be executed in the specified order, sequentially by default (when `--concurrent` is `1`), and can be executed concurrently by setting the `--concurrent` parameter. Supports glob patterns, following the syntax supported by [glob](https://www.npmjs.com/package/glob).
- `--concurrent <number>`: Sets the number of concurrent executions. Defaults to `1`.
- `--continue-on-error`: If this flag is set, it will continue to run the remaining scripts even if one fails. Defaults to off.
- `--share-browser-context`: Shares the same browser context (e.g., Cookies and `localStorage`) across all scripts. This is very useful for sequential tests that require a login state. Defaults to off.
- `--summary <filename>`: Specifies the path for the generated JSON format summary report file.
- `--headed`: Runs the script in a browser with a graphical user interface, rather than in headless mode.
- `--keep-window`: Keeps the browser window open after the script execution is complete. This option automatically enables `--headed` mode.
- `--config <filename>`: Specifies a configuration file. Parameters in the config file will be used as default values for the command-line arguments.
- `--web.userAgent <ua>`: Sets the browser UA, which will override the `web.userAgent` parameter in all script files.
- `--web.viewportWidth <width>`: Sets the browser viewport width, which will override the `web.viewportWidth` parameter in all script files.
- `--web.viewportHeight <height>`: Sets the browser viewport height, which will override the `web.viewportHeight` parameter in all script files.
- `--android.deviceId <device-id>`: Sets the Android device ID, which will override the `android.deviceId` parameter in all script files.
- `--ios.wdaPort <port>`: Sets the WebDriverAgent port, which will override the `ios.wdaPort` parameter in all script files.
- `--ios.wdaHost <host>`: Sets the WebDriverAgent host address, which will override the `ios.wdaHost` parameter in all script files.
- `--dotenv-debug`: Sets the debug log for dotenv, disabled by default.
- `--dotenv-override`: Sets whether dotenv overrides global environment variables with the same name, disabled by default.

Examples:

Use the `--files` argument to specify the file execution order.

```bash
midscene --files ./login.yaml ./buy/*.yaml ./checkout.yaml
```

Run all scripts with a concurrency of 4 and continue on any file error.

```bash
midscene --files './scripts/**/*.yaml' --concurrent 4 --continue-on-error
```

### Writing command-line arguments in a file

You can write a configuration file in YAML format and reference it with `--config`. When invoking the command-line tool, command-line arguments have higher priority than the configuration file.

```yaml
files:
  - './scripts/login.yaml'
  - './scripts/search.yaml'
  - './scripts/**/*.yaml'

concurrent: 4
continueOnError: true
shareBrowserContext: true
```

Usage:

```bash
midscene --config ./config.yaml
```

## More features

### Using environment variables in `.yaml` files

You can use environment variables in your `.yaml` files with the `${variable-name}` syntax.

For example, if you have a `.env` file with the following content:

```ini filename=.env
topic=weather today
```

You can use the environment variable in your `.yaml` file like this:

```yaml
#...
- ai: type ${topic} in input box
#...
```

### Running in headed mode

> `web` scenarios only

'Headed' mode means the browser window will be visible. By default, scripts run in headless mode.

To run in headed mode, you can use the `--headed` option. Additionally, if you want to keep the browser window open after the script finishes, you can use the `--keep-window` option. The `--keep-window` option automatically enables `--headed` mode.

Headed mode consumes more resources, so it is recommended to use it only locally.

```bash
# Run in headed mode
midscene /path/to/yaml --headed

# Run in headed mode and keep the browser window open afterward
midscene /path/to/yaml --keep-window
```

### Using bridge mode

> `web` scenarios only

By using bridge mode, you can leverage YAML scripts to automate your existing desktop browser. This is particularly useful for reusing cookies, plugins, and page states, or for interacting manually with automation scripts.

To use bridge mode, you first need to install the Chrome extension and then use the following configuration in the `target` section:

```diff
web:
  url: https://www.bing.com
+ bridgeMode: newTabWithUrl
```

Please refer to [Bridge Mode via Chrome Extension](./bridge-mode) for more details.

### Running YAML scripts with JavaScript

You can also run a YAML script using JavaScript by calling the [`runYaml`](./api.html#runyaml) method on the Agent. Note that this method will only execute the `tasks` part of the YAML script.

### Analyzing command-line tool results

After execution is complete, the following files will be generated in the output directory:

- The file path specified by the `--summary` option (defaults to `index.json`), containing the execution status and statistics of all files.
- The individual execution results of each YAML file (in JSON format).
- The visual reports for each file (in HTML format).

## Configure dotenv's default behavior

Midscene uses [`dotenv`](https://github.com/motdotla/dotenv) to load environment variables from a `.env` file.

### Disable dotenv's debug logs

By default, Midscene prints debug information from dotenv. If you don't want to see this information, you can use the `--dotenv-debug` option to disable it.

```bash
midscene /path/to/yaml --dotenv-debug=false
```

### Use .env to override global environment variables

By default, `dotenv` will not override global environment variables with the same name found in the `.env` file. If you want to override them, you can use the `--dotenv-override` option.

```bash
midscene /path/to/yaml --dotenv-override=true
```

## FAQ

**How can I get cookies in JSON format from Chrome?**

You can use this [Chrome extension](https://chromewebstore.google.com/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc) to export cookies in JSON format.

**How can I open the debug log for dotenv?**

Midscene uses `dotenv` to load environment variables from a `.env` file. You can use the `--dotenv-debug` option to open the debug log for dotenv.

```bash
midscene /path/to/yaml --dotenv-debug=true
```

## More

You might also be interested in [Prompting Tips](./prompting-tips).
